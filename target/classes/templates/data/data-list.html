<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<meta charset="utf-8">
<!--字体图标-->
<link href="../../javaex/pc/css/icomoon.css" rel="stylesheet" />
<!--动画-->
<link href="../../javaex/pc/css/animate.css" rel="stylesheet" />
<!--骨架样式-->
<link href="../../javaex/pc/css/common.css" rel="stylesheet" />
<!--皮肤（缇娜）-->
<link href="../../javaex/pc/css/skin/tina.css" rel="stylesheet" />
<!--jquery，不可修改版本-->
<script src="../../javaex/pc/lib/jquery-1.7.2.min.js"></script>
<!--全局动态修改-->
<script src="../../javaex/pc/js/common.js"></script>
<!--核心组件-->
<script src="../../javaex/pc/js/javaex.min.js"></script>
<!--表单验证-->
<script src="../../javaex/pc/js/javaex-formVerify.js"></script>
<title>设备管理</title>
<style>
           /*  .black_overlay {
                display: none;
                position: absolute;
                top: 0%;
                left: 0%;
                width: 100%;
                height: 100%;
                background-color: black;
                z-index: 1001;
                -moz-opacity: 0.8;
                opacity: .80;
                filter: alpha(opacity=80);
            } */

            .white_content {
                display: none;
                position: absolute;
                top: 10%;
                left: 10%;
                width: 40%;
                height: 40%;
                border: 1px solid lightblue;
                background-color: white;
                z-index: 1002;
                overflow: auto;
            }

            .white_content_small {
                display: none;
                position: absolute;
                top: 20%;
                left: 30%;
                width: 40%;
                height: 50%;
                border: 16px solid lightblue;
                background-color: white;
                z-index: 1002;
                overflow: auto;
            }
        </style>
</head>

<body>
    <!--主体内容-->
<div class="list-content">
	<!--块元素-->
	<div class="block">
		<!--页面有多个表格时，可以用于标识表格-->
		<h2>设备列表</h2>
		<!--右上角的返回按钮-->
		<a href="javascript:history.back();">
			<button class="button indigo radius-3" style="position: absolute;right: 20px;top: 16px;"><span class="icon-arrow_back"></span> 返回</button>
		</a>
		
		<!--正文内容-->
		<div class="main">
			<!--表格上方的搜索操作-->
			<div class="admin-search">
				<div class="input-group">
					<input id="keyword" type="text" class="text" placeholder="提示信息" />
					<button id="searchBtn" class="button blue" onclick="search();">搜索</button>
				</div>
			</div>
			
			<!--表格上方的操作元素，添加、删除等-->
			<table id="table" class="table color2">
				<thead>
					<tr align="center">
						<th>序号</th>
						<th>设备名称</th>
						<th>经度</th>
						<th>纬度</th>
						<th>速度</th>
						<th>方向</th>
						<th>海拔</th>
						<th>卫星数量</th>
						<th>定位状态</th>
						<th>采集时间</th>
						<th>机器状态</th>
						<th>外部电压</th>
						<th>操作</th>
					</tr>
				</thead>
				<tbody id="tbody">
					<!--<tr>-->
						<!--<td class="checkbox"><input type="checkbox" class="fill listen-1-2" /> </td>-->
						<!--<td>1</td>-->
						<!--<td><button class="button blue">编辑</button><button class="button red">删除</button></td>-->
					<!--</tr>-->
				</tbody>
            </table>
            
            <div class="page">
                <ul id="page" class="pagination"></ul>
            </div>
		</div>
    </div>
</div>

<script type="text/javascript">
var user;
var identity;
    // 页面一加载, 展示数据列表, 每页10条
    $(document).ready(function(){
    	 $.get("/user/currUser", function(data){
             var code = data.code;
              user = data.data;
             if (code == 200) {
            	 identity=user.identity;
             	console.log(user)
             	rander(1,"",10);
 			}
             return false;
         });
      
    });

    // 渲染数据表格
	function rander(currPage,keyword,pageSize) {
    	var jsondata;
		if(identity==0){//超级管理员
			jsondata=JSON.stringify({"currPage":currPage,"keyword": keyword,"pageSize": pageSize})
    	  }else if(identity==1){//厂商
    		  jsondata=JSON.stringify({"currPage":currPage,"keyword": keyword,"pageSize": pageSize,"factoryid":user.factoryid})
    	  }else if(identity==2){//经销商 */
    		  jsondata=JSON.stringify({"currPage":currPage,"keyword": keyword,"pageSize": pageSize,"brokerid":user.brokerid})
    	  }
        // 定义全局 分页属性
        $.ajax({
            //请求方式
            type : "POST",
            //请求的媒体类型
            contentType: "application/json;charset=UTF-8",
            //请求地址
            url : "/datainfo/list",
            //数据，json字符串
            data : jsondata,
            //请求成功
            success : function(result) {
                console.log(result);
                // 获取集合属性
                var r = result.data;
                var total = r.total;
                var currPage = r.currPage;
                var pageSize = r.pageSize;
                // 分页信息
                console.log("currPage:"+r.currPage+"\t pageSize:"+r.pageSize+"\t total:"+r.total);

                var array = r.list;
                var text = "";
                $.each(array,function(index,value){
                	
          			var longitudeflag = value.longitudeflag;
          			var longitude = value.longitude;
          			var latitudeflag = value.latitudeflag;
          			var latitude = value.latitude;
          			var direction =value.direction; 
          			var islocation = value.islocation;
          			var gettime = dateFormat("YYYY-mm-dd HH:MM:SS", new Date(value.gettime));
          			
          			var macstate = value.macstate;
          			//东西经
          			var longitudeword;
          			if(longitudeflag==0){
          				longitudeword="东经";
          			}else{
          				longitudeword="西经";
          			}
          			
          			//南北纬
          			var latitudeword;
          			if(latitudeflag==0){
          				latitudeword="南纬";
          			}else{
          				latitudeword="北纬";
          			}
          			console.log(islocation)
          			//定位状态 
          			var islocationword;
          			if(islocation==0){
          				islocationword="未定位";
          			}else if(islocation==1){
          				islocationword="单点定位";
          			}else if(islocation==2){
          				islocationword="差分定位";
          			}else if(islocation==3){
          				islocationword="固定解 ";
          			}else if(islocation==4){
          				islocationword="浮点解";
          			}
          			console.log(islocationword)
          			//机器状态
          			var macstateword;
          			if(macstate==0){
          				macstateword="打火静止";
          			}else if(macstate==1){
          				macstateword="打火工作";
          			}else if(macstate==2){
          				macstateword="熄火静止";
          			}else if(macstate==3){
          				macstateword="熄火移动";
          			}
                   var num = pageSize * (currPage - 1) + index + 1;
                    text+= "<tr align='center'><td>"+value.id+"</td><td>"+value.devicename+"</td><td>"+longitudeword+longitude+"</td><td>"+latitudeword+latitude+"</td><td>"+value.speed+"</td><td>"+value.direction+"</td><td>"+value.height+"</td><td>"+value.satellite+"</td><td>"+islocationword+"</td><td>"+gettime+"</td><td>"+macstateword+"</td><td>"+value.outsideU+"</td>";
                    text+= "<td>&nbsp;<button class='button yellow empty' onclick='deldata("+value.id+")'>删除</button></td></tr>";
                });

                $("#tbody").html(text);

                // 向上取整去总页数
                var totalPage = Math.ceil(total/pageSize);
                console.log("totalPage:"+totalPage);
                // 清空分页组件
                $("#page").empty();
                // 调用分页组件
                javaex.page({
                    id : "page",
                    pageCount : totalPage,	// 总页数
                    currentPage : currPage,// 默认选中第几页
                    perPageCount : pageSize ,	// 每页显示多少条，不填时，不显示该条数选择控件
                    isShowJumpPage : false,	// 是否显示跳页
                    totalNum : total,		// 总条数，不填时，不显示
                    position : "center",
                    callback : function(rtn) {
                        // 翻页
                        rander(rtn.pageNum,keyword,rtn.perPageCount);
                    }
                });
            },
            //请求失败，包含具体的错误信息
            error : function(e){
                console.log(e.status);
                console.log(e.responseText);
            }
        });
    }

    // 搜索
    function search() {
        // 获取搜索关键字
        var keyword = $("#keyword").val();
        // 搜索结果渲染表格
        rander(1,keyword,10);
    }

    // 删除
    function deldata(id) {
        console.log("delete Device"+id);
        javaex.confirm({
            content : "确定要删除么",
            callback : "delCallback("+id+")"
        });
    }

    function delCallback(id) {
		// ajax
        $.get("/datainfo/delete",{"id": id},
            function(data){
                var code = data.code;
                if (code == 200) {
                    javaex.message({
                        content : "删除成功",
                        type : "success"
                    });

                    // 删除成功, 刷新页面
                    setTimeout(function(){ window.location.reload();},1500)
				}
            });
		
        // 如果你想阻止弹出层关闭，直接 return false; 即可
        //return false;
    }
    
    function dateFormat(fmt, date) {
	    let ret;
	    const opt = {
	        "Y+": date.getFullYear().toString(),        // 年
	        "m+": (date.getMonth() + 1).toString(),     // 月
	        "d+": date.getDate().toString(),            // 日
	        "H+": date.getHours().toString(),           // 时
	        "M+": date.getMinutes().toString(),         // 分
	        "S+": date.getSeconds().toString()          // 秒
	        // 有其他格式化字符需求可以继续添加，必须转化成字符串
	    };
	    for (let k in opt) {
	        ret = new RegExp("(" + k + ")").exec(fmt);
	        if (ret) {
	            fmt = fmt.replace(ret[1], (ret[1].length == 1) ? (opt[k]) : (opt[k].padStart(ret[1].length, "0")))
	        };
	    };
	    return fmt;
	}
    
</script>
</body>
</html>