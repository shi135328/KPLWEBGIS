<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<meta charset="utf-8">
<!--字体图标-->
<link href="../../javaex/pc/css/icomoon.css" rel="stylesheet" />
<!--动画-->
<link href="../../javaex/pc/css/animate.css" rel="stylesheet" />
<!--骨架样式-->
<link href="../../javaex/pc/css/common.css" rel="stylesheet" />
<!--皮肤（缇娜）-->
<link href="../../javaex/pc/css/skin/tina.css" rel="stylesheet" />
<!--jquery，不可修改版本-->
<script src="../../javaex/pc/lib/jquery-1.7.2.min.js"></script>
<!--全局动态修改-->
<script src="../../javaex/pc/js/common.js"></script>
<!--核心组件-->
<script src="../../javaex/pc/js/javaex.min.js"></script>
<!--表单验证-->
<script src="../../javaex/pc/js/javaex-formVerify.js"></script>
<title>设备管理</title>
</head>
<style>
    
</style>

<body>
    <!--全部主体内容-->
<div class="list-content">
	<!--块元素-->
	<div class="block">
		<!--修饰块元素名称-->
		<div class="banner">
			<p class="tab fixed">添加设备</p>
		</div>
	
		<!--正文内容-->
		<div class="main">
			<form>
				<!--文本框-->
				<div class="unit clear">
					<div class="left"><span class="required">*</span><p class="subtitle">设备名</p></div>
					<div class="right">
						<input type="text" id="deviceName" class="text" placeholder="请输入设备名称" />
					</div>
				</div>
				<!--文本框-->
				<div class="unit clear">
					<div class="left"><span class="required">*</span><p class="subtitle">设备MAC</p></div>
					<div class="right">
						<input type="text" id="devicecode" class="text" placeholder="请输入32位设备MAC" />
					</div>
				</div>
				<!--下拉选择框-->
				<div class="unit clear">
					<div class="left"><p class="subtitle">所属厂商</p></div>
					<div class="right">
						<select id="selectfactory">
							
						</select>
					</div>
				</div>
				<!--下拉选择框-->
				<div class="unit clear">
					<div class="left"><p class="subtitle">所属经销商</p></div>
					<div class="right">
						<select id="selectbroker">
							
						</select>
					</div>
				</div>
				<div class="unit clear">
					<div class="left"><p class="subtitle">所属用户</p></div>
					<div class="right">
						<select id="selectcustom">
							
						</select>
					</div>
				</div>
				<!--提交按钮-->
				<div class="unit clear" style="width: 800px;">
					<div style="text-align: center;">
						<!--表单提交时，必须是input元素，并指定type类型为button，否则ajax提交时，会返回error回调函数-->
						<input type="button" id="return" class="button no" value="返回" />
						<input type="button" id="save" class="button yes" value="保存" />
					</div>
				</div>
			</form>

		</div>
	</div>
</div>

<script type="text/javascript">
	// 监听点击保存按钮事件
	$("#save").click(function() {
		// 获取输入内容
		var deviceName = $("#deviceName").val();
		var devicecode = $("#devicecode").val();
		 var factoryid = $('#selectfactory option:selected').val();// 厂商
		 var brokerid = $('#selectbroker option:selected').val();// 经销商
		 var customid = $('#selectcustom option:selected').val();// 经销商
        // 校验文本
		if (deviceName == "") {
            javaex.optTip({
                content : "设备名称不能为空!",
                type : "error"
            });

            return false;
		}
		 console.log(devicecode.length)
		if (devicecode.length != 30) {
            javaex.optTip({
                content : "设备MAC不标准!",
                type : "error"
            });

            return false;
		}
        // 表单数据
        var json = {"devicename":deviceName,"devicecode":devicecode,"factoryid":factoryid,"brokerid":brokerid,"customid":customid};

        // 提交
        // ajax 示例
        $.ajax({
            //请求方式
            type : "POST",
            //请求的媒体类型
            contentType: "application/json;charset=UTF-8",
            //请求地址
            url : "/deviceinfo/add",
            //数据，json字符串
            data : JSON.stringify(json),
            //请求成功
            success : function(result) {
                console.log(result);
                // 获取集合属性
                var data = result.data;
                var code = result.code;

                if (code == 200) {
                    javaex.message({
                        content : "添加成功",
                        type : "success"
                    });
                    // 跳转至列表
                    setTimeout(function(){ window.location.href="/device/device-list";},1500)
				}

            },
            //请求失败，包含具体的错误信息
            error : function(e){
                console.log(e.status);
                console.log(e.responseText);
            }
        });

	});

	// 监听点击返回按钮事件
	$("#return").click(function() {
		 window.location.href = "/device/device-list";
	});
	
	 $(document).ready(function(){
	        // 页面一加载, 读取登录用户信息
	        // get读取参数
	        $.get("/user/currUser", function(data){
	            var code = data.code;
	            var user = data.data;
	            if (code == 200) {
	            	console.log(user)
	                // 设置用户昵称
	               // $("#username").text(user.username);
	            	if(user.identity==0){//超级管理员
	            		 $.post("/factoryinfo/getfactoryinfo", function(data){
	         	            var factoryinfo = data.factoryinfo;
	         	            	console.log(factoryinfo)
	         	                // 设置用户昵称
	         	               // $("#username").text(user.username);
	         	            	for(var i=0;i<factoryinfo.length;i++){
	         	            		 $("#selectfactory").append( "<option value="+factoryinfo[i].id+">"+factoryinfo[i].factoryname+"</option>" );
	         	            	}
	         	            	 javaex.select({
	               	           		id : "selectfactory",
	               	           		isSearch : false
	               	           	});
	         	            	$.get("/brokerinfo/listbyfactory",{"factoryid":factoryinfo[0].id}, function(data){
       	         	            	var brokerinfo=data.brokerinfo;
       	         	            	$("#selectbroker").append( "<option value=''>不选择</option>");
       	         	            	for(var i=0;i<brokerinfo.length;i++){
    	         	            		 $("#selectbroker").append( "<option value="+brokerinfo[i].id+">"+brokerinfo[i].brokername+"</option>" );
    	         	            	}
	       	         	            javaex.select({
		               	           		id : "selectbroker",
		               	           		isSearch : false
		               	           	});
	       	         	        	changgebroker();
       	         	      		  });
	         	            	$("#selectcustom").append( "<option value=''>不选择</option>");
	         	            	javaex.select({
	               	           		id : "selectcustom",
	               	           		isSearch : false
	               	           	});
	         	            	//厂商切换时下拉经销商
	         	            	 $("#ul-selectfactory option").click(function(){
	         	            		$("#selectbroker").empty();
	    	           					$.get("/brokerinfo/listbyfactory",{"factoryid":$('#selectfactory option:selected').val()}, function(data){
	    	       	         	            	console.log(data.brokerinfo)
	    	       	         	            	var brokerinfo=data.brokerinfo;
	    	       	         	            	$("#selectbroker").append( "<option value=''>不选择</option>");
	    	       	         	            	for(var i=0;i<brokerinfo.length;i++){
		        	         	            		 $("#selectbroker").append( "<option value="+brokerinfo[i].id+">"+brokerinfo[i].brokername+"</option>" );
		        	         	            	}
	    	       	         	            javaex.select({
		    	               	           		id : "selectbroker",
		    	               	           		isSearch : false
		    	               	           	});
	    	       	         	      //经销商切换时下拉用户
	    		         	            	changgebroker()
	    	       	         	        });
	    	           					
	               				}) 
	               				 
	         	        });
	            	
	            	}else if(user.identity==1){//厂商
	            	        $.get("/factoryinfo/getfactoryinfobyid",{"id": user.factoryid},
	            	                function(data){
	            	        			 $("#selectfactory").append( "<option value="+data.factoryinfo.id+">"+data.factoryinfo.factoryname+"</option>" );
         	            	 		javaex.select({
      	       	           				id : "selectfactory",
      	       	           				isSearch : false
      	       	           			});
	            	                });
	            	        $.get("/brokerinfo/listbyfactory",{"factoryid":user.factoryid}, function(data){
   	         	            	var brokerinfo=data.brokerinfo;
   	         	            	$("#selectbroker").append( "<option value=''>不选择</option>");
   	         	            	for(var i=0;i<brokerinfo.length;i++){
	         	            		 $("#selectbroker").append( "<option value="+brokerinfo[i].id+">"+brokerinfo[i].brokername+"</option>" );
	         	            	}
       	         	            javaex.select({
	               	           		id : "selectbroker",
	               	           		isSearch : false
	               	           	});
       	         	        	changgebroker();
	   	         	           	$("#selectcustom").append( "<option value=''>不选择</option>");
	         	            	javaex.select({
	               	           		id : "selectcustom",
	               	           		isSearch : false
	               	           	});
   	         	      		 });
	            	}else if(user.identity==2){//经销商
            	        $.get("/factoryinfo/getfactoryinfobyid",{"id": user.factoryid},
            	                function(data){
            	        			 $("#selectfactory").append( "<option value="+data.factoryinfo.id+">"+data.factoryinfo.factoryname+"</option>" );
     	            	 		javaex.select({
  	       	           				id : "selectfactory",
  	       	           				isSearch : false
  	       	           			});
            	                });
            	        $.get("/brokerinfo/getbrokerinfobyid",{"id":user.brokerid}, function(data){
	         	            	var brokerinfo=data.brokerinfo;
	         	          		console.log(brokerinfo)
         	            		 $("#selectbroker").append( "<option value="+brokerinfo.id+">"+brokerinfo.brokername+"</option>" );
   	         	            javaex.select({
               	           		id : "selectbroker",
               	           		isSearch : false
               	           	});
		   	         	        $.get("/custominfo/listbybroker",{"brokerid":$('#selectbroker option:selected').val()}, function(data){
		         	            	var custominfo=data.custominfo;
		         	          		console.log(custominfo)
		         	            	$("#selectcustom").append( "<option value=''>不选择</option>");
		         	            	for(var i=0;i<custominfo.length;i++){
		         	            	console.log(custominfo[i].customname)
		     	            		 $("#selectcustom").append( "<option value="+custominfo[i].id+">"+custominfo[i].customname+"</option>" );
		     	            	}
			         	            javaex.select({
		           	           		id : "selectcustom",
		           	           		isSearch : false
		           	           		});
		         	      		});
	         	        });
            	       
            	        
            	}else if(user.identity==3){//用户
        	        $.get("/factoryinfo/getfactoryinfobyid",{"id": user.factoryid},
        	                function(data){
        	        			 $("#selectfactory").append( "<option value="+data.factoryinfo.id+">"+data.factoryinfo.factoryname+"</option>" );
 	            	 		javaex.select({
	       	           				id : "selectfactory",
	       	           				isSearch : false
	       	           			});
        	                });
        	        $.get("/brokerinfo/getbrokerinfobyid",{"id":user.brokerid}, function(data){
         	            	var brokerinfo=data.brokerinfo;
     	            		 $("#selectbroker").append( "<option value="+brokerinfo.id+">"+brokerinfo.brokername+"</option>" );
	         	            javaex.select({
           	           		id : "selectbroker",
           	           		isSearch : false
           	           	});
         	        });
        	        $.get("/custominfo/getcustominfobyid",{"id":user.customid}, function(data){
     	            	var custominfo=data.custominfo;
 	            		 $("#selectcustom").append( "<option value="+custominfo.id+">"+custominfo.customname+"</option>" );
         	            javaex.select({
       	           		id : "selectcustom",
       	           		isSearch : false
       	           	});
     	        });
        	        
        	}
	            	
				}

	            return false;
	        });
	    });
	 function changgebroker(){
		 //经销商切换时下拉用户
     	 $("#ul-selectbroker option").click(function(){
     		$("#selectcustom").empty();
     		 if($('#selectbroker option:selected').val()==""){
     				$("#selectcustom").append( "<option value=''>不选择</option>");
     				javaex.select({
	   	           		id : "selectcustom",
	   	           		isSearch : false
   	           		});
     		 }else{
					$.get("/custominfo/listbybroker",{"brokerid":$('#selectbroker option:selected').val()}, function(data){
    	            	console.log(data.custominfo)
    	            	var custominfo=data.custominfo;
    	            	$("#selectcustom").append( "<option value=''>不选择</option>");
    	            	for(var i=0;i<custominfo.length;i++){
 	            		 $("#selectcustom").append( "<option value="+custominfo[i].id+">"+custominfo[i].customname+"</option>" );
 	            	}
    	            javaex.select({
	   	           		id : "selectcustom",
	   	           		isSearch : false
   	           		});
    	        });
     		 }
			}) 
	 }
</script>
</body>
</html>