/*
 COPYRIGHT 2009 ESRI

 TRADE SECRETS: ESRI PROPRIETARY AND CONFIDENTIAL
 Unpublished material - all rights reserved under the
 Copyright Laws of the United States and applicable international
 laws, treaties, and conventions.

 For additional information, contact:
 Environmental Systems Research Institute, Inc.
 Attn: Contracts and Legal Services Department
 380 New York Street
 Redlands, California, 92373
 USA

 email: contracts@esri.com
 */
//>>built
require({cache:{"esri/layers/FeatureEditResult":function(){define(["dojo/_base/declare","dojo/_base/lang","dojo/has","esri/kernel"],function(m,e,q,l){m=m(null,{declaredClass:"esri.layers.FeatureEditResult",constructor:function(l){l&&e.isObject(l)&&(this.objectId=l.objectId,this.success=l.success,l.success||(l=l.error,this.error=Error(),this.error.code=l.code,this.error.message=l.description))}});q("extend-esri")&&e.setObject("layers.FeatureEditResult",m,l);return m})},"esri/layers/MapImageLayer":function(){define("dojo/_base/declare dojo/_base/connect dojo/_base/lang dojo/_base/array dojo/dom-construct dojo/dom-style esri/kernel esri/config esri/sniff esri/domUtils esri/geometry/Point esri/geometry/webMercatorUtils esri/layers/layer".split(" "),
function(m,e,q,l,s,n,p,r,k,g,h,d,f){var b=m([f],{declaredClass:"esri.layers.MapImageLayer","-chains-":{constructor:"manual"},constructor:function(a){this.inherited(arguments,[null,a]);this._mapImages=[];var c=q.hitch;this._panStart=c(this,this._panStart);this._pan=c(this,this._pan);this._extentChange=c(this,this._extentChange);this._zoom=c(this,this._zoom);this._zoomStart=c(this,this._zoomStart);this._scale=c(this,this._scale);this._resize=c(this,this._resize);e.connect(this,"onSuspend",this,this._onSuspend);
e.connect(this,"onResume",this,this._onResume);this.loaded=!0;this.onLoad(this)},opacity:1,_transform:p._getDOMAccessor("transform"),addImage:function(a){var c=this._mapImages.push(a),c=c-1;a._idx=c;a._layer=this;this._div&&this._createImage(a,c)},removeImage:function(a){if(a){var c=a._idx,b=this._mapImages;if(b[c]===a){delete b[c];if(c=a._node)this._clearEvents(c),c.e_idx=c.e_bl=c.e_tr=c.e_l=c.e_t=c.e_w=c.e_h=null,c.parentNode&&(c.parentNode.removeChild(c),s.destroy(c));a._node=a._idx=a._layer=null}}},
removeAllImages:function(){var a=this._mapImages,c,b=a.length;for(c=0;c<b;c++){var d=a[c];d&&this.removeImage(d)}this._mapImages=[]},getImages:function(){var a=this._mapImages,c=[],b,d=a.length;for(b=0;b<d;b++)a[b]&&c.push(a[b]);return c},setOpacity:function(a){this.opacity!=a&&(this._opacityChanged(this.opacity=a),this.onOpacityChange())},onOpacityChange:function(){},_opacityChanged:function(a){var c=this._div,b,d;if(c)if(!k("ie")||8<k("ie"))n.set(c,"opacity",a);else{d=c.childNodes;b=d.length;for(c=
0;c<b;c++)n.set(d[c],"opacity",a)}},_createImage:function(a,c){var d=s.create("img");n.set(d,{position:"absolute"});8>=k("ie")&&n.set(d,"opacity",this.opacity);if(a.rotation){var f="rotate("+(360-a.rotation)+"deg)";9>k("ie")||(n.set(d,this._transform,f),n.set(d,"transform",f))}a._node=d;d.e_idx=c;d.e_layer=this;d.e_load=e.connect(d,"onload",b.prototype._imageLoaded);d.e_error=e.connect(d,"onerror",b.prototype._imageError);d.e_abort=e.connect(d,"onabort",b.prototype._imageError);d.src=a.href},_imageLoaded:function(a,
c){var b=c||a.target||a.currentTarget,d=b.e_layer,f=d._mapImages[b.e_idx],h=d._map;h&&(h.__zooming||h.__panning||!d._sr)?d._standby.push(b):(d._clearEvents(b),f&&f._node===b&&h&&d._attach(f))},_imageError:function(a){a=a.target||a.currentTarget;var c=a.e_layer,b=c._mapImages[a.e_idx];c._clearEvents(a);b&&(b._node=null)},_clearEvents:function(a){var c=e.disconnect;c(a.e_load);c(a.e_error);c(a.e_abort);a.e_load=a.e_error=a.e_abort=a.e_layer=null},_attach:function(a){var c=a.extent,b=c.spatialReference,
f=this._sr,k=this._div,p=a._node,g=new h({x:c.xmin,y:c.ymin,spatialReference:b}),c=new h({x:c.xmax,y:c.ymax,spatialReference:b});f.equals(b)||(f.isWebMercator()&&4326===b.wkid?(g=d.geographicToWebMercator(g),c=d.geographicToWebMercator(c)):b.isWebMercator()&&4326===f.wkid&&(g=d.webMercatorToGeographic(g),c=d.webMercatorToGeographic(c)));p.e_bl=g;p.e_tr=c;a.visible&&(this._setPos(p,k._left,k._top),(this._active||k).appendChild(p))},_setPos:function(a,c,b){var d=a.e_bl,f=a.e_tr,h=this._map,d=h.toScreen(d),
f=h.toScreen(f);c=d.x-c;b=f.y-b;var k=Math.abs(f.x-d.x),d=Math.abs(d.y-f.y),f={width:k+"px",height:d+"px"},g=this._mapImages[a.e_idx];"css-transforms"===h.navigationMode?f[p._css.names.transform]=p._css.translate(c,b)+(g.rotation?" "+p._css.rotate(360-g.rotation):""):(f.left=c+"px",f.top=b+"px");n.set(a,f);a.e_l=c;a.e_t=b;a.e_w=k;a.e_h=d},managedSuspension:!0,_setMap:function(a,c){this.inherited(arguments);var b=this._div=s.create("div",null,c),d=p._css.names,f={position:"absolute"},h=a.__visibleDelta;
if(!k("ie")||8<k("ie"))f.opacity=this.opacity;"css-transforms"===a.navigationMode?(f[d.transform]=p._css.translate(h.x,h.y),n.set(b,f),b._left=h.x,b._top=h.y,f={position:"absolute",width:a.width+"px",height:a.height+"px",overflow:"visible"},this._active=s.create("div",null,b),n.set(this._active,f),this._passive=s.create("div",null,b),n.set(this._passive,f)):(b._left=0,b._top=0,n.set(b,f));this._standby=[];d=this._mapImages;h=d.length;for(f=0;f<h;f++){var e=d[f];e._node||this._createImage(e,e._idx)}g.hide(b);
return b},_unsetMap:function(a,c){this._disconnect();var b=this._div;if(b){var d=this._mapImages,f,h=d.length;for(f=0;f<h;f++){var k=d[f];if(k){var g=k._node;g&&(this._clearEvents(g),g.e_idx=g.e_bl=g.e_tr=g.e_l=g.e_t=g.e_w=g.e_h=null);k._node=null}}c.removeChild(b);s.destroy(b)}this._map=this._div=this._sr=this._active=this._passive=this._standby=null;this.inherited(arguments)},_onSuspend:function(){this._disconnect();g.hide(this._div)},_onResume:function(a){a.firstOccurrence&&(this._sr=this._map.spatialReference,
this._processStandbyList());a=this._map;var c=this._div,b=a.__visibleDelta;"css-transforms"===a.navigationMode&&(c._left=b.x,c._top=b.y,n.set(c,p._css.names.transform,p._css.translate(c._left,c._top)));this._redraw("css-transforms"===a.navigationMode);this._connect(a);g.show(c)},_connect:function(a){if(!this._connections){var c=e.connect,b="css-transforms"===a.navigationMode;this._connections=[c(a,"onPanStart",this._panStart),c(a,"onPan",this._pan),c(a,"onExtentChange",this._extentChange),b&&c(a,
"onZoomStart",this._zoomStart),b?c(a,"onScale",this._scale):c(a,"onZoom",this._zoom),b&&c(a,"onResize",this._resize)]}},_disconnect:function(){this._connections&&(l.forEach(this._connections,e.disconnect),this._connections=null)},_panStart:function(){this._panL=this._div._left;this._panT=this._div._top},_pan:function(a,c){var b=this._div;b._left=this._panL+c.x;b._top=this._panT+c.y;"css-transforms"===this._map.navigationMode?n.set(b,p._css.names.transform,p._css.translate(b._left,b._top)):n.set(b,
{left:b._left+"px",top:b._top+"px"})},_extentChange:function(a,c,b){b?this._redraw("css-transforms"===this._map.navigationMode):c&&this._pan(a,c);this._processStandbyList()},_processStandbyList:function(){var a,c=this._standby;if(c&&c.length)for(a=c.length-1;0<=a;a--)this._imageLoaded(null,c[a]),c.splice(a,1)},_redraw:function(a){if(a){a=this._passive;var c=p._css.names;n.set(a,c.transition,"none");this._moveImages(a,this._active);n.set(a,c.transform,"none")}a=this._active||this._div;var c=this._div._left,
b=this._div._top,d,f=a.childNodes.length,h;for(d=0;d<f;d++)h=a.childNodes[d],this._setPos(h,c,b)},_zoom:function(a,c,b){a=this._div;var d=a._left,f=a._top,h,k=a.childNodes.length,g;for(h=0;h<k;h++){g=a.childNodes[h];var p=g.e_w*c,e=g.e_h*c,w=(b.x-d-g.e_l)*(p-g.e_w)/g.e_w,l=(b.y-f-g.e_t)*(e-g.e_h)/g.e_h,w=isNaN(w)?0:w,l=isNaN(l)?0:l;n.set(g,{left:g.e_l-w+"px",top:g.e_t-l+"px",width:p+"px",height:e+"px"})}},_zoomStart:function(){this._moveImages(this._active,this._passive)},_moveImages:function(a,c){var b=
a.childNodes,d;d=b.length;if(0<d)for(d-=1;0<=d;d--)c.appendChild(b[d])},_scale:function(a,c){var b=p._css.names,d=this._passive;n.set(d,b.transition,c?"none":b.transformName+" "+r.defaults.map.zoomDuration+"ms ease");p._css.matrix(a);n.set(d,b.transform,p._css.matrix(a))},_resize:function(a,c,b){n.set(this._active,{width:c+"px",height:b+"px"});n.set(this._passive,{width:c+"px",height:b+"px"})}});k("extend-esri")&&q.setObject("layers.MapImageLayer",b,p);return b})},"esri/layers/WebTiledLayer":function(){define("dojo/_base/declare dojo/_base/lang dojo/_base/array dojo/_base/url dojo/has dojo/string esri/kernel esri/urlUtils esri/SpatialReference esri/geometry/Extent esri/layers/TiledMapServiceLayer esri/layers/TileInfo".split(" "),
function(m,e,q,l,s,n,p,r,k,g,h,d){m=m(h,{declaredClass:"esri.layers.WebTiledLayer",constructor:function(f,b){b||(b={});this.urlTemplate=f;var a=new g(-2.0037508342787E7,-2.003750834278E7,2.003750834278E7,2.0037508342787E7,new k({wkid:102100})),c=new g(-2.0037508342787E7,-2.003750834278E7,2.003750834278E7,2.0037508342787E7,new k({wkid:102100}));this.initialExtent=b.initialExtent||a;this.fullExtent=b.fullExtent||c;this.tileInfo=b.tileInfo?b.tileInfo:new d({rows:256,cols:256,origin:{x:-2.0037508342787E7,
y:2.0037508342787E7},spatialReference:{wkid:102100},lods:[{level:0,resolution:156543.033928,scale:5.91657527591555E8},{level:1,resolution:78271.5169639999,scale:2.95828763795777E8},{level:2,resolution:39135.7584820001,scale:1.47914381897889E8},{level:3,resolution:19567.8792409999,scale:7.3957190948944E7},{level:4,resolution:9783.93962049996,scale:3.6978595474472E7},{level:5,resolution:4891.96981024998,scale:1.8489297737236E7},{level:6,resolution:2445.98490512499,scale:9244648.868618},{level:7,resolution:1222.99245256249,
scale:4622324.434309},{level:8,resolution:611.49622628138,scale:2311162.217155},{level:9,resolution:305.748113140558,scale:1155581.108577},{level:10,resolution:152.874056570411,scale:577790.554289},{level:11,resolution:76.4370282850732,scale:288895.277144},{level:12,resolution:38.2185141425366,scale:144447.638572},{level:13,resolution:19.1092570712683,scale:72223.819286},{level:14,resolution:9.55462853563415,scale:36111.909643},{level:15,resolution:4.77731426794937,scale:18055.954822},{level:16,resolution:2.38865713397468,
scale:9027.977411},{level:17,resolution:1.19432856685505,scale:4513.988705},{level:18,resolution:0.597164283559817,scale:2256.994353},{level:19,resolution:0.298582141647617,scale:1128.497176}]});this.spatialReference=new k(this.tileInfo.spatialReference.toJson());this.copyright=b.copyright||"";var h=new l(f),a=h.scheme+"://"+h.authority+"/";this.urlPath=f.substring(a.length);this.tileServers=b.tileServers||[];-1===h.authority.indexOf("{subDomain}")&&this.tileServers.push(a);if(b.subDomains&&0<b.subDomains.length&&
1<h.authority.split(".").length){this.subDomains=b.subDomains;var p;q.forEach(b.subDomains,function(c,a){-1<h.authority.indexOf("${subDomain}")?p=h.scheme+"://"+n.substitute(h.authority,{subDomain:c})+"/":-1<h.authority.indexOf("{subDomain}")&&(p=h.scheme+"://"+h.authority.replace(/\{subDomain\}/gi,c)+"/");this.tileServers.push(p)},this)}this.tileServers=q.map(this.tileServers,function(c){"/"!==c.charAt(c.length-1)&&(c+="/");return c});this._levelToLevelValue=[];q.forEach(this.tileInfo.lods,function(c){this._levelToLevelValue[c.level]=
c.levelValue||c.level},this);this.loaded=!0;this.onLoad(this)},getTileUrl:function(d,b,a){d=this._levelToLevelValue[d];var c=this.tileServers[b%this.tileServers.length]+n.substitute(this.urlPath,{level:d,col:a,row:b}),c=c.replace(/\{level\}/gi,d).replace(/\{row\}/gi,b).replace(/\{col\}/gi,a),c=this.addTimestampToURL(c);return r.addProxy(c)}});s("extend-esri")&&e.setObject("layers.WebTiledLayer",m,p);return m})},"esri/layers/ServiceGeneratedFeatureCollection":function(){define("dojo/_base/declare dojo/_base/connect dojo/_base/lang dojo/_base/array dojo/dom-construct dojo/dom-style dojo/has esri/kernel esri/SpatialReference esri/geometry/Extent esri/geometry/webMercatorUtils esri/renderers/SimpleRenderer esri/layers/layer esri/layers/FeatureLayer esri/dijit/PopupTemplate".split(" "),
function(m,e,q,l,s,n,p,r,k,g,h,d,f,b,a){m=m([f],{declaredClass:"esri.layers._ServiceGeneratedFeatureCollection",constructor:function(c,a){this.pointSymbol=a&&a.pointSymbol;this.polylineSymbol=a&&a.polylineSymbol;this.polygonSymbol=a&&a.polygonSymbol;this._outSR=a&&(a.outSpatialReference||a.outSR)||new k({wkid:4326});this._options=q.mixin({},a)},parse:function(){console.error("parse function has not been implemented")},getFeatureLayers:function(){var c=[];this._fLayers&&(c=c.concat(this._fLayers));
return c},onRefresh:function(){},onOpacityChange:function(){},refresh:function(){this.loaded&&(this._map&&!this._io&&this.visible)&&this._createLayer()},_createLayer:function(c){var a=this;this._fireUpdateStart();c=this.parse(c);c.addCallback(function(c){a._io=null;a._initLayer(c)});c.addErrback(function(c){a._io=null;c=q.mixin(Error(),c);c.message="Unable to load resource: "+a.url+" "+(c.message||"");a._fireUpdateEnd(c);a.onError(c)})},_initLayer:function(c){this.loaded&&this._removeInternalLayers();
this.name=c.name;this.description=c.description;this.snippet=c.snippet;this.defaultVisibility=void 0!==c.visibility?this.visible=!!c.visibility:this.visible=!0;this.featureInfos=c.featureInfos;this.fullExtent=this.initialExtent=new g(c.lookAtExtent);this.copyright=c.author||c.copyright;var f;if((c=q.getObject("featureCollection.layers",!1,c))&&0<c.length)this._fLayers=[],l.forEach(c,function(c,d){var h=q.getObject("featureSet.features",!1,c);h&&0<h.length&&(f=q.mixin({outFields:["*"],infoTemplate:c.popupInfo?
new a(c.popupInfo):null,editable:!1},this._options),f.id&&(f.id=f.id+"_"+d),c.layerDefinition.capabilities="Query,Data",h=new b(c,f),h.geometryType&&(this["_"+h.geometryType]=h),this._fLayers.push(h))},this),0===this._fLayers.length&&delete this._fLayers;this.items=[];this._esriGeometryPoint&&(this.items=this.items.concat(this._esriGeometryPoint.graphics),this.pointSymbol&&(c=new d(this.pointSymbol),this._esriGeometryPoint.setRenderer(c)));this._esriGeometryPolyline&&(this.items=this.items.concat(this._esriGeometryPolyline.graphics),
this.polylineSymbol&&(c=new d(this.polylineSymbol),this._esriGeometryPolyline.setRenderer(c)));this._esriGeometryPolygon&&(this.items=this.items.concat(this._esriGeometryPolygon.graphics),this.polygonSymbol&&(c=new d(this.polygonSymbol),this._esriGeometryPolygon.setRenderer(c)));this._fireUpdateEnd();this.loaded&&(this._addInternalLayers(),this.onRefresh())},_addInternalLayers:function(){var c=this._map;this._fireUpdateStart();var a=c.spatialReference,b=this._outSR,d;if(a.wkid)d=a._isWebMercator()&&
b._isWebMercator()||a.wkid===b.wkid;else if(a.wkt)d=a.wkt===b.wkt;else{console.log("_setMap - map has invalid spatial reference");return}if(!d)if(a._isWebMercator()&&4326===b.wkid)this._converter=h.geographicToWebMercator;else if(b._isWebMercator()&&4326===a.wkid)this._converter=h.webMercatorToGeographic;else{console.log("_setMap - unsupported workflow. Spatial reference of the map and layer do not match, and the conversion cannot be done on the client.");return}(a=this._fLayers)&&0<a.length&&l.forEach(a,
function(a){if(this._converter){var b=a.graphics,d,f,h=b?b.length:0;for(d=0;d<h;d++)(f=b[d].geometry)&&b[d].setGeometry(this._converter(f))}c.addLayer(a)},this);this.setVisibility(this.visible);this._fireUpdateEnd()},_removeInternalLayers:function(){var a=this._map;a&&l.forEach(this.getFeatureLayers(),a.removeLayer,a)},setOpacity:function(a){this.opacity!=a&&(l.forEach(this.getFeatureLayers(),function(b){b.setOpacity(a)}),this.opacity=this._options.opacity=a,this.onOpacityChange(a))},onVisibilityChange:function(a){this._fireUpdateStart();
l.forEach(this.getFeatureLayers(),function(b){b.setVisibility(a)});this._fireUpdateEnd()},_setMap:function(a,b){this.inherited(arguments);this._map=a;var d=this._div=s.create("div",null,b);n.set(d,"position","absolute");this._addInternalLayers();this.evaluateSuspension();return d},_unsetMap:function(a,b){this._io&&this._io.cancel();e.disconnect(this._extChgHandle);delete this._extChgHandle;this._removeInternalLayers();var d=this._div;d&&(b.removeChild(d),s.destroy(d));this._div=null;this.inherited(arguments)}});
p("extend-esri")&&q.setObject("layers._ServiceGeneratedFeatureCollection",m,r);return m})},"esri/layers/KMLGroundOverlay":function(){define("dojo/_base/declare dojo/_base/lang dojo/has esri/kernel esri/lang esri/layers/MapImage".split(" "),function(m,e,q,l,s,n){m=m([n],{declaredClass:"esri.layers.KMLGroundOverlay",constructor:function(p){s.isDefined(this.visibility)&&(this.visible=!!this.visibility)}});q("extend-esri")&&e.setObject("layers.KMLGroundOverlay",m,l);return m})},"dojo/data/util/simpleFetch":function(){define(["../../_base/lang",
"../../_base/kernel","./sorter"],function(m,e,q){var l={};m.setObject("dojo.data.util.simpleFetch",l);l.errorHandler=function(l,n){n.onError&&n.onError.call(n.scope||e.global,l,n)};l.fetchHandler=function(l,n){var p=n.abort||null,r=!1,k=n.start?n.start:0,g=n.count&&Infinity!==n.count?k+n.count:l.length;n.abort=function(){r=!0;p&&p.call(n)};var h=n.scope||e.global;n.store||(n.store=this);n.onBegin&&n.onBegin.call(h,l.length,n);n.sort&&l.sort(q.createSortFunction(n.sort,this));if(n.onItem)for(var d=
k;d<l.length&&d<g;++d){var f=l[d];r||n.onItem.call(h,f,n)}n.onComplete&&!r&&(d=null,n.onItem||(d=l.slice(k,g)),n.onComplete.call(h,d,n))};l.fetch=function(e){e=e||{};e.store||(e.store=this);this._fetchItems(e,m.hitch(this,"fetchHandler"),m.hitch(this,"errorHandler"));return e};return l})},"esri/layers/KMLLayer":function(){define("dojo/_base/kernel dojo/_base/declare dojo/_base/connect dojo/_base/lang dojo/_base/array dojo/_base/json dojo/_base/sniff dojo/io-query dojo/dom-construct dojo/dom-style esri/kernel esri/config esri/lang esri/request esri/SpatialReference esri/geometry/webMercatorUtils esri/dijit/PopupTemplate esri/layers/layer esri/layers/KMLFolder esri/layers/KMLGroundOverlay esri/layers/MapImageLayer esri/layers/FeatureLayer".split(" "),
function(m,e,q,l,s,n,p,r,k,g,h,d,f,b,a,c,u,v,t,z,F,B){var D=e([v],{declaredClass:"esri.layers.KMLLayer",serviceUrl:location.protocol+"//utility.arcgis.com/sharing/kml",constructor:function(c,b){c||console.log("KMLLayer:constructor - please provide url for the KML file");this._outSR=b&&b.outSR||new a({wkid:4326});this._options=l.mixin({},b);d.defaults.kmlService&&(this.serviceUrl=d.defaults.kmlService);var f=this.linkInfo=b&&b.linkInfo;f&&(this.visible=!!f.visibility,this._waitingForMap=!!f.viewFormat);
(!f||f&&f.visibility&&!this._waitingForMap)&&this._parseKml();this.refresh=l.hitch(this,this.refresh);this.registerConnectEvents("esri.layers.KMLLayer",!0)},getFeature:function(a){if(a){var c=a.type,b=a.id,d;switch(c){case "esriGeometryPoint":case "esriGeometryPolyline":case "esriGeometryPolygon":(a=this["_"+c])&&(d=l.getObject("_mode._featureMap."+b,!1,a));break;case "GroundOverlay":if(a=this._groundLyr){var f=a.getImages(),c=f.length;for(a=0;a<c;a++)if(f[a].id===b){d=f[a];break}}break;case "ScreenOverlay":break;
case "NetworkLink":s.some(this._links,function(a){return a.linkInfo&&a.linkInfo.id===b?(d=a,!0):!1});break;case "Folder":c=(f=this.folders)?f.length:0;for(a=0;a<c;a++)if(f[a].id===b){d=f[a];break}break;default:console.log("KMLLayer:getFeature - unknown feature type")}return d}},getLayers:function(){var a=[];this._groundLyr&&a.push(this._groundLyr);this._fLayers&&(a=a.concat(this._fLayers));this._links&&s.forEach(this._links,function(c){c.declaredClass&&a.push(c)});return a},setFolderVisibility:function(a,
c){a&&(this._fireUpdateStart(),(a.visible=c)&&(c=this._areLocalAncestorsVisible(a)),this._setState(a,c),this._fireUpdateEnd())},onRefresh:function(){},onOpacityChange:function(){},_parseKml:function(a){var c=this;this._fireUpdateStart();this._io=b({url:this.serviceUrl,content:{url:this._url.path+this._getQueryParameters(a),model:"simple",folders:"",refresh:this.loaded?!0:void 0,outSR:n.toJson(this._outSR.toJson())},callbackParamName:"callback",load:function(a){c._io=null;c._initLayer(a)},error:function(a){c._io=
null;a=l.mixin(Error(),a);a.message="Unable to load KML: "+c.url+" "+(a.message||"");c._fireUpdateEnd(a);c.onError(a)}})},_initLayer:function(a){this.loaded&&this._removeInternalLayers();this.name=a.name;this.description=a.description;this.snippet=a.snippet;this.visibility=a.visibility;this.featureInfos=a.featureInfos;var c,b,d=this.folders=a.folders,f=[],h;if(d){b=d.length;for(c=0;c<b;c++)h=d[c]=new t(d[c]),-1===h.parentFolderId&&f.push(h)}var d=this._links=a.networkLinks,g;b=d?d.length:0;for(c=
0;c<b;c++)d[c].viewRefreshMode&&-1!==d[c].viewRefreshMode.toLowerCase().indexOf("onregion")||(g=l.mixin({},this._options),g.linkInfo=d[c],g.id&&(g.id=g.id+"_"+c),d[c]=new D(d[c].href,g),d[c]._parentLayer=this,d[c]._parentFolderId=this._getLinkParentId(d[c].linkInfo.id));if((d=a.groundOverlays)&&0<d.length){g=l.mixin({},this._options);g.id&&(g.id+="_mapImage");h=this._groundLyr=new F(g);b=d.length;for(c=0;c<b;c++)h.addImage(new z(d[c]))}if((a=l.getObject("featureCollection.layers",!1,a))&&0<a.length)this._fLayers=
[],s.forEach(a,function(a,c){var b=l.getObject("featureSet.features",!1,a);b&&0<b.length&&(g=l.mixin({outFields:["*"],infoTemplate:a.popupInfo?new u(a.popupInfo):null,editable:!1},this._options),g.id&&(g.id=g.id+"_"+c),a.layerDefinition.capabilities="Query,Data",b=new B(a,g),b.geometryType&&(this["_"+b.geometryType]=b),this._fLayers.push(b))},this),0===this._fLayers.length&&delete this._fLayers;b=f.length;for(c=0;c<b;c++)h=f[c],this._setState(h,h.visible);this._fireUpdateEnd();this.loaded?(this._addInternalLayers(),
this.onRefresh()):(this.loaded=!0,this.onLoad(this))},_addInternalLayers:function(){var a=this._map;this._fireUpdateStart();this._links&&s.forEach(this._links,function(c){c.declaredClass&&(a.addLayer(c),c._waitingForMap&&(c._waitingForMap=null,c.visible?c._parseKml(a):c._wMap=a))});var b=a.spatialReference,d=this._outSR,f;if(!b.equals(d))if(b.isWebMercator()&&4326===d.wkid)f=c.geographicToWebMercator;else if(d.isWebMercator()&&4326===b.wkid)f=c.webMercatorToGeographic;else{console.log("KMLLayer:_setMap - unsupported workflow. Spatial reference of the map and kml layer do not match, and the conversion cannot be done on the client.");
return}this._groundLyr&&(f&&s.forEach(this._groundLyr.getImages(),function(a){a.extent=f(a.extent)}),a.addLayer(this._groundLyr));(b=this._fLayers)&&0<b.length&&s.forEach(b,function(c){if(f){var b=c.graphics,d,h,g=b?b.length:0;for(d=0;d<g;d++)(h=b[d].geometry)&&b[d].setGeometry(f(h))}a.addLayer(c)});this.onVisibilityChange(this.visible)},_removeInternalLayers:function(){var a=this._map;this._links&&s.forEach(this._links,function(a){a.declaredClass&&a._io&&a._io.cancel()});a&&s.forEach(this.getLayers(),
a.removeLayer,a)},_setState:function(a,c){var b=a.featureInfos,d,f,h,g=b?b.length:0,k=c?"show":"hide";for(h=0;h<g;h++)if(d=b[h],f=this.getFeature(d))if("Folder"===d.type)this._setState(f,c&&f.visible);else if("NetworkLink"===d.type)this._setInternalVisibility(f,c);else f[k]()},_areLocalAncestorsVisible:function(a){var c=a.parentFolderId;for(a=a.visible;a&&-1!==c;)c=this.getFeature({type:"Folder",id:c}),a=a&&c.visible,c=c.parentFolderId;return a},_setInternalVisibility:function(a,c){var b=a._parentLayer,
d=a._parentFolderId;for(c=c&&a.visible;c&&b;)c=c&&b.visible,-1<d&&(c=c&&b._areLocalAncestorsVisible(b.getFeature({type:"Folder",id:d}))),d=b._parentFolderId,b=b._parentLayer;this._setIntState(a,c)},_setIntState:function(a,c){a&&s.forEach(a.getLayers(),function(b){b.linkInfo?a._setIntState(b,c&&b.visible&&a._areLocalAncestorsVisible(a.getFeature({type:"Folder",id:b._parentFolderId}))):b.setVisibility(c)})},_getLinkParentId:function(a){var c=-1;this.folders&&s.some(this.folders,function(b){return b.networkLinkIds&&
-1!==s.indexOf(b.networkLinkIds,a)?(c=b.id,!0):!1});return c},_checkAutoRefresh:function(){var a=this.linkInfo;if(a)if(this.visible){if(this.loaded&&this._map){var c=a.refreshMode,b=a.refreshInterval,d=a.viewRefreshMode,a=a.viewRefreshTime;c&&(-1!==c.toLowerCase().indexOf("oninterval")&&0<b)&&(this._stopAutoRefresh(),this._timeoutHandle=setTimeout(this.refresh,1E3*b));d&&(-1!==d.toLowerCase().indexOf("onstop")&&0<a)&&!this._extChgHandle&&(this._extChgHandle=q.connect(this._map,"onExtentChange",this,
this._extentChanged))}}else this._stopAutoRefresh(),q.disconnect(this._extChgHandle),delete this._extChgHandle},_stopAutoRefresh:function(){clearTimeout(this._timeoutHandle);this._timeoutHandle=null},_getQueryParameters:function(a){a=a||this._map;var b={},d=this.linkInfo,g=a&&a.extent,k;this._url.query&&(l.mixin(b,this._url.query),k=!!this._url.query.token);if(h.id&&!k&&(k=h.id.findCredential(this._url.path)))b.token=k.token;if(d){k=d.viewFormat;var p=d.httpQuery,d=d.viewBoundScale;if(g&&k){var e=
g,n=g,q=g.spatialReference;q&&(q.isWebMercator()?e=c.webMercatorToGeographic(g):4326===q.wkid&&(n=c.geographicToWebMercator(g)));g=e.getCenter();n=Math.max(n.getWidth(),n.getHeight());d&&(e=e.expand(d));k=k.replace(/\[bboxWest\]/ig,e.xmin).replace(/\[bboxEast\]/ig,e.xmax).replace(/\[bboxSouth\]/ig,e.ymin).replace(/\[bboxNorth\]/ig,e.ymax).replace(/\[lookatLon\]/ig,g.x).replace(/\[lookatLat\]/ig,g.y).replace(/\[lookatRange\]/ig,n).replace(/\[lookatTilt\]/ig,0).replace(/\[lookatHeading\]/ig,0).replace(/\[lookatTerrainLon\]/ig,
g.x).replace(/\[lookatTerrainLat\]/ig,g.y).replace(/\[lookatTerrainAlt\]/ig,0).replace(/\[cameraLon\]/ig,g.x).replace(/\[cameraLat\]/ig,g.y).replace(/\[cameraAlt\]/ig,n).replace(/\[horizFov\]/ig,60).replace(/\[vertFov\]/ig,60).replace(/\[horizPixels\]/ig,a.width).replace(/\[vertPixels\]/ig,a.height).replace(/\[terrainEnabled\]/ig,0);l.mixin(b,r.queryToObject(k))}p&&(p=p.replace(/\[clientVersion\]/ig,h.version).replace(/\[kmlVersion\]/ig,2.2).replace(/\[clientName\]/ig,"ArcGIS API for JavaScript").replace(/\[language\]/ig,
m.locale),l.mixin(b,r.queryToObject(p)))}a=[];for(var t in b)f.isDefined(b[t])&&a.push(t+"\x3d"+b[t]);return(a=a.join("\x26"))?"?"+a:""},setOpacity:function(a){this.opacity!=a&&(s.forEach(this.getLayers(),function(c){c.setOpacity(a)}),this.opacity=this._options.opacity=a,this.onOpacityChange(a))},_setMap:function(a,c){this.inherited(arguments);this._map=a;var b=this._div=k.create("div",null,c);g.set(b,"position","absolute");this._addInternalLayers();this.evaluateSuspension();return b},_unsetMap:function(a,
c){this._io&&this._io.cancel();this._stopAutoRefresh();q.disconnect(this._extChgHandle);delete this._extChgHandle;this._removeInternalLayers();var b=this._div;b&&(c.removeChild(b),k.destroy(b));this._wMap=this._div=null;this.inherited(arguments)},onVisibilityChange:function(a){this.loaded?(this._fireUpdateStart(),this._setInternalVisibility(this,a),this._checkAutoRefresh(),this._fireUpdateEnd()):this.linkInfo&&a&&(this._waitingForMap||this._parseKml(this._wMap))},refresh:function(){this.loaded&&(this._map&&
!this._io&&this.visible)&&this._parseKml()},getFeatureCollection:function(a){var c,b=[];if(a=this.getFeature({type:"Folder",id:a}))(c=s.map(a.featureInfos,function(a){if("esriGeometryPoint"===a.type||"esriGeometryPolyline"===a.type||"esriGeometryPolygon"===a.type)return a.id},this))&&0<c.length&&s.forEach(this._fLayers,function(a){var d,f;d=a.toJson();d.featureSet.features&&0<d.featureSet.features.length&&(f=s.filter(d.featureSet.features,function(b){if(-1!==s.indexOf(c,b.attributes[a.objectIdField]))return b},
this));f&&0<f.length&&(d.featureSet.features=f,b.push(d))},this);return b},getFeatureCount:function(a){a=this.getFeature({type:"Folder",id:a});var c={points:0,polylines:0,polygons:0};a&&s.forEach(a.featureInfos,function(a){"esriGeometryPoint"===a.type&&(c.points+=1);"esriGeometryPolyline"===a.type&&(c.polylines+=1);"esriGeometryPolygon"===a.type&&(c.polygons+=1)});return c},_extentChanged:function(){this._stopAutoRefresh();this._timeoutHandle=setTimeout(this.refresh,1E3*this.linkInfo.viewRefreshTime)}});
p("extend-esri")&&l.setObject("layers.KMLLayer",D,h);return D})},"dojo/data/util/sorter":function(){define(["../../_base/lang"],function(m){var e={};m.setObject("dojo.data.util.sorter",e);e.basicComparator=function(e,l){var m=-1;null===e&&(e=void 0);null===l&&(l=void 0);if(e==l)m=0;else if(e>l||null==e)m=1;return m};e.createSortFunction=function(q,l){function m(d,b,a,c){return function(h,g){var k=c.getValue(h,d),e=c.getValue(g,d);return b*a(k,e)}}for(var n=[],p,r=l.comparatorMap,k=e.basicComparator,
g=0;g<q.length;g++){p=q[g];var h=p.attribute;if(h){p=p.descending?-1:1;var d=k;r&&("string"!==typeof h&&"toString"in h&&(h=h.toString()),d=r[h]||k);n.push(m(h,p,d,l))}}return function(d,b){for(var a=0;a<n.length;){var c=n[a++](d,b);if(0!==c)return c}return 0}};return e})},"esri/layers/OnDemandMode":function(){define("dojo/_base/declare dojo/_base/connect dojo/_base/lang dojo/_base/array dojo/has esri/kernel esri/geometry/Point esri/tasks/query esri/layers/RenderMode esri/layers/GridLayout".split(" "),
function(m,e,q,l,s,n,p,r,k,g){m=m([k],{declaredClass:"esri.layers._OnDemandMode",constructor:function(h){this.featureLayer=h;this._featureMap={};this._queryErrorHandler=q.hitch(this,this._queryErrorHandler)},initialize:function(h){this.inherited(arguments);var d=this.featureLayer,f=d._srInfo;this._gridLayer=new g(new p(f?f.valid[0]:h.extent.xmin,h.extent.ymax,h.spatialReference),{width:d._tileWidth,height:d._tileHeight},{width:h.width,height:h.height},f);this._cellMap={};this._gridLayer.setResolution(h.extent)},
startup:function(){this._ioQueue=[];this.featureLayer.suspended||(this._zoomHandler(),this._enableConnectors())},propertyChangeHandler:function(h){this._init&&(2>h?this._zoomHandler():console.log("FeatureLayer: layer in on-demand mode does not support time definitions. Layer id \x3d "+this.featureLayer.id+", Layer URL \x3d "+this.featureLayer.url))},destroy:function(){this._disableConnectors();this.inherited(arguments)},drawFeature:function(h){var d=this._gridLayer,f=h.geometry,b=[];if(f)for(var b=
d.getCellsInExtent("point"===f.type?{xmin:f.x,ymin:f.y,xmax:f.x,ymax:f.y}:f.getExtent(),!1).cells,d=this._cellMap,a,c=h.attributes[this.featureLayer.objectIdField],g,k,e,f=0;f<b.length;f++)a=b[f],g=a.latticeID,k=a.row,e=a.col,g?a=d[g]=d[g]||a:(d[k]=d[k]||{},a=d[k][e]=d[k][e]||a),a.features=a.features||[],a.features.push(h),this._addFeatureIIf(c,h),this._incRefCount(c)},suspend:function(){this._init&&this._disableConnectors()},resume:function(){this._init&&(this._enableConnectors(),this._zoomHandler())},
refresh:function(){this._zoomHandler()},_enableConnectors:function(){var h=this.map;this._zoomConnect=e.connect(h,"onZoomEnd",this,this._zoomHandler);this._panConnect=e.connect(h,"onPanEnd",this,this._panHandler);this._resizeConnect=e.connect(h,"onResize",this,this._panHandler)},_disableConnectors:function(){e.disconnect(this._zoomConnect);e.disconnect(this._panConnect);e.disconnect(this._resizeConnect)},_zoomHandler:function(){this._processIOQueue(!0);var h=this.featureLayer,d=this.map;h.suspended||
(h._fireUpdateStart(),this._clearIIf(),(h=h._trackManager)&&h.clearTracks(),this._cellMap={},this._gridLayer.setResolution(d.extent),this._sendRequest())},_panHandler:function(h){this.featureLayer._fireUpdateStart();this._sendRequest(this.featureLayer._resized&&h)},_getRequestId:function(h,d){return("_"+h.name+h.layerId+h._ulid+"_"+d.resolution+"_"+(d.latticeID||d.row+"_"+d.col)).replace(/[^a-zA-Z0-9\_]+/g,"_")},_sendRequest:function(h){this._exceeds=!1;var d=this.featureLayer,f=this.map;h=h||f.extent;
f=this._gridLayer.getCellsInExtent(h,d.latticeTiling).cells;if(!d.isEditable())var b=this._cellMap,f=l.filter(f,function(a){if(a.lattice){if(b[a.latticeID])return!1}else if(b[a.row]&&b[a.row][a.col])return!1;return!0});var a=d.getOutFields(),c=d.getDefinitionExpression(),g=d._getOffsettedTE(d._mapTimeExtent),k=d.supportsAdvancedQueries?d.getOrderByFields():null,e=d._usePatch,p=this._ioQueue,n,m=this,q=this._drawFeatures,s,w,J;this._pending=this._pending||0;for(n=0;n<f.length;n++){s=f[n];w=new r;w.geometry=
s.extent||s.lattice;w.outFields=a;w.where=c;d.latticeTiling&&s.extent&&(w.spatialRelationship=r.SPATIAL_REL_CONTAINS);w.returnGeometry=!0;w.timeExtent=g;w.maxAllowableOffset=d._maxOffset;d._ts&&(w._ts=(new Date).getTime());w.orderByFields=k;J=null;if(e&&(J=this._getRequestId(d,s),this._isPending(J)))continue;this._pending++;p.push(d._task.execute(w,function(){var a=s;return function(c){q.apply(m,[c,a])}}.call(this),this._queryErrorHandler,J))}this._removeOldCells(h);this._endCheck()},_drawFeatures:function(h,
d){this._exceeds=this._exceeds||h.exceededTransferLimit;this._finalizeIO();var f=this.map.extent,b=d.extent,a=d.row,c=d.col,g=this.featureLayer.objectIdField,k=h.features,e=this._gridLayer,p=this._cellMap,l=d.latticeID,r=l?p[l]:p[a]&&p[a][c];if(d.resolution!=e._resolution||(l?l!==e.getLatticeID(f):!e.intersects(b,f)))r&&this._removeCell(a,c,l);else if(r)this._updateCell(r,k);else{d.features=k;l?p[l]=d:(p[a]=p[a]||{},p[a][c]=d);b=k.length;for(f=0;f<b;f++)a=k[f],c=a.attributes[g],this._addFeatureIIf(c,
a),this._incRefCount(c)}this._endCheck()},_queryErrorHandler:function(h){this._finalizeIO();this.featureLayer._errorHandler(h);this._endCheck(!0)},_finalizeIO:function(){this._purgeRequests();this._pending--},_endCheck:function(h){if(0===this._pending){this._processIOQueue();var d=this.featureLayer,f=d._trackManager;f&&(f.clearTracks(),f.addFeatures(d.graphics),d._ager&&l.forEach(d.graphics,function(b){b._shape&&d._repaint(b)}),f.moveLatestToFront(),f.drawTracks());this.featureLayer._fireUpdateEnd(h&&
Error("FeatureLayer: an error occurred while updating the layer"),this._exceeds?{queryLimitExceeded:!0}:null);if(this._exceeds)d.onQueryLimitExceeded()}},_processIOQueue:function(h){this._ioQueue=l.filter(this._ioQueue,function(d){return-1<d.fired?!1:!0});h&&l.forEach(this._ioQueue,this._cancelPendingRequest)},_removeOldCells:function(h){var d=this._cellMap,f=this._gridLayer,b,a;for(b in d)if(d[b]){var c=d[b],g=c.latticeID,k=0,e=0;if(g)k++,g!==f.getLatticeID(h)&&(this._removeCell(null,null,g),e++);
else for(a in c)c[a]&&(k++,f.intersects(c[a].extent,h)||(this._removeCell(b,a),e++));e===k&&delete d[b]}},_updateCell:function(h,d){var f=this.featureLayer,b=f.objectIdField,f=f._selectedFeatures,a,c=d.length;h.features=h.features||[];for(a=0;a<c;a++){var g=d[a],k=g.attributes[b],e=this._addFeatureIIf(k,g);e===g?(this._incRefCount(k),h.features.push(e)):k in f||(e.setGeometry(g.geometry),e.setAttributes(g.attributes))}},_removeCell:function(g,d,f){var b=this._cellMap,a=this.featureLayer,c=a.objectIdField,
k=f?b[f]:b[g]&&b[g][d];if(k){f?delete b[f]:delete b[g][d];g=k.features;for(d=0;d<g.length;d++)f=g[d].attributes[c],this._decRefCount(f),f in a._selectedFeatures||this._removeFeatureIIf(f)}}});s("extend-esri")&&q.setObject("layers._OnDemandMode",m,n);return m})},"esri/layers/FeatureLayer":function(){define("dojo/_base/declare dojo/_base/connect dojo/_base/lang dojo/_base/array dojo/_base/json dojo/_base/Deferred dojo/date/locale dojo/sniff dojo/io-query dojo/dom-construct dojo/i18n dojo/when dojo/promise/all esri/kernel esri/lang esri/request esri/config esri/deferredUtils esri/SpatialReference esri/symbols/SimpleMarkerSymbol esri/symbols/SimpleLineSymbol esri/symbols/SimpleFillSymbol esri/symbols/jsonUtils esri/renderers/SimpleRenderer esri/renderers/UniqueValueRenderer esri/renderers/jsonUtils esri/tasks/QueryTask esri/tasks/query esri/tasks/FeatureSet esri/tasks/StatisticDefinition esri/geometry/Extent esri/geometry/jsonUtils esri/geometry/normalizeUtils esri/geometry/scaleUtils esri/layers/GraphicsLayer esri/layers/Field esri/layers/TimeInfo esri/layers/FeatureType esri/layers/FeatureTemplate esri/layers/FeatureEditResult esri/layers/LabelClass esri/layers/SnapshotMode esri/layers/OnDemandMode esri/layers/SelectionMode esri/layers/TrackManager dojo/i18n!esri/nls/jsapi dojo/has!extend-esri?esri/layers/agscommon".split(" "),
function(m,e,q,l,s,n,p,r,k,g,h,d,f,b,a,c,u,v,t,z,F,B,D,I,w,J,T,O,P,x,U,R,ba,E,ca,da,ea,G,fa,M,ga,S,ha,ia,ja){var ka=u.defaults,y=m(ca,{declaredClass:"esri.layers.FeatureLayer",invalidParams:"query contains one or more unsupported parameters",reHostedFS:/https?:\/\/services.*\.arcgis\.com/i,maxPointCountForAuto:4E3,maxRecordCountForAuto:2E3,maxVertexCountForAuto:25E4,generalizeForScale:4E3,_eventMap:{"add-attachment-complete":["result"],"before-apply-edits":["adds","updates","deletes"],"delete-attachments-complete":["results"],
"edits-complete":["adds","updates","deletes"],"query-attachment-infos-complete":["results"],"query-count-complete":["count"],"query-features-complete":["featureSet"],"query-ids-complete":["objectIds"],"query-related-features-complete":["featureSets"],"selection-complete":["features","method"],"update-end":["error","info"]},constructor:function(a,c){this._preventInit||this._initFeatureLayer(a,c)},_initFeatureLayer:function(H,b){this.i18n=h.getLocalization("esri","jsapi");b=b||{};this._outFields=b.outFields;
this._loadCallback=b.loadCallback;var d=b._usePatch;this._usePatch=null===d||void 0===d?!0:d;this._trackIdField=b.trackIdField;this.objectIdField=b.objectIdField;this._maxOffset=null!=b.maxAllowableOffset?b.maxAllowableOffset:this.maxAllowableOffset;this._optEditable=b.editable;this._optAutoGen=b.autoGeneralize;this.editSummaryCallback=b.editSummaryCallback;this.userId=b.userId;this.userIsAdmin=b.userIsAdmin;this.useMapTime=b.hasOwnProperty("useMapTime")?!!b.useMapTime:!0;this.source=b.source;this.gdbVersion=
b.gdbVersion;this.orderByFields=b.orderByFields;this.maxPointCountForAuto=null!=b.maxPointCountForAuto?b.maxPointCountForAuto:this.maxPointCountForAuto;this.maxRecordCountForAuto=null!=b.maxRecordCountForAuto?b.maxRecordCountForAuto:this.maxRecordCountForAuto;this.maxVertexCountForAuto=null!=b.maxVertexCountForAuto?b.maxVertexCountForAuto:this.maxVertexCountForAuto;this.generalizeForScale=null!=b.generalizeForScale?b.generalizeForScale:this.generalizeForScale;this.queryPagination=null!=b.queryPagination?
b.queryPagination:this.url?this.reHostedFS.test(this.url):!1;this._selectedFeatures={};this._selectedFeaturesArr=[];this._newFeatures=[];this._deletedFeatures={};this._ulid=this._getUniqueId();var f=y;switch(this.mode=a.isDefined(b.mode)?b.mode:f.MODE_ONDEMAND){case f.MODE_SNAPSHOT:this.currentMode=f.MODE_SNAPSHOT;this._mode=new S(this);this._isSnapshot=!0;break;case f.MODE_ONDEMAND:case f.MODE_AUTO:this.currentMode=f.MODE_ONDEMAND;this._tileWidth=b.tileWidth||512;this._tileHeight=b.tileHeight||512;
this._mode=new ha(this);this.latticeTiling=b.latticeTiling;break;case f.MODE_SELECTION:this.currentMode=f.MODE_SELECTION,this._mode=new ia(this),this._isSelOnly=!0}this._initLayer=q.hitch(this,this._initLayer);this._selectHandler=q.hitch(this,this._selectHandler);this._editable=!1;if(q.isObject(H)&&H.layerDefinition)return this._collection=!0,this.mode=f.MODE_SNAPSHOT,this._initLayer(H),this;this._task=new T(this.url,{source:this.source,gdbVersion:this.gdbVersion});d=this._url.path;this._fserver=
!1;-1!==d.search(/\/FeatureServer\//i)&&(this._fserver=!0);this.mode===f.MODE_AUTO&&this.reHostedFS.test(this.url)&&this._queryLimit();(f=b.resourceInfo)?this._initLayer(f):(this.source&&(f={source:this.source.toJson()},this._url.query=q.mixin(this._url.query,{layer:s.toJson(f)})),this.gdbVersion&&(this._url.query=q.mixin(this._url.query,{gdbVersion:this.gdbVersion})),c({url:d,content:q.mixin({f:"json"},this._url.query),callbackParamName:"callback",load:this._initLayer,error:this._errorHandler}));
this.registerConnectEvents()},_initLayer:function(b,c){if(b||c){this._json=b;this._findCredential();if(this.credential&&this.credential.ssl||b&&b._ssl)this._useSSL(),this._task._useSSL();this._collection&&(this.currentMode=y.MODE_SNAPSHOT,this._mode=new S(this),this._isSnapshot=!0,this._featureSet=b.featureSet,this._nextId=b.nextObjectId,b=b.layerDefinition);if(b.hasOwnProperty("capabilities")){var d=this.capabilities=b.capabilities;d&&-1!==d.toLowerCase().indexOf("editing")?this._editable=!0:this._editable=
!1}else this._collection||(this._editable=this._fserver);a.isDefined(this._optEditable)&&(this._editable=this._optEditable,delete this._optEditable);this._json=s.toJson(this._json);if(this.isEditable())delete this._maxOffset;else if(this.currentMode!==y.MODE_SNAPSHOT&&("esriGeometryPolyline"===b.geometryType||"esriGeometryPolygon"===b.geometryType))this._autoGeneralize=a.isDefined(this._optAutoGen)?this._optAutoGen:this.currentMode===y.MODE_ONDEMAND,delete this._optAutoGen;var d=b.effectiveMinScale||
b.minScale,f=b.effectiveMaxScale||b.maxScale;!this._hasMin&&d&&this.setMinScale(d);!this._hasMax&&f&&this.setMaxScale(f);this.layerId=b.id;this.name=b.name;this.description=b.description;this.copyright=b.copyrightText;this.type=b.type;this.geometryType=b.geometryType;this.displayField=b.displayField;this.defaultDefinitionExpression=b.definitionExpression;this.fullExtent=new U(b.extent);this.initialExtent=new U(this.fullExtent.toJson());this.fullExtent.spatialReference&&(this.spatialReference=new t(this.fullExtent.spatialReference.toJson()));
this.defaultVisibility=b.defaultVisibility;if("esriGeometryPoint"===this.geometryType||"esriGeometryMultipoint"===this.geometryType)this.latticeTiling=!1;this.indexedFields=b.indexedFields;this.maxRecordCount=b.maxRecordCount;this.canModifyLayer=b.canModifyLayer;this.supportsStatistics=b.supportsStatistics;this.supportsAdvancedQueries=this._collection?!1:b.supportsAdvancedQueries;this.hasLabels=b.hasLabels;this.canScaleSymbols=b.canScaleSymbols;this.supportsRollbackOnFailure=b.supportsRollbackOnFailure;
this.syncCanReturnChanges=b.syncCanReturnChanges;this.isDataVersioned=b.isDataVersioned;this.editFieldsInfo=b.editFieldsInfo;this.ownershipBasedAccessControlForFeatures=b.ownershipBasedAccessControlForFeatures;this.editFieldsInfo&&this.ownershipBasedAccessControlForFeatures&&(this.creatorField=this.editFieldsInfo.creatorField);this.relationships=b.relationships;this.allowGeometryUpdates=a.isDefined(b.allowGeometryUpdates)?b.allowGeometryUpdates:!0;this._isTable="Table"===this.type;for(var g=this.fields=
[],f=b.fields,d=0;d<f.length;d++)g.push(new da(f[d]));if(!this.objectIdField){this.objectIdField=b.objectIdField;if(!this.objectIdField){f=b.fields;for(d=0;d<f.length;d++)if(g=f[d],"esriFieldTypeOID"===g.type){this.objectIdField=g.name;break}}this.objectIdField||console.debug("esri.layers.FeatureLayer: "+a.substitute({url:this.url},"objectIdField is not set [url: ${url}]"))}if(!a.isDefined(this._nextId)){f=this.objectIdField;g=-1;if(this._collection&&f)for(var h=(d=this._featureSet)&&d.features,k=
h?h.length:0,e,d=0;d<k;d++)e=(e=h[d].attributes)&&e[f],e>g&&(g=e);this._nextId=g+1}this.globalIdField=b.globalIdField;if(d=this.typeIdField=b.typeIdField)if(d=!this._getField(d)&&this._getField(d,!0))this.typeIdField=d.name;this.visibilityField=b.visibilityField;if(f=b.defaultSymbol)this.defaultSymbol=D.fromJson(f);var p=this.types=[],n=b.types,m,u,g=(d=this.editFieldsInfo)&&d.creatorField,h=d&&d.editorField;e=g||h;k=[];if(n)for(d=0;d<n.length;d++)m=new G(n[d]),u=m.templates,e&&(u&&u.length)&&(k=
k.concat(u)),p.push(m);n=b.templates;m=this.templates=[];if(n)for(d=0;d<n.length;d++)p=new fa(n[d]),e&&k.push(p),m.push(p);for(d=0;d<k.length;d++)if(e=q.getObject("prototype.attributes",!1,k[d]))g&&delete e[g],h&&delete e[h];if(d=b.timeInfo)this.timeInfo=new ea(d),this._startTimeField=d.startTimeField,this._endTimeField=d.endTimeField,this._startTimeField&&this._endTimeField&&(this._twoTimeFields=!0),this._trackIdField?d.trackIdField=this._trackIdField:this._trackIdField=d.trackIdField;this.hasAttachments=
!this._collection&&b.hasAttachments?!0:!1;this.htmlPopupType=b.htmlPopupType;var d=b.drawingInfo,x;if(g=d&&d.labelingInfo)this.labelingInfo=l.map(g,function(a){return new ga(a)}),this._fixLabelExpr();if(!this.renderer)if(d&&d.renderer){if(x=d.renderer,this.setRenderer(J.fromJson(x)),"classBreaks"===x.type&&this.renderer.setMaxInclusive(!0),!this._collection){var v=x.type,f=[];x=this.renderer;switch(v){case "simple":f.push(x.symbol);break;case "uniqueValue":case "classBreaks":f.push(x.defaultSymbol),
f=f.concat(l.map(x.infos,function(a){return a.symbol}))}var f=l.filter(f,a.isDefined),R=this._url.path+"/images/",Q=this._getToken();l.forEach(f,function(a){var b=a.url;b&&(-1===b.search(/https?\:/)&&-1===b.indexOf("data:")&&(a.url=R+b),Q&&-1!==a.url.search(/https?\:/)&&(a.url+="?token\x3d"+Q))})}}else if(f)n=this.types,0<n.length?(x=new w(this.defaultSymbol,this.typeIdField),l.forEach(n,function(a){x.addValue(a.id,a.symbol)})):x=new I(this.defaultSymbol),this.setRenderer(x);else if(!this._isTable){switch(this.geometryType){case "esriGeometryPoint":case "esriGeometryMultipoint":v=
new z;break;case "esriGeometryPolyline":v=new F;break;case "esriGeometryPolygon":v=new B}this.setRenderer(v?new I(v):null)}v=d&&d.transparency||0;!this.hasOwnProperty("opacity")&&0<v&&(this.opacity=1-v/100);this.version=b.currentVersion;this.version||(this.version="capabilities"in b||"drawingInfo"in b||"hasAttachments"in b||"htmlPopupType"in b||"relationships"in b||"timeInfo"in b||"typeIdField"in b||"types"in b?10:9.3);if((r("ie")||r("safari"))&&this.isEditable()&&10.02>this.version)this._ts=!0;this.statistics=
b.statistics;this._fixRendererFields();this._checkFields();this._updateCaps();var N=function(){this.loaded=!0;this.onLoad(this);var a=this._loadCallback;a&&(delete this._loadCallback,a(this))};this._collection?(v=this._featureSet,this._featureSet=null,this._mode._drawFeatures(new P(v)),this._fcAdded=!0,N.call(this)):this._forceIdentity(this._limitPromise?function(){var a=this;this._limitPromise.then(function(b){a._checkMode(b)});this._limitPromise.always(function(){a._limitPromise=null;N.call(a)})}:
N)}},onRendererChange:function(){this.inherited(arguments);var b=this._getRenderer();this._ager=!(!b||!b.observationAger||!b.observationRenderer);if(b){var c=[],b=l.filter([b,b.observationRenderer,b.latestObservationRenderer,b.trackRenderer],a.isDefined);l.forEach(b,function(a){q.isFunction(a.attributeField)||c.push(a.attributeField);c.push(a.attributeField2);c.push(a.attributeField3)},this);this._rendererFields=l.filter(c,a.isDefined)}else this._rendererFields=[];this.loaded&&(this._fixRendererFields(),
this._checkFields(this._rendererFields),this._collection&&(this._typesDirty=!0))},redraw:function(){this.inherited(arguments);this._trackManager&&this._trackManager.container&&this._trackManager.container.redraw()},_evalSDRenderer:function(){this.inherited(arguments);var a=this._getRenderer();this._ager=!(!a||!a.observationAger||!a.observationRenderer);this._trackManager&&this._trackManager.container&&this._trackManager.container.setRenderer(a&&a.trackRenderer)},_setMap:function(a){var b=this.inherited(arguments),
c=this._mode,d=this;c&&c.initialize(a);this.geometryType&&this.attr("data-geometry-type",this.geometryType.replace(/esriGeometry/i,"").toLowerCase());this._addHandle=this.on("graphic-node-add",function(a){a=a.graphic.attributes;(a=d._selectedFeatures[a&&a[d.objectIdField]])&&a.attr("data-selected","")});return b},_unsetMap:function(a){var b=this._mode;b&&b.suspend();this._trackManager&&(this._trackManager.destroy(),this._trackManager=null);e.disconnect(this._zoomConnect);e.disconnect(this._addHandle);
this._zoomConnect=this._addHandle=null;this._toggleTime(!1);this.inherited("_unsetMap",arguments)},refresh:function(){var a=this._mode;a&&a.refresh()},getOutFields:function(){return l.filter(this._getOutFields(),function(a){return"*"===a||!!this._getField(a)},this)},setEditable:function(a){if(!this._collection)return console.log("FeatureLayer:setEditable - this functionality is not yet supported for layer in a feature service"),this;if(!this.loaded)return this._optEditable=a,this;var b=this._editable;
this._editable=a;this._updateCaps();if(b!==a)this.onCapabilitiesChange();return this},getEditCapabilities:function(a){var b={canCreate:!1,canUpdate:!1,canDelete:!1};if(!this.loaded||!this.isEditable())return b;var c=a&&a.feature;a=a&&a.userId;var d=l.map(this.capabilities?this.capabilities.toLowerCase().split(","):[],q.trim),f=-1<l.indexOf(d,"editing"),g=f&&-1<l.indexOf(d,"create"),b=f&&-1<l.indexOf(d,"update"),d=f&&-1<l.indexOf(d,"delete"),h=this.ownershipBasedAccessControlForFeatures,k=this.editFieldsInfo,
e=k&&k.creatorField,k=k&&k.realm,c=(c=c&&c.attributes)&&e?c[e]:void 0,p=!!this.userIsAdmin,e=!h||p||!(!h.allowOthersToUpdate&&!h.allowUpdateToOthers),h=!h||p||!(!h.allowOthersToDelete&&!h.allowDeleteToOthers);if(p||f&&!g&&!b&&!d)g=b=d=!0;f={canCreate:g,canUpdate:b,canDelete:d};null===c?(f.canUpdate=b&&e,f.canDelete=d&&h):""!==c&&c&&((a=a||this.getUserId())&&k&&(a=a+"@"+k),a.toLowerCase()!==c.toLowerCase()&&(f.canUpdate=b&&e,f.canDelete=d&&h));return f},getUserId:function(){var a;this.loaded&&(a=this.credential&&
this.credential.userId||this.userId||"");return a},setUserIsAdmin:function(a){this.userIsAdmin=a},setEditSummaryCallback:function(a){this.editSummaryCallback=a},getEditSummary:function(b,c,d){d=a.isDefined(d)?d:(new Date).getTime();var f="";d=this.getEditInfo(b,c,d);(c=c&&c.callback||this.editSummaryCallback)&&(d=c(b,d)||"");if(q.isString(d))f=d;else{if(d){b=d.action;c=d.userId;var g=d.timeValue,h=0;b&&h++;c&&h++;a.isDefined(g)&&h++;1<h&&(f=("edit"===b?"edit":"create")+(c?"User":"")+(a.isDefined(g)?
d.displayPattern:""))}f=f&&a.substitute(d,this.i18n.layers.FeatureLayer[f])}return f},getEditInfo:function(b,c,d){if(this.loaded){d=a.isDefined(d)?d:(new Date).getTime();c=c&&c.action||"last";var f=this.editFieldsInfo,g=f&&f.creatorField,h=f&&f.creationDateField,k=f&&f.editorField,f=f&&f.editDateField,k=(b=b&&b.attributes)&&k?b[k]:void 0,f=b&&f?b[f]:null,g=this._getEditData(b&&g?b[g]:void 0,b&&h?b[h]:null,d);d=this._getEditData(k,f,d);var e;switch(c){case "creation":e=g;break;case "edit":e=d;break;
case "last":e=d||g}e&&(e.action=e===d?"edit":"creation");return e}},_getEditData:function(b,c,d){var f,g,h;a.isDefined(c)&&(g=d-c,h=0>g?"Full":6E4>g?"Seconds":12E4>g?"Minute":36E5>g?"Minutes":72E5>g?"Hour":864E5>g?"Hours":6048E5>g?"WeekDay":"Full");if(void 0!==b||h)f=f||{},f.userId=b,h&&(b=p.format,d=new Date(c),f.minutes=Math.floor(g/6E4),f.hours=Math.floor(g/36E5),f.weekDay=b(d,{datePattern:"EEEE",selector:"date"}),f.formattedDate=b(d,{selector:"date"}),f.formattedTime=b(d,{selector:"time"}),f.displayPattern=
h,f.timeValue=c);return f},isEditable:function(){return!(!this._editable&&!this.userIsAdmin)},setMaxAllowableOffset:function(a){this.isEditable()||(this._maxOffset=a);return this},getMaxAllowableOffset:function(){return this._maxOffset},setAutoGeneralize:function(a){if(this.loaded){if(!this.isEditable()&&this.currentMode!==y.MODE_SNAPSHOT&&("esriGeometryPolyline"===this.geometryType||"esriGeometryPolygon"===this.geometryType))if(this._autoGeneralize=a){if((a=this._map)&&a.loaded)this._maxOffset=Math.floor(a.extent.getWidth()/
a.width)}else delete this._maxOffset}else this._optAutoGen=a;return this},setGDBVersion:function(a){if(!this._collection&&a!==this.gdbVersion&&(a||this.gdbVersion))this.gdbVersion=a,this._task.gdbVersion=a,this._url.query=q.mixin(this._url.query,{gdbVersion:a}),this.loaded&&(this.clearSelection(),this._map&&this.refresh()),this.onGDBVersionChange();return this},setDefinitionExpression:function(a){this._defnExpr=a;(a=this._mode)&&a.propertyChangeHandler(1);return this},getDefinitionExpression:function(){return this._defnExpr},
setTimeDefinition:function(a){this._isSnapshot?(this._timeDefn=a,(a=this._mode)&&a.propertyChangeHandler(2)):console.log("FeatureLayer.setTimeDefinition: layer in on-demand or selection mode does not support time definitions. Layer id \x3d "+this.id+", Layer URL \x3d "+this.url);return this},getTimeDefinition:function(){return this._timeDefn},setTimeOffset:function(a,b){this._timeOffset=a;this._timeOffsetUnits=b;var c=this._mode;c&&c.propertyChangeHandler(0);return this},setUseMapTime:function(a){this.useMapTime=
a;this._toggleTime(!this.suspended);(a=this._mode)&&a.propertyChangeHandler(0)},selectFeatures:function(a,b,c,f){b=b||y.SELECTION_NEW;a=this._getShallowClone(a);var g=this._map,h,k=this,e=v._fixDfd(new n(v._dfdCanceller));a.outFields=this.getOutFields();a.returnGeometry=!0;g&&(a.outSpatialReference=new t(g.spatialReference.toJson()));if(!this._applyQueryFilters(a,!0))return h={features:[]},this._selectHandler(h,b,c,f,e),e;if(g=this._canDoClientSideQuery(a))e._pendingDfd=d(this._doQuery(a,g)),e._pendingDfd.then(function(a){h=
{features:a};k._selectHandler(h,b,c,f,e)});else{if(this._collection)return this._resolve([Error("FeatureLayer::selectFeatures - "+this.invalidParams)],null,f,e,!0),e;var p=this;this._ts&&(a._ts=(new Date).getTime());(e._pendingDfd=this._task.execute(a)).addCallbacks(function(a){p._selectHandler(a,b,c,f,e)},function(a){p._resolve([a],null,f,e,!0)})}return e},getSelectedFeatures:function(){var a=this._selectedFeatures,b=[],c;for(c in a)a.hasOwnProperty(c)&&b.push(a[c]);return b},clearSelection:function(a){var b=
this._selectedFeatures,c=this._mode,d;for(d in b)b.hasOwnProperty(d)&&(this._unSelectFeatureIIf(d,c),c._removeFeatureIIf(d));this._selectedFeatures={};this._isSelOnly&&c._applyTimeFilter(!0);if(!a)this.onSelectionClear();return this},setSelectionSymbol:function(a){if(this._selectionSymbol=a){var b=this._selectedFeatures,c;for(c in b)b.hasOwnProperty(c)&&b[c].setSymbol(a)}return this},getSelectionSymbol:function(){return this._selectionSymbol},__msigns:[{n:"applyEdits",c:5,a:[{i:0},{i:1}],e:4,f:1}],
applyEdits:function(a,b,d,f,g,h){var k=h.assembly,e=h.dfd;this._applyNormalized(a,k&&k[0]);this._applyNormalized(b,k&&k[1]);this.onBeforeApplyEdits(a,b,d);var p={},r=this.objectIdField,k={f:"json"},n=!1;if(this._collection)h={},h.addResults=a?l.map(a,function(){n=!0;return{objectId:this._nextId++,success:!0}},this):null,h.updateResults=b?l.map(b,function(a){n=!0;var b=a.attributes[r];p[b]=a;return{objectId:b,success:!0}},this):null,h.deleteResults=d?l.map(d,function(a){n=!0;return{objectId:a.attributes[r],
success:!0}},this):null,n&&this._editHandler(h,a,p,f,g,e);else{a&&0<a.length&&(k.adds=this._convertFeaturesToJson(a,0,1),n=!0);if(b&&0<b.length){for(h=0;h<b.length;h++){var m=b[h];p[m.attributes[r]]=m}k.updates=this._convertFeaturesToJson(b,0,0,1);n=!0}if(d&&0<d.length){b=[];for(h=0;h<d.length;h++)b.push(d[h].attributes[r]);k.deletes=b.join(",");n=!0}if(n){var s=this;return c({url:this._url.path+"/applyEdits",content:q.mixin(k,this._url.query),callbackParamName:"callback",load:function(b){s._editHandler(b,
a,p,f,g,e)},error:function(a){s._resolve([a],null,g,e,!0)}},{usePost:!0})}}},queryFeatures:function(a,b,c){return this._query("execute","onQueryFeaturesComplete",a,b,c)},queryRelatedFeatures:function(a,b,c){return this._query("executeRelationshipQuery","onQueryRelatedFeaturesComplete",a,b,c)},queryIds:function(a,b,c){return this._query("executeForIds","onQueryIdsComplete",a,b,c)},queryCount:function(a,b,c){return this._query("executeForCount","onQueryCountComplete",a,b,c)},queryExtent:function(a,
b,c){return this._query("executeForExtent","onQueryExtentComplete",a,b,c)},queryAttachmentInfos:function(a,b,d){var f=this._url.path+"/"+a+"/attachments",g=new n(v._dfdCanceller),h=this;g._pendingDfd=c({url:f,content:q.mixin({f:"json"},this._url.query),callbackParamName:"callback",load:function(c){c=c.attachmentInfos;var d;l.forEach(c,function(b){d=k.objectToQuery({gdbVersion:h._url.query&&h._url.query.gdbVersion,layer:h._url.query&&h._url.query.layer,token:h._getToken()});b.url=f+"/"+b.id+(d?"?"+
d:"");b.objectId=a});h._resolve([c],"onQueryAttachmentInfosComplete",b,g)},error:function(a){h._resolve([a],null,d,g,!0)}});return g},addAttachment:function(a,b,c,d){return this._sendAttachment("add",a,b,c,d)},updateAttachment:function(a,b,c,d,f){c.appendChild(g.create("input",{type:"hidden",name:"attachmentId",value:b}));return this._sendAttachment("update",a,c,d,f)},deleteAttachments:function(a,b,d,f){var g=this._url.path+"/"+a+"/deleteAttachments",h=new n(v._dfdCanceller),k=this;b={f:"json",attachmentIds:b.join(",")};
h._pendingDfd=c({url:g,content:q.mixin(b,this._url.query),callbackParamName:"callback",load:q.hitch(this,function(b){b=b.deleteAttachmentResults;b=l.map(b,function(b){b=new M(b);b.attachmentId=b.objectId;b.objectId=a;return b});k._resolve([b],"onDeleteAttachmentsComplete",d,h)}),error:function(a){k._resolve([a],null,f,h,!0)}},{usePost:!0});return h},addType:function(a){var b=this.types;if(b){if(l.some(b,function(b){return b.id==a.id?!0:!1}))return!1;b.push(a)}else this.types=[a];return this._typesDirty=
!0},deleteType:function(a){if(this._collection){var b=this.types;if(b){var c=-1;l.some(b,function(b,d){return b.id==a?(c=d,!0):!1});if(-1<c)return this._typesDirty=!0,b.splice(c,1)[0]}}},toJson:function(){var a=this._json;if(a=q.isString(a)?s.fromJson(a):q.clone(a)){var a=a.layerDefinition?a:{layerDefinition:a},b=a.layerDefinition,c=this._collection;if(c&&this._typesDirty){b.types=l.map(this.types||[],function(a){return a.toJson()});var d=this.renderer,f=b.drawingInfo;d&&!f&&(f=b.drawingInfo={});
f&&(d&&-1===d.declaredClass.indexOf("TemporalRenderer"))&&(f.renderer=d.toJson())}d=null;if(!c||this._fcAdded)d={geometryType:b.geometryType,features:this._convertFeaturesToJson(this.graphics,!0)};a.featureSet=q.mixin({},a.featureSet||{},d);c&&(a.nextObjectId=this._nextId,b.capabilities=this.capabilities);return a}},onSelectionComplete:function(){},onSelectionClear:function(){},onBeforeApplyEdits:function(){},onEditsComplete:function(){},onQueryFeaturesComplete:function(){},onQueryRelatedFeaturesComplete:function(){},
onQueryIdsComplete:function(){},onQueryCountComplete:function(){},onQueryExtentComplete:function(){},onQueryAttachmentInfosComplete:function(){},onAddAttachmentComplete:function(){},onUpdateAttachmentComplete:function(){},onDeleteAttachmentsComplete:function(){},onCapabilitiesChange:function(){},onGDBVersionChange:function(){},onQueryLimitExceeded:function(){},_forceIdentity:function(a){var c=this,d=this._url&&this._url.path;(this.ownershipBasedAccessControlForFeatures||this.userIsAdmin)&&!this._getToken()&&
d&&b.id&&b.id._hasPortalSession()&&b.id._doPortalSignIn(d)?b.id.getCredential(d).then(function(){c._findCredential();a.call(c)},function(){a.call(c)}):a.call(this)},_checkMode:function(a){var b=this.geometryType,c=this.maxRecordCount;a=(a=a&&a.features&&a.features[0])&&a.attributes&&a.attributes.exceedslimit;if(this.mode===y.MODE_AUTO&&!this.isEditable()&&0===a&&(this.queryPagination||("esriGeometryPolyline"===b||"esriGeometryPolygon"===b||"esriGeometryMultipoint"===b)&&c>=this.maxRecordCountForAuto||
"esriGeometryPoint"===b&&c>=this.maxPointCountForAuto))this.currentMode=y.MODE_SNAPSHOT,this._mode=new S(this),this._isSnapshot=!0,this._autoGeneralize=!1},_queryLimit:function(){var a=this,b=new n;this._limitPromise=b.promise;setTimeout(function(){var c=new O,d=new x;d.statisticType="exceedslimit";d.maxPointCount=a.maxPointCountForAuto;d.maxRecordCount=a.maxRecordCountForAuto;d.maxVertexCount=a.maxVertexCountForAuto;d.outStatisticFieldName="exceedslimit";c.outStatistics=[d];a.queryFeatures(c).promise.then(function(a){b.resolve(a)},
function(a){b.reject(a)})},0)},_updateCaps:function(){var a=this._editable,b=q.trim(this.capabilities||""),c=l.map(b?b.split(","):[],q.trim),d=l.map(b?b.toLowerCase().split(","):[],q.trim),b=l.indexOf(d,"editing"),f,d={Create:l.indexOf(d,"create"),Update:l.indexOf(d,"update"),Delete:l.indexOf(d,"delete")};if(a&&-1===b)c.push("Editing");else if(!a&&-1<b){a=[b];for(f in d)-1<d[f]&&a.push(d[f]);a.sort();for(f=a.length-1;0<=f;f--)c.splice(a[f],1)}this.capabilities=c.join(",")},_counter:{value:0},_getUniqueId:function(){return this._counter.value++},
onSuspend:function(){this.inherited(arguments);this._toggleTime(!1);var a=this._mode;a&&a.suspend()},onResume:function(a){this.inherited(arguments);this._toggleTime(!0);this._updateMaxOffset();var b=this._mode,c=this._map,d=this._getRenderer();if(a.firstOccurrence){this._fixRendererFields();this._checkFields();this.clearSelection();if(this.timeInfo&&(this._trackIdField||d&&(d.latestObservationRenderer||d.trackRenderer)))this._trackManager=new ja(this),this._trackManager.initialize(c);if(this.mode===
y.MODE_AUTO&&this.currentMode===y.MODE_SNAPSHOT&&("esriGeometryPolyline"===this.geometryType||"esriGeometryPolygon"===this.geometryType)&&!this.getMaxAllowableOffset())d=this.generalizeForScale,d=this.maxScale?this.maxScale:this.minScale?Math.min(d,this.minScale):Math.min(d,E.getScale(c,this.initialExtent)),this.setMaxAllowableOffset(c.extent.getWidth()/c.width/c.getScale()*d);this._zoomConnect=e.connect(c,"onZoomEnd",this,this._updateMaxOffset)}b&&(a.firstOccurrence?b.startup():b.resume())},_updateMaxOffset:function(){var a=
this._map;a&&a.loaded&&this._autoGeneralize&&(this._maxOffset=Math.floor(a.extent.getWidth()/a.width))},_toggleTime:function(a){var b=this._map;a&&this.timeInfo&&this.useMapTime&&b?(this._mapTimeExtent=b.timeExtent,this._timeConnect||(this._timeConnect=e.connect(b,"onTimeExtentChange",this,this._timeChangeHandler))):(this._mapTimeExtent=null,e.disconnect(this._timeConnect),this._timeConnect=null)},_timeChangeHandler:function(a){this._mapTimeExtent=a;(a=this._mode)&&a.propertyChangeHandler(0)},_getOffsettedTE:function(a){var b=
this._timeOffset,c=this._timeOffsetUnits;return a&&b&&c?a.offset(-1*b,c):a},_getTimeOverlap:function(a,b){return a&&b?a.intersection(b):a||b},_getTimeFilter:function(a){var b=this.getTimeDefinition(),c;if(b&&(c=this._getTimeOverlap(b,null),!c))return[!1];if(a){if(a=c?this._getTimeOverlap(a,c):a,!a)return[!1]}else a=c;return[!0,a]},_getAttributeFilter:function(a){var b=this.getDefinitionExpression();return a?b?"("+b+") AND ("+a+")":a:b},_applyQueryFilters:function(a,b){a.where=this._getAttributeFilter(a.where);
a.maxAllowableOffset=this._maxOffset;b&&this.supportsAdvancedQueries&&(a.orderByFields=a.orderByFields||this.getOrderByFields());if(this.timeInfo){var c=this._getTimeFilter(a.timeExtent);if(c[0])a.timeExtent=c[1];else return!1}return!0},_add:function(a){var b=this._selectionSymbol,c=a.attributes,d=this.visibilityField;b&&this._isSelOnly&&a.setSymbol(b);if(d&&c&&c.hasOwnProperty(d))a[c[d]?"show":"hide"]();return this.add.apply(this,arguments)},_remove:function(){return this.remove.apply(this,arguments)},
_canDoClientSideQuery:function(a){var b=[],c=this._map;if(!(this._isTable||!c&&!this._collection))if(!a.text&&!(a.where&&a.where!==this.getDefinitionExpression()||a.orderByFields&&a.orderByFields.length||a.outStatistics)){var d=this._isSnapshot,f=this._isSelOnly,g=a.geometry;if(g)if(!f&&a.spatialRelationship===O.SPATIAL_REL_INTERSECTS&&"extent"===g.type&&(d||c.extent.contains(g)))b.push(1);else return;if(c=a.objectIds)if(d)b.push(2);else{var g=c.length,h=this._mode,k=0,e;for(e=0;e<g;e++)h._getFeature(c[e])&&
k++;if(k===g)b.push(2);else return}if(this.timeInfo)if(a=a.timeExtent,c=this._mapTimeExtent,d)a&&b.push(3);else if(f){if(a)return}else if(c)if(-1!==l.indexOf(b,2))a&&b.push(3);else return;else if(0<b.length)a&&b.push(3);else if(a)return;return 0<b.length?b:null}},_doQuery:function(a,b,c){var d=[],f=this._mode,g=this.objectIdField,h=this,k,e,p=new n,r=new n,m=function(a,b){if(!a.length||!b.length)return a.length?a:b;var c,d,f={};a.length>b.length?(d=a,c=b):(d=b,c=a);for(var h=d.length,k=c.length,e;h--;)e=
d[h],f[e.attributes[g]]=!0;for(;k--;)e=c[k],f[e.attributes[g]]||d.push(e);return d};if(-1!==l.indexOf(b,1)){e=this.graphics;k=e.length;var s=this.spatialIndex||this._map&&this._map.spatialIndex,t,u=a.geometry._normalize(null,!0);null==s&&ka.autoSpatialIndexing?t=(this._map||this).addPlugin("esri/plugins/spatialIndex").then(q.hitch(this,q.partial(this._getFromIndex,u,s)),function(a){r.resolve(q.hitch(this,q.partial(this._filterByExtent,e,u)))}):s&&(t=this._getFromIndex(u,s));t?t.then(function(a){for(var b=
0;b<a.length;b++)a[b].results&&(d=d.concat(a[b].results));r.resolve(d)}).otherwise(function(a){r.reject(a)}):r.resolve(this._filterByExtent(e,u))}else r.resolve([]);r.then(function(d){var e=[];if(-1!==l.indexOf(b,2)){var r=a.objectIds;for(k=r.length;k--;){var n=f._getFeature(r[k]);n&&e.push(n)}e=m(d,e)}else e=d;-1!==l.indexOf(b,3)&&this.timeInfo&&(d=a.timeExtent,e=h._filterByTime(e,d.startTime,d.endTime).match);c&&(e=l.map(e,function(a){return a.attributes[g]},this));p.resolve(e)});return p},_getFromIndex:function(a,
b){b=b||this.spatialIndex||this._map.spatialIndex;a instanceof Array||(a=[a]);var c=this.id;return f(l.map(a,function(a){return b.intersects(a,c)}))},_filterByExtent:function(a,b){for(var c=[],d=0,f=a.length;d<f;d++){var g=a[d],h=g.geometry;h&&(this.normalization&&b.length?(b[0].intersects(h)||b[1].intersects(h))&&c.push(g):b.intersects(h)&&c.push(g))}return c},_filterByTime:function(b,c,d){var f=this._startTimeField,g=this._endTimeField,h;this._twoTimeFields||(h=f||g);var k=a.isDefined,e=[],p=[],
l,r=b.length,n,m;c=c?c.getTime():-Infinity;d=d?d.getTime():Infinity;if(h)for(l=0;l<r;l++)n=b[l],m=n.attributes,f=m[h],f>=c&&f<=d?e.push(n):p.push(n);else for(l=0;l<r;l++)n=b[l],m=n.attributes,h=m[f],m=m[g],h=k(h)?h:-Infinity,m=k(m)?m:Infinity,h>=c&&h<=d||m>=c&&m<=d||c>=h&&d<=m?e.push(n):p.push(n);return{match:e,noMatch:p}},_resolve:function(a,b,c,d,f){b&&this[b].apply(this,a);c&&c.apply(null,a);d&&v._resDfd(d,a,f)},_getShallowClone:function(a){var b=new O,c;for(c in a)a.hasOwnProperty(c)&&(b[c]=a[c]);
return b},_query:function(a,b,c,f,g){var h=this,k=this._map,e=new n(v._dfdCanceller),p=c,l=function(c,d){if(!d&&"execute"===a&&!h._isTable){var g=c.features,k=h._mode,p=h.objectIdField,l;for(l=g.length-1;0<=l;l--){var r=k._getFeature(g[l].attributes[p]);r&&g.splice(l,1,r)}}h._resolve([c],b,f,e)};if("executeRelationshipQuery"!==a){p=this._getShallowClone(c);p.outFields=this.getOutFields();p.returnGeometry=c.hasOwnProperty("returnGeometry")?c.returnGeometry:!c.outStatistics;var r;k&&(p.outSpatialReference=
new t(k.spatialReference.toJson()));if(!this._applyQueryFilters(p,"execute"===a)){switch(a){case "execute":r=new P({features:[]});break;case "executeForIds":r=[];break;case "executeForCount":r=0;break;case "executeForExtent":r={}}l(r,!0);return e}if(c="executeForExtent"!==a&&this._canDoClientSideQuery(p))return e._pendingDfd=d(this._doQuery(p,c,"executeForIds"===a||"executeForCount"===a)),e._pendingDfd.then(function(b){switch(a){case "execute":r=new P;r.features=b;break;case "executeForIds":r=b;break;
case "executeForCount":r=b.length}l(r,!0)}),e}if(this._collection)return this._resolve([Error("FeatureLayer::_query - "+this.invalidParams)],null,g,e,!0),e;this._ts&&(p._ts=(new Date).getTime());(e._pendingDfd=this._task[a](p)).addCallbacks(l,function(a){h._resolve([a],null,g,e,!0)});return e},_convertFeaturesToJson:function(a,b,c,d){var f=[],g=this._selectionSymbol,h=this.visibilityField,k,e=this.objectIdField;if(this.loaded&&(c||d))k=l.filter(this.fields,function(a){return!1===a.editable&&(!d||
a.name!==e)});for(c=0;c<a.length;c++){var p=a[c],r={},n=p.geometry,m=p.attributes,t=p.symbol;if(n&&(!d||!this.loaded||this.allowGeometryUpdates))r.geometry=n.toJson();h?(r.attributes=m=q.mixin({},m),m[h]=p.visible?1:0):m&&(r.attributes=q.mixin({},m));r.attributes&&(k&&k.length)&&l.forEach(k,function(a){delete r.attributes[a.name]});t&&t!==g&&(r.symbol=t.toJson());f.push(r)}return b?f:s.toJson(f)},_selectHandler:function(a,b,c,d,f){var g;d=y;switch(b){case d.SELECTION_NEW:this.clearSelection(!0);g=
!0;break;case d.SELECTION_ADD:g=!0;break;case d.SELECTION_SUBTRACT:g=!1}d=a.features;var h=this._mode,k=[],e=this.objectIdField,p,r;if(g)for(g=0;g<d.length;g++)p=d[g],r=p.attributes[e],p=h._addFeatureIIf(r,p),k.push(p),this._selectFeatureIIf(r,p,h);else for(g=0;g<d.length;g++)p=d[g],r=p.attributes[e],this._unSelectFeatureIIf(r,h),r=h._removeFeatureIIf(r),k.push(r||p);this._isSelOnly&&h._applyTimeFilter(!0);this._resolve([k,b,a.exceededTransferLimit?{queryLimitExceeded:!0}:null],"onSelectionComplete",
c,f);if(a.exceededTransferLimit)this.onQueryLimitExceeded()},_selectFeatureIIf:function(a,b,c){var d=this._selectedFeatures,f=d[a];f||(c._incRefCount(a),d[a]=b,this._isTable||(this._setSelectSymbol(b),b.attr("data-selected","")));return f||b},_unSelectFeatureIIf:function(a,b){var c=this._selectedFeatures[a];c&&(b._decRefCount(a),delete this._selectedFeatures[a],this._isTable||(this._setUnSelectSymbol(c),c.attr("data-selected")));return c},_isSelected:function(a){},_setSelectSymbol:function(a){var b=
this._selectionSymbol;b&&!this._isSelOnly&&a.setSymbol(b)},_setUnSelectSymbol:function(a){var b=this._selectionSymbol;b&&!this._isSelOnly&&b===a.symbol&&a.setSymbol(null,!0)},_getOutFields:function(){var a=[this.objectIdField,this.typeIdField,this.creatorField,this._startTimeField,this._endTimeField,this._trackIdField].concat(this._rendererFields).concat(this.dataAttributes),a=l.filter(a,function(a,b,c){return!!a&&l.indexOf(c,a)===b}),b=q.clone(this._outFields);if(b){if(-1!==l.indexOf(b,"*"))return b;
l.forEach(a,function(a){-1===l.indexOf(b,a)&&b.push(a)});return b}return a},_checkFields:function(b){var c=b||this._getOutFields();l.forEach(c,function(b){"*"!==b&&(this._getField(b)||console.debug("esri.layers.FeatureLayer: "+a.substitute({url:this.url,field:b},"unable to find '${field}' field in the layer 'fields' information [url: ${url}]")))},this);!b&&(!this._isTable&&!this._fserver&&!this._collection)&&(l.some(this.fields,function(a){return a&&"esriFieldTypeGeometry"===a.type?!0:!1})||console.debug("esri.layers.FeatureLayer: "+
a.substitute({url:this.url},"unable to find a field of type 'esriFieldTypeGeometry' in the layer 'fields' information. If you are using a map service layer, features will not have geometry [url: ${url}]")))},_fixLabelExpr:function(){var a=/\[([^\[\]]+)\]/ig,b,c=this,d=function(a,b){var d=c._getField(b,!0);return"["+(d&&d.name||b)+"]"};l.forEach(this.labelingInfo,function(c){if(b=c.labelExpression)c.labelExpression=b.replace(a,d)})},_fixRendererFields:function(){var b=this.renderer;this._orderBy=null;
if(b&&0<this.fields.length){var c=[],d,f,b=l.filter([b,b.observationRenderer,b.latestObservationRenderer,b.trackRenderer],a.isDefined),g=[].concat(b);l.forEach(b,function(a){l.forEach(a.rendererInfos,function(a){a.renderer&&g.push(a.renderer)})});l.forEach(g,function(a){if((f=a.attributeField)&&!q.isFunction(f))if(d=!this._getField(f)&&this._getField(f,!0))a.attributeField=d.name;if(f=a.attributeField2)if(d=!this._getField(f)&&this._getField(f,!0))a.attributeField2=d.name;if(f=a.attributeField3)if(d=
!this._getField(f)&&this._getField(f,!0))a.attributeField3=d.name;q.isFunction(a.attributeField)||c.push(a.attributeField);c.push(a.attributeField2);c.push(a.attributeField3);if((f=a.rotationInfo&&a.rotationInfo.field)&&!q.isFunction(f)){if(d=!this._getField(f)&&this._getField(f,!0))f=a.rotationInfo.field=d.name;c.push(f)}if(a.proportionalSymbolInfo){if((f=a.proportionalSymbolInfo.field)&&!q.isFunction(f)){if(d=!this._getField(f)&&this._getField(f,!0))f=a.proportionalSymbolInfo.field=d.name;c.push(f);
this._orderBy||(this._orderBy=[f+" DESC"])}if((f=a.proportionalSymbolInfo.normalizationField)&&!q.isFunction(f)){if(d=!this._getField(f)&&this._getField(f,!0))f=a.proportionalSymbolInfo.normalizationField=d.name;c.push(f)}}if(a.colorInfo){if((f=a.colorInfo.field)&&!q.isFunction(f)){if(d=!this._getField(f)&&this._getField(f,!0))f=a.colorInfo.field=d.name;c.push(f)}if((f=a.colorInfo.normalizationField)&&!q.isFunction(f)){if(d=!this._getField(f)&&this._getField(f,!0))f=a.colorInfo.normalizationField=
d.name;c.push(f)}}if(!this._orderBy&&a.addBreak&&!q.isFunction(a.attributeField)&&(a.backgroundFillSymbol||this._hasSizeDiff(a)))this._orderBy=[a.attributeField+" DESC"]},this);this._rendererFields=l.filter(c,a.isDefined)}},_hasSizeDiff:function(a){var b=Number.MAX_VALUE,c=-Number.MAX_VALUE,d,f;l.forEach(a.infos,function(a){if(f=a.symbol){d=0;switch(f.type){case "simplemarkersymbol":d=f.size;break;case "picturemarkersymbol":d=(f.width+f.height)/2;break;case "simplelinesymbol":case "cartographiclinesymbol":d=
f.width;break;case "simplefillsymbol":case "picturefillsymbol":d=f.outline&&f.outline.width}d&&(b=Math.min(b,d),c=Math.max(c,d))}});return b!==Number.MAX_VALUE&&c!==-Number.MAX_VALUE&&1<Math.abs(c-b)},getOrderByFields:function(){var a=this.orderByFields||this._orderBy;return this.supportsAdvancedQueries&&a?l.filter(a,function(a){a=a.split(" ")[0];return!!this._getField(a,!0)},this):null},_getField:function(a,b){var c=this.fields;if(!c||0===c.length)return null;var d;b&&(a=a.toLowerCase());l.some(c,
function(c){var f=!1;(f=b?c&&c.name.toLowerCase()===a?!0:!1:c&&c.name===a?!0:!1)&&(d=c);return f});return d},_getDateOpts:function(){this._dtOpts||(this._dtOpts={properties:l.map(l.filter(this.fields,function(a){return!!(a&&"esriFieldTypeDate"===a.type)}),function(a){return a.name})});return this._dtOpts},_applyNormalized:function(a,b){a&&b&&l.forEach(a,function(a,c){a&&b[c]&&a.setGeometry(b[c])})},_editHandler:function(a,b,c,d,f,g){f=a.addResults;var h=a.updateResults;a=a.deleteResults;var k,e,p,
r,n=this.objectIdField,m=this._mode,q=this._isTable;k=this.editFieldsInfo;var s=this.getOutFields()||[],t=k&&k.creatorField,u=k&&k.creationDateField,x=k&&k.editorField,z=k&&k.editDateField;k=k&&k.realm;-1===l.indexOf(s,"*")&&(t&&-1===l.indexOf(s,t)&&(t=null),u&&-1===l.indexOf(s,u)&&(u=null),x&&-1===l.indexOf(s,x)&&(x=null),z&&-1===l.indexOf(s,z)&&(z=null));var s=u||z?(new Date).getTime():null,B=t||x?this.getUserId():void 0;B&&k&&(B=B+"@"+k);if(f)for(k=0;k<f.length;k++)f[k]=new M(f[k]),q||(e=f[k],
e.success&&(e=e.objectId,p=b[k],(r=p._graphicsLayer)&&r!==this&&r.remove(p),r=p.attributes||{},r[n]=e,t&&(r[t]=B),x&&(r[x]=B),u&&(r[u]=s),z&&(r[z]=s),p.setAttributes(r),m._init&&m.drawFeature(p)));if(h)for(k=0;k<h.length;k++)if(h[k]=new M(h[k]),!q&&(e=h[k],e.success)){e=e.objectId;p=c[e];if(b=m._getFeature(e))b.geometry!==p.geometry&&b.setGeometry(R.fromJson(p.geometry.toJson())),this._repaint(b,e);p=b||p;r=p.attributes||{};x&&(r[x]=B);z&&(r[z]=s);p.setAttributes(r)}if(a){c=[];for(k=0;k<a.length;k++)if(a[k]=
new M(a[k]),!q&&(e=a[k],e.success&&(e=e.objectId,p=m._getFeature(e))))this._unSelectFeatureIIf(e,m)&&c.push(p),p._count=0,m._removeFeatureIIf(e);if(0<c.length)this.onSelectionComplete(c,y.SELECTION_SUBTRACT)}this._resolve([f,h,a],"onEditsComplete",d,g)},_sendAttachment:function(a,b,d,f,g){var h=this;return c({url:this._url.path+"/"+b+"/"+("add"===a?"addAttachment":"updateAttachment"),form:d,content:q.mixin(this._url.query,{f:"json",token:this._getToken()||void 0}),callbackParamName:"callback.html",
handleAs:"json"}).addCallback(function(c){var d="add"===a?"onAddAttachmentComplete":"onUpdateAttachmentComplete";c=new M(c["add"===a?"addAttachmentResult":"updateAttachmentResult"]);c.attachmentId=c.objectId;c.objectId=b;h._resolve([c],d,f);return c}).addErrback(function(a){h._resolve([a],null,g,null,!0)})},_repaint:function(b,c,d){c=a.isDefined(c)?c:b.attributes[this.objectIdField];(!(c in this._selectedFeatures)||!this._selectionSymbol)&&b.setSymbol(b.symbol,d)},_getKind:function(a){var b=this._trackManager;
return b?b.isLatestObservation(a)?1:0:0}});q.mixin(y,{MODE_SNAPSHOT:0,MODE_ONDEMAND:1,MODE_SELECTION:2,SELECTION_NEW:3,SELECTION_ADD:4,SELECTION_SUBTRACT:5,MODE_AUTO:6,POPUP_NONE:"esriServerHTMLPopupTypeNone",POPUP_HTML_TEXT:"esriServerHTMLPopupTypeAsHTMLText",POPUP_URL:"esriServerHTMLPopupTypeAsURL"});ba._createWrappers(y);r("extend-esri")&&q.setObject("layers.FeatureLayer",y,b);return y})},"esri/layers/CSVLayer":function(){define("dojo/_base/array dojo/_base/declare dojo/_base/lang dojo/has esri/kernel esri/arcgis/csv esri/layers/FeatureLayer esri/geometry/Extent esri/tasks/FeatureSet".split(" "),
function(m,e,q,l,s,n,p,r,k){e=e(p,{declaredClass:"esri.layers.CSVLayer",_preventInit:!0,_fieldTypeMap:{Date:"esriFieldTypeDate",Number:"esriFieldTypeDouble",String:"esriFieldTypeString"},constructor:function(g,h){this.url=g;h=q.mixin(h,{outFields:["*"]});this.columnDelimiter=h.columnDelimiter;this.latitudeFieldName=h.latitudeFieldName;this.longitudeFieldName=h.longitudeFieldName;var d=h.layerDefinition;d||(d={fields:h.fields||[],geometryType:"esriGeometryPoint",copyrightText:h.copyright},h.fields&&
m.forEach(h.fields,q.hitch(this,function(d){d.type=this._fieldTypeMap[d.type||"String"];d.alias||(d.alias=d.name)})));this._buildCsvFcParam={url:this.url,columnDelimiter:this.columnDelimiter,layerDefinition:d};this.latitudeFieldName&&this.longitudeFieldName&&(this._buildCsvFcParam.locationInfo={locationType:"coordinates",latitudeFieldName:this.latitudeFieldName,longitudeFieldName:this.longitudeFieldName});this._projectFeatures=q.hitch(this,this._projectFeatures);this._addFeatures=q.hitch(this,this._addFeatures);
this._initCSVLayer(h)},refresh:function(){this._fireUpdateStart();this.applyEdits(null,null,this.graphics);this._loadFeatures()},_setMap:function(g){var h=this.inherited(arguments);this._fireUpdateStart();this._projectFeatures(this._csvFC).then(this._addFeatures).otherwise(this._errorHandler);this._csvFC=null;return h},_initCSVLayer:function(g){var h=this;n.buildCSVFeatureCollection(this._buildCsvFcParam).then(function(d){h._csvFC=d;var f=d.layerDefinition;f.extent=h._getFCExtent(d);h._initFeatureLayer({layerDefinition:f},
g)}).otherwise(this._errorHandler)},_loadFeatures:function(){n.buildCSVFeatureCollection(this._buildCsvFcParam).then(this._projectFeatures).then(this._addFeatures).otherwise(this._errorHandler)},_projectFeatures:function(g){return n.projectFeatureCollection(g,this._map.spatialReference)},_addFeatures:function(g){g=new k(g.featureSet);this.applyEdits(g.features,null,null);this._fireUpdateEnd()},_getFCExtent:function(g){var h;if(g&&g.featureSet&&g.featureSet.features){g=g.featureSet.features;var d=
g.length;if(1<d){var f=g[0].geometry;h=new r(f.x,f.y,f.x,f.y);for(d-=1;0<d;d--)f=g[d].geometry,h.xmin=Math.min(h.xmin,f.x),h.ymin=Math.min(h.ymin,f.y),h.xmax=Math.max(h.xmax,f.x),h.ymax=Math.max(h.ymax,f.y);0>=h.getWidth()&&0>=h.getHeight()&&(h=null)}}return h}});l("extend-esri")&&q.setObject("layers.CSVLayer",e,s);return e})},"dojo/DeferredList":function(){define(["./_base/kernel","./_base/Deferred","./_base/array"],function(m,e,q){m.DeferredList=function(l,m,n,p,r){var k=[];e.call(this);var g=this;
0===l.length&&!m&&this.resolve([0,[]]);var h=0;q.forEach(l,function(d,f){function b(a,b){k[f]=[a,b];h++;h===l.length&&g.resolve(k)}d.then(function(a){m?g.resolve([f,a]):b(!0,a)},function(a){n?g.reject(a):b(!1,a);if(p)return null;throw a;})})};m.DeferredList.prototype=new e;m.DeferredList.prototype.gatherResults=function(e){e=new m.DeferredList(e,!1,!0,!1);e.addCallback(function(e){var l=[];q.forEach(e,function(e){l.push(e[1])});return l});return e};return m.DeferredList})},"esri/layers/KMLFolder":function(){define(["dojo/_base/declare",
"dojo/_base/lang","dojo/has","esri/kernel","esri/lang"],function(m,e,q,l,s){m=m(null,{declaredClass:"esri.layers.KMLFolder",constructor:function(l){e.mixin(this,l);s.isDefined(this.visibility)&&(this.visible=!!this.visibility)}});q("extend-esri")&&e.setObject("layers.KMLFolder",m,l);return m})},"esri/layers/TrackManager":function(){define("dojo/_base/declare dojo/_base/lang dojo/_base/array dojo/has esri/kernel esri/graphic esri/geometry/Polyline esri/layers/GraphicsLayer".split(" "),function(m,e,
q,l,s,n,p,r){m=m(null,{declaredClass:"esri.layers._TrackManager",constructor:function(k){this.layer=k;this.trackMap={}},initialize:function(k){this.map=k;var g=this.layer,h=g._getRenderer(),h=h&&h.trackRenderer;if("esriGeometryPoint"===g.geometryType){var d=this.container=new r._GraphicsLayer({id:g.id+"_tracks",_child:!0});d.loaded=!0;d.onLoad(d);d._setMap(k,g._div);d.setRenderer(h)}},addFeatures:function(k){var g,h=this.trackMap,d=this.layer,f=d._trackIdField,b,a;q.forEach(k,function(c){b=c.attributes;
g=b[f];a=h[g]=h[g]||[];a.push(c)});var c=d._startTimeField,e=d.objectIdField;k=function(a,b){var d=a.attributes[c],f=b.attributes[c];return d===f?a.attributes[e]<b.attributes[e]?-1:1:d<f?-1:1};for(g in h)h[g].sort(k)},drawTracks:function(){var k=this.container;if(k){var g=this.trackMap,h=this.map.spatialReference,d,f,b,a,c,e=this.layer._trackIdField;for(d in g){f=g[d];b=[];for(a=f.length-1;0<=a;a--)(c=f[a].geometry)&&b.push([c.x,c.y]);f={};f[e]=d;0<b.length&&k.add(new n(new p({paths:[b],spatialReference:h}),
null,f))}}},moveLatestToFront:function(){q.forEach(this.getLatestObservations(),function(k){var g=k._shape;g&&g._moveToFront();this._repaint(k,null,!0)},this.layer)},getLatestObservations:function(){var k=[],g=this.layer._getRenderer(),h=this.trackMap,d;if(!g.latestObservationRenderer)return k;for(d in h)g=h[d],k.push(g[g.length-1]);return k},clearTracks:function(){var k=this.getLatestObservations();this.trackMap={};var g=this.container;g&&g.clear();q.forEach(k,function(g){this._repaint(g,null,!0)},
this.layer)},isLatestObservation:function(k){var g=this.trackMap[k.attributes[this.layer._trackIdField]];return g?g[g.length-1]===k:!1},destroy:function(){var k=this.container;k&&(k.clear(),k._unsetMap(this.map,this.layer._div));this.map=this.layer=this.trackMap=this.container=null}});l("extend-esri")&&e.setObject("layers._TrackManager",m,s);return m})},"esri/layers/WMSLayer":function(){define("require dojo/_base/kernel dojo/_base/declare dojo/_base/lang dojo/_base/array dojo/has esri/kernel esri/request esri/urlUtils esri/SpatialReference esri/geometry/Extent esri/layers/DynamicMapServiceLayer esri/layers/WMSLayerInfo dojo/query".split(" "),
function(m,e,q,l,s,n,p,r,k,g,h,d,f){q=q([d],{declaredClass:"esri.layers.WMSLayer",_CRS_TO_EPSG:{84:4326,83:4269,27:4267},_REVERSED_LAT_LONG_RANGES:[[4001,4999],[2044,2045],[2081,2083],[2085,2086],[2093,2093],[2096,2098],[2105,2132],[2169,2170],[2176,2180],[2193,2193],[2200,2200],[2206,2212],[2319,2319],[2320,2462],[2523,2549],[2551,2735],[2738,2758],[2935,2941],[2953,2953],[3006,3030],[3034,3035],[3058,3059],[3068,3068],[3114,3118],[3126,3138],[3300,3301],[3328,3335],[3346,3346],[3350,3352],[3366,
3366],[3416,3416],[20004,20032],[20064,20092],[21413,21423],[21473,21483],[21896,21899],[22171,22177],[22181,22187],[22191,22197],[25884,25884],[27205,27232],[27391,27398],[27492,27492],[28402,28432],[28462,28492],[30161,30179],[30800,30800],[31251,31259],[31275,31279],[31281,31290],[31466,31700]],_WEB_MERCATOR:[102100,3857,102113,900913],_WORLD_MERCATOR:[3395,54004],allExtents:[],constructor:function(b,a){this.url=b=this._stripParameters(b,"version service request bbox format height width layers srs crs styles transparent bgcolor exceptions time elevation sld wfs".split(" "));
this._url=k.urlToObject(b);this._getCapabilitiesURL=b;this._initLayer=l.hitch(this,this._initLayer);this._parseCapabilities=l.hitch(this,this._parseCapabilities);this._getCapabilitiesError=l.hitch(this,this._getCapabilitiesError);a?(this.imageFormat=this._getImageFormat(a.format),this.imageTransparency=!1===a.transparent?!1:!0,this.visibleLayers=a.visibleLayers?a.visibleLayers:[],a.resourceInfo?this._readResourceInfo(a.resourceInfo):this._getCapabilities()):(this.imageFormat="image/png",this.imageTransparency=
!0,this.visibleLayers=[],this._getCapabilities());this._blankImageURL=m.toUrl("esri/layers")+"/../images/pixel.png"},setVisibleLayers:function(b){this.visibleLayers=(b=this._checkVisibleLayersList(b))?b:[];this.refresh(!0)},setImageFormat:function(b){this.imageFormat=this._getImageFormat(b);this.refresh(!0)},setImageTransparency:function(b){this.imageTransparency=b;this.refresh(!0)},getImageUrl:function(b,a,c,d){if(!this.visibleLayers||0===this.visibleLayers.length)d(this._blankImageURL);else{var f=
b.spatialReference.wkid;if(s.some(this._WEB_MERCATOR,function(a){return a==f})){var g=s.filter(this.spatialReferences,function(a){return s.some(this._WEB_MERCATOR,function(b){return b==a})},this);0==g.length&&(g=s.filter(this.spatialReferences,function(a){return s.some(this._WORLD_MERCATOR,function(b){return b==a})},this));f=0<g.length?g[0]:this._WEB_MERCATOR[0]}this.spatialReferences=s.filter(this.spatialReferences,function(a){return a!==f});this.spatialReferences.unshift(f);var g=b.xmin,h=b.xmax,
e=b.ymin,p=b.ymax;b={SERVICE:"WMS",REQUEST:"GetMap"};b.FORMAT=this.imageFormat;b.TRANSPARENT=this.imageTransparency?"TRUE":"FALSE";b.STYLES="";b.VERSION=this.version;b.LAYERS=this.visibleLayers?this.visibleLayers.toString():null;b.WIDTH=a;b.HEIGHT=c;this.maxWidth<a&&(b.WIDTH=this.maxWidth);this.maxHeight<c&&(b.HEIGHT=this.maxHeight);a=f?f:NaN;isNaN(a)||("1.3.0"==this.version?b.CRS="EPSG:"+a:b.SRS="EPSG:"+a);"1.3.0"==this.version&&this._useLatLong(a)?b.BBOX=e+","+g+","+p+","+h:b.BBOX=g+","+e+","+h+
","+p;a=this.getMapURL;var r;a+=-1==a.indexOf("?")?"?":"";for(r in b)a+="?"==a.substring(a.length-1,a.length)?"":"\x26",a+=r+"\x3d"+b[r];d(k.addProxy(a))}},_initLayer:function(b,a){this.spatialReference=new g(this.extent.spatialReference);this.initialExtent=new h(this.extent);this.fullExtent=new h(this.extent);this.visibleLayers=this._checkVisibleLayersList(this.visibleLayers);this.loaded=!0;this.onLoad(this);var c=this._loadCallback;c&&(delete this._loadCallback,c(this))},_readResourceInfo:function(b){b.extent?
b.layerInfos?(this.extent=b.extent,this.allExtents[0]=b.extent,this.layerInfos=b.layerInfos,this.description=b.description?b.description:"",this.copyright=b.copyright?b.copyright:"",this.title=b.title?b.title:"",this.getMapURL=b.getMapURL?b.getMapURL:this._getCapabilitiesURL,this.version=b.version?b.version:"1.3.0",this.maxWidth=b.maxWidth?b.maxWidth:5E3,this.maxHeight=b.maxHeight?b.maxHeight:5E3,this.spatialReferences=b.spatialReferences?b.spatialReferences:[],this.imageFormat=this._getImageFormat(b.format),
this.setScaleRange(b.minScale,b.maxScale),this._initLayer()):console.error("esri.layers.WMSLayer: unable to find the 'layerInfos' property in resourceInfo"):console.error("esri.layers.WMSLayer: unable to find the 'extent' property in resourceInfo")},_getCapabilities:function(){var b=this._url.query?this._url.query:{};b.SERVICE="WMS";b.REQUEST="GetCapabilities";var a=this._url.path+"?",c;for(c in b)a+="?"==a.substring(a.length-1,a.length)?"":"\x26",a+=c+"\x3d"+b[c];r({url:a,handleAs:"xml",headers:{"Content-Type":null},
load:this._parseCapabilities,error:this._getCapabilitiesError},{usePost:!1})},_parseCapabilities:function(b){if(b){this.version=this._getAttributeValue("WMS_Capabilities","version",b,null);this.version||(this.version=this._getAttributeValue("WMT_MS_Capabilities","version",b,"1.3.0"));var a=this._getTag("Service",b);this.title=this._getTagValue("Title",a,"");if(!this.title||0==this.title.length)this.title=this._getTagValue("Name",a,"");this.copyright=this._getTagValue("AccessConstraints",a,"");this.description=
this._getTagValue("Abstract",a,"");this.maxWidth=parseInt(this._getTagValue("MaxWidth",a,5E3),10);this.maxHeight=parseInt(this._getTagValue("MaxHeight",a,5E3),10);if(a=this._getTag("Layer",b)){var c=this._getLayerInfo(a),d=0,f=null,a=this._getTag("Capability",b);s.forEach(a.childNodes,function(a){"Layer"==a.nodeName&&(0===d?f=a:(1===d&&c.name&&(c.name="",c.subLayers=[],c.subLayers.push(this._getLayerInfo(f))),c.subLayers.push(this._getLayerInfo(a))),d++)},this);if(c){this.layerInfos=c.subLayers;if(!this.layerInfos||
0==this.layerInfos.length)this.layerInfos=[c];this.extent=c.extent;this.allExtents=c.allExtents;this.spatialReferences=c.spatialReferences;0==this.spatialReferences.length&&0<this.layerInfos.length&&(this.spatialReferences=this.layerInfos[0].spatialReferences)}this.getMapURL=this._getCapabilitiesURL;if((a=e.query("DCPType",this._getTag("GetMap",b)))&&0<a.length)if((a=e.query("HTTP",a[0]))&&0<a.length)if((a=e.query("Get",a[0]))&&0<a.length)if(a=this._getAttributeValue("OnlineResource","xlink:href",
a[0],null))a.indexOf("\x26")==a.length-1&&(a=a.substring(0,a.length-1)),this.getMapURL=a;this.getMapFormats=[];0==e.query("Operation",b).length?s.forEach(e.query("Format",this._getTag("GetMap",b)),function(a){this.getMapFormats.push(a.text?a.text:a.textContent)},this):s.forEach(e.query("Operation",b),function(a){"GetMap"==a.getAttribute("name")&&s.forEach(e.query("Format",a),function(a){this.getMapFormats.push(a.text?a.text:a.textContent)},this)},this);s.some(this.getMapFormats,function(a){return-1<
a.indexOf(this.imageFormat)},this)||(this.imageFormat=this.getMapFormats[0]);this._initLayer()}else this._getCapabilitiesError({error:{message:"Response does not contain any layers."}})}else this.onError("GetCapabilities request for "+this._getCapabilitiesURL+" failed. (Response is null.)")},_getCapabilitiesError:function(b,a){this.onError("GetCapabilities request for "+this._getCapabilitiesURL+" failed.",b)},_getLayerInfo:function(b){if(!b)return null;var a=new f;a.name="";a.title="";a.description=
"";a.allExtents=[];a.spatialReferences=[];a.subLayers=[];var c=this._getTag("LatLonBoundingBox",b);c&&(a.allExtents[0]=this._getExtent(c,4326));if(c=this._getTag("EX_GeographicBoundingBox",b)){var d=new h(0,0,0,0,new g({wkid:4326}));d.xmin=parseFloat(this._getTagValue("westBoundLongitude",c,0));d.ymin=parseFloat(this._getTagValue("southBoundLatitude",c,0));d.xmax=parseFloat(this._getTagValue("eastBoundLongitude",c,0));d.ymax=parseFloat(this._getTagValue("northBoundLatitude",c,0));a.allExtents[0]=
d}a.extent=a.allExtents[0];var k=-1<s.indexOf(["1.0.0","1.1.0","1.1.1"],this.version)?"SRS":"CRS";s.forEach(b.childNodes,function(b){if("Name"==b.nodeName)a.name=(b.text?b.text:b.textContent)||"";else if("Title"==b.nodeName)a.title=(b.text?b.text:b.textContent)||"";else if("Abstract"==b.nodeName)a.description=(b.text?b.text:b.textContent)||"";else if("BoundingBox"==b.nodeName){var c=b.getAttribute(k);c&&0===c.indexOf("EPSG:")?(c=parseInt(c.substring(5),10),0!==c&&!isNaN(c)&&(b="1.3.0"==this.version?
this._getExtent(b,c,this._useLatLong(c)):this._getExtent(b,c),a.allExtents[c]=b,a.extent||(a.extent=b))):c&&0===c.indexOf("CRS:")?(c=parseInt(c.substring(4),10),0!==c&&!isNaN(c)&&(this._CRS_TO_EPSG[c]&&(c=this._CRS_TO_EPSG[c]),a.allExtents[c]=this._getExtent(b,c))):(c=parseInt(c,10),0!==c&&!isNaN(c)&&(a.allExtents[c]=this._getExtent(b,c)))}else if(b.nodeName==k)b=(b.text?b.text:b.textContent).split(" "),s.forEach(b,function(b){b=-1<b.indexOf(":")?parseInt(b.split(":")[1],10):parseInt(b,10);0!==b&&
!isNaN(b)&&(this._CRS_TO_EPSG[b]&&(b=this._CRS_TO_EPSG[b]),-1==s.indexOf(a.spatialReferences,b)&&a.spatialReferences.push(b))},this);else if("Style"==b.nodeName){if(b=this._getTag("LegendURL",b))if(b=this._getTag("OnlineResource",b))a.legendURL=b.getAttribute("xlink:href")}else"Layer"===b.nodeName&&a.subLayers.push(this._getLayerInfo(b))},this);a.title=a.title||a.name;return a},_getImageFormat:function(b){switch(b?b.toLowerCase():""){case "jpg":return"image/jpeg";case "bmp":return"image/bmp";case "gif":return"image/gif";
case "svg":return"image/svg+xml";default:return"image/png"}},getImageFormat:function(){switch(this.imageFormat?this.imageFormat.toLowerCase():""){case "image/jpeg":return"jpg";case "image/bmp":return"bmp";case "image/gif":return"gif";case "image/svg+xml":return"svg";default:return"png"}},_getExtent:function(b,a,c){var d;if(b){d=new h;var f=parseFloat(b.getAttribute("minx")),k=parseFloat(b.getAttribute("miny")),e=parseFloat(b.getAttribute("maxx"));b=parseFloat(b.getAttribute("maxy"));c?(d.xmin=isNaN(k)?
-1*Number.MAX_VALUE:k,d.ymin=isNaN(f)?-1*Number.MAX_VALUE:f,d.xmax=isNaN(b)?Number.MAX_VALUE:b,d.ymax=isNaN(e)?Number.MAX_VALUE:e):(d.xmin=isNaN(f)?-1*Number.MAX_VALUE:f,d.ymin=isNaN(k)?-1*Number.MAX_VALUE:k,d.xmax=isNaN(e)?Number.MAX_VALUE:e,d.ymax=isNaN(b)?Number.MAX_VALUE:b);d.spatialReference=new g({wkid:a})}return d},_useLatLong:function(b){var a,c;for(c=0;c<this._REVERSED_LAT_LONG_RANGES.length;c++){var d=this._REVERSED_LAT_LONG_RANGES[c];if(b>=d[0]&&b<=d[1]){a=!0;break}}return a},_getTag:function(b,
a){var c=e.query(b,a);return c&&0<c.length?c[0]:null},_getTagValue:function(b,a,c){return(b=e.query(b,a))&&0<b.length?b[0].text?b[0].text:b[0].textContent:c},_getAttributeValue:function(b,a,c,d){return(b=e.query(b,c))&&0<b.length?b[0].getAttribute(a):d},_checkVisibleLayersList:function(b){if(b&&(0<b.length&&this.layerInfos&&0<this.layerInfos.length)&&"number"==typeof b[0]){var a=[];s.forEach(b,function(b){b<this.layerInfos.length&&a.push(this.layerInfos[b].name)},this);b=a}return b},_stripParameters:function(b,
a){var c=k.urlToObject(b),d,f=[];for(d in c.query)-1===s.indexOf(a,d.toLowerCase())&&f.push(d+"\x3d"+c.query[d]);return c.path+(f.length?"?"+f.join("\x26"):"")}});n("extend-esri")&&l.setObject("layers.WMSLayer",q,p);return q})},"esri/layers/SnapshotMode":function(){define("dojo/_base/declare dojo/_base/lang dojo/has esri/kernel esri/SpatialReference esri/tasks/query esri/layers/RenderMode".split(" "),function(m,e,q,l,s,n,p){m=m([p],{declaredClass:"esri.layers._SnapshotMode",constructor:function(p){this.featureLayer=
p;this.pagination=p.queryPagination;this._featureMap={};this._drawFeatures=e.hitch(this,this._drawFeatures);this._queryErrorHandler=e.hitch(this,this._queryErrorHandler)},startup:function(){this.pagination=this.pagination&&null!=this.featureLayer.maxRecordCount;this.featureLayer._collection?this._applyTimeFilter():this._fetchAll()},propertyChangeHandler:function(e){this._init&&(e?this.featureLayer._collection?console.log("FeatureLayer: layer created by value (from a feature collection) does not support definition expressions and time definitions. Layer id \x3d "+
this.featureLayer.id):this._fetchAll():this._applyTimeFilter())},drawFeature:function(e){var k=e.attributes[this.featureLayer.objectIdField];this._addFeatureIIf(k,e);this._incRefCount(k)},resume:function(){this.propertyChangeHandler(0)},refresh:function(){var e=this.featureLayer;e._collection?(e._fireUpdateStart(),e._refresh(!0),e._fireUpdateEnd()):this._fetchAll()},_getRequestId:function(e){return("_"+e.name+e.layerId+e._ulid).replace(/[^a-zA-Z0-9\_]+/g,"_")},_fetchAll:function(){var e=this.featureLayer;
!e._collection&&!e.suspended&&(e._fireUpdateStart(),this._clearIIf(),this._sendRequest())},_sendRequest:function(e){var k=this.map,g=this.featureLayer,h=g.getDefinitionExpression(),d=new n;d.outFields=g.getOutFields();d.where=h||"1\x3d1";d.returnGeometry=!0;d.outSpatialReference=new s(k.spatialReference.toJson());d.timeExtent=g.getTimeDefinition();d.maxAllowableOffset=g._maxOffset;g._ts&&(d._ts=(new Date).getTime());d.orderByFields=g.supportsAdvancedQueries?g.getOrderByFields():null;this.pagination&&
(this._start=d.start=null==e?0:e,d.num=g.maxRecordCount);var f;g._usePatch&&(f=this._getRequestId(g),this._cancelPendingRequest(null,f));g._task.execute(d,this._drawFeatures,this._queryErrorHandler,f)},_drawFeatures:function(e){this._purgeRequests();var k=e.features,g=this.featureLayer,h=g.objectIdField,d,f=k.length,b=e.exceededTransferLimit&&!g._collection,a,c;for(d=0;d<f;d++)a=k[d],c=a.attributes[h],this._addFeatureIIf(c,a),this._incRefCount(c);this._applyTimeFilter(!0);if(!this.pagination||!b)g._fireUpdateEnd(null,
e.exceededTransferLimit?{queryLimitExceeded:!0}:null);b&&(this.pagination&&this._sendRequest(this._start+g.maxRecordCount),g.onQueryLimitExceeded())},_queryErrorHandler:function(e){this._purgeRequests();var k=this.featureLayer;k._errorHandler(e);k._fireUpdateEnd(e)}});q("extend-esri")&&e.setObject("layers._SnapshotMode",m,l);return m})},"esri/layers/SelectionMode":function(){define(["dojo/_base/declare","dojo/_base/lang","dojo/has","esri/kernel","esri/layers/RenderMode"],function(m,e,q,l,s){m=m([s],
{declaredClass:"esri.layers._SelectionMode",constructor:function(e){this.featureLayer=e;this._featureMap={}},propertyChangeHandler:function(e){this._init&&0===e&&this._applyTimeFilter()},resume:function(){this.propertyChangeHandler(0)}});q("extend-esri")&&e.setObject("layers._SelectionMode",m,l);return m})},"esri/layers/GridLayout":function(){define("dojo/_base/declare dojo/_base/lang dojo/_base/array dojo/has esri/kernel esri/SpatialReference esri/geometry/Extent esri/geometry/Polyline".split(" "),
function(m,e,q,l,s,n,p,r){m=m(null,{declaredClass:"esri.layers._GridLayout",constructor:function(e,g,h,d){this.origin=e;this.cellWidth=g.width;this.cellHeight=g.height;this.mapWidth=h.width;this.mapHeight=h.height;this.srInfo=d},setResolution:function(e){this._resolution=(e.xmax-e.xmin)/this.mapWidth;this.srInfo&&(e=Math.round(2*this.srInfo.valid[1]/this._resolution),e=Math.round(e/this.cellWidth),this._frameStats=[e,0,e-1])},getCellCoordinates:function(e){var g=this._resolution,h=this.origin;return{row:Math.floor((h.y-
e.y)/(this.cellHeight*g)),col:Math.floor((e.x-h.x)/(this.cellWidth*g))}},normalize:function(e){var g=this._frameStats;if(g){var h=g[0],d=g[1],g=g[2];e<d?(e%=h,e=e<d?e+h:e):e>g&&(e%=h)}return e},intersects:function(e,g){var h=this.srInfo;return h?q.some(g._getParts(h),function(d){return e.intersects(d.extent)}):e.intersects(g)},getCellExtent:function(e,g){var h=this._resolution,d=this.origin,f=this.cellWidth,b=this.cellHeight;return new p(g*f*h+d.x,d.y-(e+1)*b*h,(g+1)*f*h+d.x,d.y-e*b*h,new n(d.spatialReference.toJson()))},
getLatticeID:function(e){var g=this.getCellCoordinates({x:e.xmin,y:e.ymax}),h=this.getCellCoordinates({x:e.xmax,y:e.ymin});e=g.row;var d=h.row,g=this.normalize(g.col),h=this.normalize(h.col);return e+"_"+d+"_"+g+"_"+h},sorter:function(e,g){return e<g?-1:1},getCellsInExtent:function(e,g){var h=this.getCellCoordinates({x:e.xmin,y:e.ymax}),d=this.getCellCoordinates({x:e.xmax,y:e.ymin}),f=h.row,b=d.row,h=h.col,d=d.col,a=[],c,p,l,n=[],m=[],q,s,D,I=[];for(c=f;c<=b;c++)for(p=h;p<=d;p++)l=this.normalize(p),
e=this.getCellExtent(c,l),a.push({row:c,col:l,extent:e,resolution:this._resolution}),g&&(n.push(e.xmin,e.xmax),m.push(e.ymin,e.ymax));h=this.normalize(h);d=this.normalize(d);n.sort(this.sorter);m.sort(this.sorter);p=n.length;for(c=p-1;0<=c;c--)c<p-1&&n[c]===n[c+1]&&n.splice(c,1);p=m.length;for(c=p-1;0<=c;c--)c<p-1&&m[c]===m[c+1]&&m.splice(c,1);if(n.length&&m.length){l=n[0];q=n[n.length-1];s=m[0];D=m[m.length-1];p=n.length;for(c=0;c<p;c++)I.push([[n[c],D],[n[c],s]]);p=m.length;for(c=0;c<p;c++)I.push([[l,
m[c]],[q,m[c]]]);c=new r({paths:I,spatialReference:this.origin.spatialReference.toJson()});a.push({latticeID:f+"_"+b+"_"+h+"_"+d,lattice:c,resolution:this._resolution})}return{minRow:f,maxRow:b,minCol:h,maxCol:d,cells:a}}});l("extend-esri")&&e.setObject("layers._GridLayout",m,s);return m})},"dojox/data/CsvStore":function(){define("dojo/_base/lang dojo/_base/declare dojo/_base/xhr dojo/_base/kernel dojo/data/util/filter dojo/data/util/simpleFetch".split(" "),function(m,e,q,l,s,n){e=e("dojox.data.CsvStore",
null,{constructor:function(e){this._attributes=[];this._attributeIndexes={};this._dataArray=[];this._arrayOfAllItems=[];this._loadFinished=!1;e.url&&(this.url=e.url);this._csvData=e.data;e.label?this.label=e.label:""===this.label&&(this.label=void 0);this._storeProp="_csvStore";this._idProp="_csvId";this._features={"dojo.data.api.Read":!0,"dojo.data.api.Identity":!0};this._loadInProgress=!1;this._queuedFetches=[];this.identifier=e.identifier;""===this.identifier?delete this.identifier:this._idMap=
{};"separator"in e&&(this.separator=e.separator);"urlPreventCache"in e&&(this.urlPreventCache=e.urlPreventCache?!0:!1)},url:"",label:"",identifier:"",separator:",",urlPreventCache:!1,_assertIsItem:function(e){if(!this.isItem(e))throw Error(this.declaredClass+": a function was passed an item argument that was not an item");},_getIndex:function(e){e=this.getIdentity(e);this.identifier&&(e=this._idMap[e]);return e},getValue:function(e,l,k){this._assertIsItem(e);var g=k;if("string"===typeof l)l=this._attributeIndexes[l],
null!=l&&(g=this._dataArray[this._getIndex(e)][l]||k);else throw Error(this.declaredClass+": a function was passed an attribute argument that was not a string");return g},getValues:function(e,l){var k=this.getValue(e,l);return k?[k]:[]},getAttributes:function(e){this._assertIsItem(e);var l=[];e=this._dataArray[this._getIndex(e)];for(var k=0;k<e.length;k++)""!==e[k]&&l.push(this._attributes[k]);return l},hasAttribute:function(e,l){this._assertIsItem(e);if("string"===typeof l){var k=this._attributeIndexes[l],
g=this._dataArray[this._getIndex(e)];return"undefined"!==typeof k&&k<g.length&&""!==g[k]}throw Error(this.declaredClass+": a function was passed an attribute argument that was not a string");},containsValue:function(e,l,k){var g=void 0;"string"===typeof k&&(g=s.patternToRegExp(k,!1));return this._containsValue(e,l,k,g)},_containsValue:function(e,l,k,g){e=this.getValues(e,l);for(l=0;l<e.length;++l){var h=e[l];if("string"===typeof h&&g)return null!==h.match(g);if(k===h)return!0}return!1},isItem:function(e){if(e&&
e[this._storeProp]===this)if(e=e[this._idProp],this.identifier){if(this._dataArray[this._idMap[e]])return!0}else if(0<=e&&e<this._dataArray.length)return!0;return!1},isItemLoaded:function(e){return this.isItem(e)},loadItem:function(e){},getFeatures:function(){return this._features},getLabel:function(e){if(this.label&&this.isItem(e))return this.getValue(e,this.label)},getLabelAttributes:function(e){return this.label?[this.label]:null},_fetchItems:function(e,l,k){var g=this,h=function(a,b){var d=null;
if(a.query){var f,e,d=[],h=a.queryOptions?a.queryOptions.ignoreCase:!1,k={};for(f in a.query)e=a.query[f],"string"===typeof e&&(k[f]=s.patternToRegExp(e,h));for(h=0;h<b.length;++h){var p=!0,n=b[h];for(f in a.query)e=a.query[f],g._containsValue(n,f,e,k[f])||(p=!1);p&&d.push(n)}}else d=b.slice(0,b.length);l(d,a)};if(this._loadFinished)h(e,this._arrayOfAllItems);else if(""!==this.url)if(this._loadInProgress)this._queuedFetches.push({args:e,filter:h});else{this._loadInProgress=!0;var d=q.get({url:g.url,
handleAs:"text",preventCache:g.urlPreventCache});d.addCallback(function(a){try{g._processData(a),h(e,g._arrayOfAllItems),g._handleQueuedFetches()}catch(b){k(b,e)}});d.addErrback(function(a){g._loadInProgress=!1;if(k)k(a,e);else throw a;});var f=null;e.abort&&(f=e.abort);e.abort=function(){d&&-1===d.fired&&d.cancel();f&&f.call(e)}}else if(this._csvData)try{this._processData(this._csvData),this._csvData=null,h(e,this._arrayOfAllItems)}catch(b){k(b,e)}else{var a=Error(this.declaredClass+": No CSV source data was provided as either URL or String data input.");
if(k)k(a,e);else throw a;}},close:function(e){},_getArrayOfArraysFromCsvFileContents:function(e){if(m.isString(e)){var l=RegExp("^\\s+","g"),k=RegExp("\\s+$","g"),g=RegExp('""',"g"),h=[],d=this._splitLines(e);for(e=0;e<d.length;++e){var f=d[e];if(0<f.length){for(var f=f.split(this.separator),b=0;b<f.length;){var a=f[b].replace(l,""),c=a.replace(k,""),n=c.charAt(0),q=c.charAt(c.length-1),s=c.charAt(c.length-2),z=c.charAt(c.length-3);if(2===c.length&&'""'==c)f[b]="";else if('"'==n&&('"'!=q||'"'==q&&
'"'==s&&'"'!=z)){if(b+1===f.length)return;f[b]=a+this.separator+f[b+1];f.splice(b+1,1)}else'"'==n&&'"'==q&&(c=c.slice(1,c.length-1),c=c.replace(g,'"')),f[b]=c,b+=1}h.push(f)}}this._attributes=h.shift();for(e=0;e<this._attributes.length;e++)this._attributeIndexes[this._attributes[e]]=e;this._dataArray=h}},_splitLines:function(e){var l=[],k,g="",h=!1;for(k=0;k<e.length;k++){var d=e.charAt(k);switch(d){case '"':h=!h;g+=d;break;case "\r":h?g+=d:(l.push(g),g="",k<e.length-1&&"\n"==e.charAt(k+1)&&k++);
break;case "\n":h?g+=d:(l.push(g),g="");break;default:g+=d}}""!==g&&l.push(g);return l},_processData:function(e){this._getArrayOfArraysFromCsvFileContents(e);this._arrayOfAllItems=[];if(this.identifier&&void 0===this._attributeIndexes[this.identifier])throw Error(this.declaredClass+": Identity specified is not a column header in the data set.");for(e=0;e<this._dataArray.length;e++){var l=e;this.identifier&&(l=this._dataArray[e][this._attributeIndexes[this.identifier]],this._idMap[l]=e);this._arrayOfAllItems.push(this._createItemFromIdentity(l))}this._loadFinished=
!0;this._loadInProgress=!1},_createItemFromIdentity:function(e){var l={};l[this._storeProp]=this;l[this._idProp]=e;return l},getIdentity:function(e){return this.isItem(e)?e[this._idProp]:null},fetchItemByIdentity:function(e){var n,k=e.scope?e.scope:l.global;if(this._loadFinished)n=this._createItemFromIdentity(e.identity),this.isItem(n)||(n=null),e.onItem&&e.onItem.call(k,n);else{var g=this;if(""!==this.url)this._loadInProgress?this._queuedFetches.push({args:e}):(this._loadInProgress=!0,n=q.get({url:g.url,
handleAs:"text"}),n.addCallback(function(d){try{g._processData(d);var f=g._createItemFromIdentity(e.identity);g.isItem(f)||(f=null);e.onItem&&e.onItem.call(k,f);g._handleQueuedFetches()}catch(b){e.onError&&e.onError.call(k,b)}}),n.addErrback(function(d){this._loadInProgress=!1;e.onError&&e.onError.call(k,d)}));else if(this._csvData)try{g._processData(g._csvData),g._csvData=null,n=g._createItemFromIdentity(e.identity),g.isItem(n)||(n=null),e.onItem&&e.onItem.call(k,n)}catch(h){e.onError&&e.onError.call(k,
h)}}},getIdentityAttributes:function(e){return this.identifier?[this.identifier]:null},_handleQueuedFetches:function(){if(0<this._queuedFetches.length){for(var e=0;e<this._queuedFetches.length;e++){var l=this._queuedFetches[e],k=l.filter,g=l.args;k?k(g,this._arrayOfAllItems):this.fetchItemByIdentity(l.args)}this._queuedFetches=[]}}});m.extend(e,n);return e})},"esri/arcgis/csv":function(){define("dojo/_base/lang dojo/_base/array dojo/_base/Deferred dojo/sniff dojo/number dojox/data/CsvStore esri/kernel esri/config esri/request esri/SpatialReference esri/geometry/Geometry esri/geometry/jsonUtils esri/geometry/webMercatorUtils".split(" "),
function(m,e,q,l,s,n,p,r,k,g,h,d,f){function b(a){var b=0,c="";e.forEach([","," ",";","|","\t"],function(d){var e=a.split(d).length;e>b&&(b=e,c=d)});return c}function a(a,b){if(!a||"[object Date]"!==Object.prototype.toString.call(a)||isNaN(a.getTime()))return!1;var c=!0;if(l("chrome")&&/\d+\W*$/.test(b)){var d=b.match(/[a-zA-Z]{2,}/);if(d){for(var c=!1,e=0,f=d.length,g=/^((jan(uary)?)|(feb(ruary)?)|(mar(ch)?)|(apr(il)?)|(may)|(jun(e)?)|(jul(y)?)|(aug(ust)?)|(sep(tember)?)|(oct(ober)?)|(nov(ember)?)|(dec(ember)?)|(am)|(pm)|(gmt)|(utc))$/i;!c&&
e<=f&&!(c=!g.test(d[e]));)e++;c=!c}}return c}function c(c,d,f){var g=c.indexOf("\n"),g=m.trim(c.substr(0,g)),h=d.columnDelimiter;h||(h=b(g));var k=new n({data:c,separator:h});c=9>l("ie")?750:1001;k.fetch({start:0,count:c,onComplete:function(b,c){var g=0,h={layerDefinition:d.layerDefinition,featureSet:{features:[],geometryType:"esriGeometryPoint"}},l=h.layerDefinition.objectIdField;!l&&!e.some(h.layerDefinition.fields,function(a){return"esriFieldTypeOID"==a.type?(l=a.name,!0):!1})&&(h.layerDefinition.fields.push({name:"__OBJECTID",
alias:"__OBJECTID",type:"esriFieldTypeOID",editable:!1,domain:null}),l="__OBJECTID");var n,p,m=k._attributes,r=[],q=[];e.forEach(h.layerDefinition.fields,function(a,b){"esriFieldTypeDate"===a.type?r.push(a.name):("esriFieldTypeDouble"===a.type||"esriFieldTypeInteger"===a.type)&&q.push(a.name)});d.locationInfo&&"coordinates"===d.locationInfo.locationType?(n=d.locationInfo.latitudeFieldName,p=d.locationInfo.longitudeFieldName):e.forEach(m,function(a){var b;b=e.indexOf(z,a.toLowerCase());-1!==b&&(n=
a);b=e.indexOf(F,a.toLowerCase());-1!==b&&(p=a)},this);if(!n||!p)setTimeout(function(){console.error("File does not seem to contain fields with point coordinates.")},1),f&&f(null,Error("File does not seem to contain fields with point coordinates."));else{-1===e.indexOf(q,n)&&q.push(n);-1===e.indexOf(q,p)&&q.push(p);var m=0,B=b.length;for(m;m<B;m++){if(1E3<=h.featureSet.features.length){setTimeout(function(){console.error("1000 feature limit reached. Unable to load any more data.")},1);break}var w=
b[m],t=k.getAttributes(w),u={};e.forEach(t,function(b,c){if(b){var d=b;0===b.length&&e.forEach(h.layerDefinition.fields,function(a,c){a.name==="attribute_"+(c-1)&&(b="attribute_"+(c-1))});if(-1<e.indexOf(r,b)){var d=k.getValue(w,d),f=new Date(d);u[b]=a(f,d)?f.getTime():null}else if(-1<e.indexOf(q,b)){f=s.parse(k.getValue(w,d));if((b==n||b==p)&&(isNaN(f)||181<Math.abs(f)))f=parseFloat(k.getValue(w,d));isNaN(f)?u[b]=null:u[b]=f}else u[b]=k.getValue(w,d)}});u[l]=g;g++;var t=u[n],v=u[p];null==v||(null==
t||isNaN(t)||isNaN(v))||h.featureSet.features.push({geometry:{x:v,y:t,spatialReference:{wkid:4326}},attributes:u})}h.layerDefinition.name="csv";f&&f(h)}},onError:function(a){console.error("Error fetching items from CSV store: ",a);f&&f(null,a)}});return!0}function u(a,b,c,g,h,k){0===a.length&&h(null);var l=d.getGeometryType(b),n=[];e.forEach(a,function(a){a=new l(a);a.spatialReference=c;n.push(a)},this);b=[102113,102100,3857];c.wkid&&4326===c.wkid&&g.wkid&&-1<e.indexOf(b,g.wkid)?(e.forEach(n,function(a){a.xmin?
(a.xmin=Math.max(a.xmin,-180),a.xmax=Math.min(a.xmax,180),a.ymin=Math.max(a.ymin,-89.99),a.ymax=Math.min(a.ymax,89.99)):a.rings?e.forEach(a.rings,function(a){e.forEach(a,function(a){a[0]=Math.min(Math.max(a[0],-180),180);a[1]=Math.min(Math.max(a[1],-89.99),89.99)},this)},this):a.paths?e.forEach(a.paths,function(a){e.forEach(a,function(a){a[0]=Math.min(Math.max(a[0],-180),180);a[1]=Math.min(Math.max(a[1],-89.99),89.99)},this)},this):a.x&&(a.x=Math.min(Math.max(a.x,-180),180),a.y=Math.min(Math.max(a.y,
-89.99),89.99))},this),a=[],e.forEach(n,function(b){b=f.geographicToWebMercator(b);102100!==g.wkid&&(b.spatialReference=g);a.push(b.toJson())},this),h(a)):null!==c.wkid&&-1<e.indexOf(b,c.wkid)&&null!==g.wkid&&4326===g.wkid?(a=[],e.forEach(n,function(b){a.push(f.webMercatorToGeographic(b).toJson())},this),h(a)):(b=function(b,c){b&&b.length===a.length?(a=[],e.forEach(b,function(b){b&&(b.rings&&0<b.rings.length&&0<b.rings[0].length&&0<b.rings[0][0].length&&!isNaN(b.rings[0][0][0])&&!isNaN(b.rings[0][0][1])||
b.paths&&0<b.paths.length&&0<b.paths[0].length&&0<b.paths[0][0].length&&!isNaN(b.paths[0][0][0])&&!isNaN(b.paths[0][0][1])||b.xmin&&!isNaN(b.xmin)&&b.ymin&&!isNaN(b.ymin)||b.x&&!isNaN(b.x)&&b.y&&!isNaN(b.y))?a.push(b.toJson()):a.push(null)},this),h(a)):k(b,c)},r.defaults.geometryService?r.defaults.geometryService.project(n,g,m.hitch(this,b),k):h(null))}function v(a,b){var c=[102113,102100,3857];return a&&b&&a.wkid===b.wkid&&a.wkt===b.wkt||a&&b&&a.wkid&&b.wkid&&-1<e.indexOf(c,a.wkid)&&-1<e.indexOf(c,
b.wkid)?!0:!1}function t(a,b,c,f){if(a.featureSet&&0!==a.featureSet.features.length)if(v(c,b))f(a);else{var h=function(b){var c=[];e.forEach(a.featureSet.features,function(a,d){b[d]&&(a.geometry=b[d],c.push(a))},this);f(a)},k=function(b,c){console.error("error projecting featureSet ("+a.layerDefinition.name+"). Final try.");f(a)},l=function(d,e){console.error("error projecting featureSet ("+a.layerDefinition.name+"). Try one more time.");u(n,a.featureSet.geometryType,b,c,m.hitch(this,h),m.hitch(this,
k))};if(a.featureSet.features&&0<a.featureSet.features.length){var n=[];e.forEach(a.featureSet.features,function(b){if(b.geometry.toJson)n.push(b.geometry);else{var c=d.getGeometryType(a.featureSet.geometryType);n.push(new c(b.geometry))}});b.toJson||(b=new g(b));c.toJson||(c=new g(c));u(n,a.featureSet.geometryType,b,c,m.hitch(this,h),m.hitch(this,l))}else f(a)}}var z="lat latitude y ycenter latitude83 latdecdeg POINT-Y".split(" "),F="lon lng long longitude x xcenter longitude83 longdecdeg POINT-X".split(" ");
h={latFieldStrings:z,longFieldStrings:F,buildCSVFeatureCollection:function(a){var b=new q,d=function(a,c){c?b.errback(c):b.callback(a)};k({url:a.url,handleAs:"text",load:function(b){c(b,a,m.hitch(this,d))},error:function(a){b.errback(a);console.error("error: "+a)}},{usePost:!1});return b},projectFeatureCollection:function(a,b,c){var d=new q;c||(c=new g({wkid:4326}));t(a,c,b,m.hitch(this,function(a){d.callback(a)}));return d},generateDefaultPopupInfo:function(a){var b={esriFieldTypeDouble:1,esriFieldTypeSingle:1},
c={esriFieldTypeInteger:1,esriFieldTypeSmallInteger:1},d={esriFieldTypeDate:1},f=null;a=e.map(a.layerDefinition.fields,m.hitch(this,function(a){"NAME"===a.name.toUpperCase()&&(f=a.name);var e="esriFieldTypeOID"!==a.type&&"esriFieldTypeGlobalID"!==a.type&&"esriFieldTypeGeometry"!==a.type,g=null;if(e){var h=a.name.toLowerCase();if(-1<",stretched value,fnode_,tnode_,lpoly_,rpoly_,poly_,subclass,subclass_,rings_ok,rings_nok,".indexOf(","+h+",")||-1<h.indexOf("area")||-1<h.indexOf("length")||-1<h.indexOf("shape")||
-1<h.indexOf("perimeter")||-1<h.indexOf("objectid")||h.indexOf("_")===h.length-1||h.indexOf("_i")===h.length-2&&1<h.length)e=!1;a.type in c?g={places:0,digitSeparator:!0}:a.type in b?g={places:2,digitSeparator:!0}:a.type in d&&(g={dateFormat:"shortDateShortTime"})}return m.mixin({},{fieldName:a.name,label:a.alias,isEditable:!0,tooltip:"",visible:e,format:g,stringFieldOption:"textbox"})}));return{title:f?"{"+f+"}":"",fieldInfos:a,description:null,showAttachments:!1,mediaInfos:[]}},_getSeparator:b,
_isValidDate:a,_processCsvData:c,_projectGeometries:u,_sameSpatialReference:v,_projectFeatureSet:t};l("extend-esri")&&m.setObject("arcgis.csv",h,p);return h})},"dojo/data/util/filter":function(){define(["../../_base/lang"],function(m){var e={};m.setObject("dojo.data.util.filter",e);e.patternToRegExp=function(e,l){for(var m="^",n=null,p=0;p<e.length;p++)switch(n=e.charAt(p),n){case "\\":m+=n;p++;m+=e.charAt(p);break;case "*":m+=".*";break;case "?":m+=".";break;case "$":case "^":case "/":case "+":case ".":case "|":case "(":case ")":case "{":case "}":case "[":case "]":m+=
"\\";default:m+=n}m+="$";return l?RegExp(m,"mi"):RegExp(m,"m")};return e})},"esri/layers/WMSLayerInfo":function(){define(["dojo/_base/declare","dojo/_base/lang","dojo/_base/array","dojo/has","esri/kernel"],function(m,e,q,l,s){m=m(null,{declaredClass:"esri.layers.WMSLayerInfo",name:null,title:null,description:null,extent:null,legendURL:null,subLayers:[],allExtents:[],spatialReferences:[],constructor:function(e){e&&(this.name=e.name,this.title=e.title,this.description=e.description,this.extent=e.extent,
this.legendURL=e.legendURL,this.subLayers=e.subLayers?e.subLayers:[],this.allExtents=e.allExtents?e.allExtents:[],this.spatialReferences=e.spatialReferences?e.spatialReferences:[])},clone:function(){var e={name:this.name,title:this.title,description:this.description,legendURL:this.legendURL},l;this.extent&&(e.extent=this.extent.getExtent());e.subLayers=[];q.forEach(this.subLayers,function(l){e.subLayers.push(l.clone())});e.allExtents=[];for(l in this.allExtents)l=parseInt(l,10),isNaN(l)||(e.allExtents[l]=
this.allExtents[l].getExtent());e.spatialReferences=[];q.forEach(this.spatialReferences,function(l){e.spatialReferences.push(l)});return e}});l("extend-esri")&&e.setObject("layers.WMSLayerInfo",m,s);return m})},"esri/layers/RenderMode":function(){define("dojo/_base/kernel dojo/_base/declare dojo/_base/lang dojo/_base/array dojo/has dojo/io/script esri/kernel".split(" "),function(m,e,q,l,s,n,p){e=e(null,{declaredClass:"esri.layers._RenderMode",constructor:function(){this._prefix="jsonp_"+(m._scopeName||
"dojo")+"IoScript"},initialize:function(e){this.map=e;this._init=!0},startup:function(){},propertyChangeHandler:function(e){},destroy:function(){this._init=!1},drawFeature:function(e){},suspend:function(){},resume:function(){},refresh:function(){},_incRefCount:function(e){(e=this._featureMap[e])&&e._count++},_decRefCount:function(e){(e=this._featureMap[e])&&e._count--},_getFeature:function(e){return this._featureMap[e]},_addFeatureIIf:function(e,k){var g=this._featureMap,h=g[e],d=this.featureLayer;
h||(g[e]=k,d._add(k),k._count=0);return h||k},_removeFeatureIIf:function(e){var k=this._featureMap[e],g=this.featureLayer;if(k){if(k._count)return;delete this._featureMap[e];g._remove(k)}return k},_clearIIf:function(){var e;e=this.featureLayer;var k=e.graphics,g=e._selectedFeatures,h=e.objectIdField;for(e=k.length-1;0<=e;e--){var d=k[e],f=d.attributes[h];f in g?d._count=1:(d._count=0,this._removeFeatureIIf(f))}},_isPending:function(e){return n[this._prefix+e]?!0:!1},_cancelPendingRequest:function(e,
k){if(e=e||n[this._prefix+k])try{e.cancel(),n._validCheck(e)}catch(g){}},_purgeRequests:function(){n._validCheck(null)},_toggleVisibility:function(e){var k=this.featureLayer,g=k.graphics,h=e?"show":"hide",d,f=g.length;e=e&&k._ager;for(d=0;d<f;d++){var b=g[d];b[h]();e&&k._repaint(b)}},_applyTimeFilter:function(e){var k=this.featureLayer;if(k.timeInfo&&!k.suspended){e||k._fireUpdateStart();var g=k._trackManager;g&&g.clearTracks();var h=k.getTimeDefinition(),d=k._getOffsettedTE(k._mapTimeExtent);d?(d=
k._getTimeOverlap(h,d))?(h=k._filterByTime(k.graphics,d.startTime,d.endTime),g&&g.addFeatures(h.match),l.forEach(h.match,function(d){var b=d._shape;d.visible||(d.show(),(b=d._shape)&&b._moveToFront());k._ager&&b&&k._repaint(d)}),l.forEach(h.noMatch,function(d){d.visible&&d.hide()})):this._toggleVisibility(!1):(g&&g.addFeatures(k.graphics),this._toggleVisibility(!0));g&&(g.moveLatestToFront(),g.drawTracks());e||k._fireUpdateEnd()}}});s("extend-esri")&&q.setObject("layers._RenderMode",e,p);return e})},
"esri/layers/FeatureType":function(){define("dojo/_base/declare dojo/_base/lang dojo/_base/array dojo/has esri/kernel esri/lang esri/symbols/jsonUtils esri/layers/RangeDomain esri/layers/CodedValueDomain esri/layers/InheritedDomain esri/layers/FeatureTemplate".split(" "),function(m,e,q,l,s,n,p,r,k,g,h){m=m(null,{declaredClass:"esri.layers.FeatureType",constructor:function(d){if(d&&e.isObject(d)){this.id=d.id;this.name=d.name;var f=d.symbol;f&&(this.symbol=p.fromJson(f));var f=d.domains,b,a=this.domains=
{};for(b in f)if(f.hasOwnProperty(b)){var c=f[b];switch(c.type){case "range":a[b]=new r(c);break;case "codedValue":a[b]=new k(c);break;case "inherited":a[b]=new g(c)}}if(b=d.templates){f=this.templates=[];for(d=0;d<b.length;d++)f.push(new h(b[d]))}}},toJson:function(){var d={id:this.id,name:this.name,symbol:this.symbol&&this.symbol.toJson()},e,b=this.domains,a=this.templates,c=n.fixJson;if(b){var h=d.domains={};for(e in b)b.hasOwnProperty(e)&&(h[e]=b[e]&&b[e].toJson());c(h)}a&&(d.templates=q.map(a,
function(a){return a.toJson()}));return c(d)}});l("extend-esri")&&e.setObject("layers.FeatureType",m,s);return m})},"esri/layers/GeoRSSLayer":function(){define("dojo/_base/declare dojo/_base/lang dojo/_base/json dojo/has esri/kernel esri/config esri/request esri/layers/ServiceGeneratedFeatureCollection".split(" "),function(m,e,q,l,s,n,p,r){m=m([r],{declaredClass:"esri.layers.GeoRSSLayer",serviceUrl:location.protocol+"//utility.arcgis.com/sharing/rss",constructor:function(e,g){n.defaults.geoRSSService&&
(this.serviceUrl=n.defaults.geoRSSService);this._createLayer()},parse:function(){return this._io=p({url:this.serviceUrl,content:{url:this.url,refresh:this.loaded?!0:void 0,outSR:this._outSR?q.toJson(this._outSR.toJson()):void 0},callbackParamName:"callback"})},_initLayer:function(e){this.inherited(arguments);this.loaded||(this.loaded=!0,this.onLoad(this))}});l("extend-esri")&&e.setObject("layers.GeoRSSLayer",m,s);return m})},"esri/layers/FeatureTemplate":function(){define("dojo/_base/declare dojo/_base/lang dojo/has esri/kernel esri/lang esri/graphic".split(" "),
function(m,e,q,l,s,n){m=m(null,{declaredClass:"esri.layers.FeatureTemplate",constructor:function(l){l&&e.isObject(l)&&(this.name=l.name,this.description=l.description,this.drawingTool=l.drawingTool,l=l.prototype,this.prototype=new n(l.geometry,null,l.attributes))},toJson:function(){return s.fixJson({name:this.name,description:this.description,drawingTool:this.drawingTool,prototype:this.prototype&&this.prototype.toJson()})}});e.mixin(m,{TOOL_AUTO_COMPLETE_POLYGON:"esriFeatureEditToolAutoCompletePolygon",
TOOL_CIRCLE:"esriFeatureEditToolCircle",TOOL_ELLIPSE:"esriFeatureEditToolEllipse",TOOL_FREEHAND:"esriFeatureEditToolFreehand",TOOL_LINE:"esriFeatureEditToolLine",TOOL_NONE:"esriFeatureEditToolNone",TOOL_POINT:"esriFeatureEditToolPoint",TOOL_POLYGON:"esriFeatureEditToolPolygon",TOOL_RECTANGLE:"esriFeatureEditToolRectangle",TOOL_ARROW:"esriFeatureEditToolArrow",TOOL_TRIANGLE:"esriFeatureEditToolTriangle",TOOL_LEFT_ARROW:"esriFeatureEditToolLeftArrow",TOOL_RIGHT_ARROW:"esriFeatureEditToolRightArrow",
TOOL_UP_ARROW:"esriFeatureEditToolUpArrow",TOOL_DOWN_ARROW:"esriFeatureEditToolDownArrow"});q("extend-esri")&&e.setObject("layers.FeatureTemplate",m,l);return m})},"*noref":1}});
define("esri/arcgis/utils","dojo/_base/lang dojo/_base/array dojo/_base/connect dojo/_base/Deferred dojo/_base/json dojo/_base/url dojo/has dojo/on dojo/DeferredList dojo/dom-construct esri/kernel esri/config esri/lang esri/request esri/SpatialReference esri/map esri/urlUtils esri/geometry/ScreenPoint esri/geometry/Extent esri/geometry/webMercatorUtils esri/symbols/jsonUtils esri/renderers/jsonUtils esri/dijit/PopupTemplate esri/dijit/Popup esri/tasks/query esri/tasks/GeometryService esri/arcgis/csv esri/layers/ArcGISTiledMapServiceLayer esri/layers/ArcGISDynamicMapServiceLayer esri/layers/ArcGISImageServiceLayer esri/layers/CSVLayer esri/layers/OpenStreetMapLayer esri/layers/WebTiledLayer esri/layers/FeatureLayer esri/layers/WMSLayer esri/layers/KMLLayer esri/layers/GeoRSSLayer esri/virtualearth/VETiledLayer esri/layers/TileInfo esri/layers/DynamicLayerInfo esri/layers/LayerDrawingOptions esri/layers/ImageParameters esri/layers/ImageServiceParameters esri/layers/RasterFunction esri/layers/MosaicRule esri/layers/WMSLayerInfo dojo/i18n!esri/nls/jsapi".split(" "),function(m,
e,q,l,s,n,p,r,k,g,h,d,f,b,a,c,u,v,t,z,F,B,D,I,w,J,T,O,P,x,U,R,ba,E,ca,da,ea,G,fa,M,ga,S,ha,ia,ja,ka,y){function H(a){return b({url:A.arcgisUrl+"/"+a.itemId+"/data",content:{f:"json"},callbackParamName:"callback"},{disableIdentityLookup:!0,_preLookup:!0})}function sa(a){var c={f:"json"};if(h.id){var d=h.id.findCredential(u.urlToObject(A.arcgisUrl).path);d&&(c.token=d.token)}return b({url:a,content:c,callbackParamName:"callback"},{disableIdentityLookup:!0})}function ta(a){a.itemProperties.layerDefinition&&
(a.layerDefinition?(a.layerDefinition.drawingInfo||(a.layerDefinition.drawingInfo=a.itemProperties.layerDefinition.drawingInfo),f.isDefined(a.layerDefinition.definitionExpression)||(a.layerDefinition.definitionExpression=a.itemProperties.layerDefinition.definitionExpression),f.isDefined(a.layerDefinition.minScale)||(a.layerDefinition.minScale=a.itemProperties.layerDefinition.minScale),f.isDefined(a.layerDefinition.maxScale)||(a.layerDefinition.maxScale=a.itemProperties.layerDefinition.maxScale)):
a.layerDefinition=a.itemProperties.layerDefinition);a.itemProperties.popupInfo&&(!a.popupInfo&&!a.disablePopup)&&(a.popupInfo=a.itemProperties.popupInfo);f.isDefined(a.itemProperties.showLegend)&&!f.isDefined(a.showLegend)&&(a.showLegend=a.itemProperties.showLegend);f.isDefined(a.itemProperties.refreshInterval)&&!f.isDefined(a.refreshInterval)&&(a.refreshInterval=a.itemProperties.refreshInterval)}function V(a,b){var c=new l,d=a.itemData,h=[],g=[];e.forEach(d.operationalLayers,function(a){if(a.itemId&&
!a.type){var b=a.url.toLowerCase();-1<b.indexOf("/featureserver")||-1<b.indexOf("/mapserver/")?(g.push(a),h.push(H(a))):-1<b.indexOf("/mapserver")&&-1===b.indexOf("/mapserver/")&&(!a.layers||!f.isDefined(a.minScale)&&!f.isDefined(a.maxScale))?(g.push(a),h.push(H(a))):-1<b.indexOf("/imageserver")&&(!f.isDefined(a.minScale)&&!f.isDefined(a.maxScale))&&(g.push(a),h.push(H(a)))}});d.baseMap&&d.baseMap.baseMapLayers&&e.forEach(d.baseMap.baseMapLayers,function(a){a.itemId&&(g.push(a),h.push(H(a)))});0<
h.length?(new k(h)).addCallback(function(b){e.forEach(g,function(a,c){var d=b[c][1];if(d&&!a.type){var h=a.url.toLowerCase();(-1<h.indexOf("/featureserver")||-1<h.indexOf("/mapserver/"))&&d.layers?e.forEach(d.layers,function(b){if(h.endsWith("/featureserver/"+b.id)||h.endsWith("/mapserver/"+b.id))a.itemProperties=b,ta(a)}):-1<h.indexOf("/mapserver")?(d.layers&&!a.layers&&(a.layers=d.layers),f.isDefined(d.minScale)&&!f.isDefined(a.minScale)&&(a.minScale=d.minScale),f.isDefined(d.maxScale)&&!f.isDefined(a.maxScale)&&
(a.maxScale=d.maxScale),f.isDefined(d.refreshInterval)&&!f.isDefined(a.refreshInterval)&&(a.refreshInterval=d.refreshInterval)):-1<h.indexOf("/imageserver")&&(f.isDefined(d.minScale)&&!f.isDefined(a.minScale)&&(a.minScale=d.minScale),f.isDefined(d.maxScale)&&!f.isDefined(a.maxScale)&&(a.maxScale=d.maxScale),f.isDefined(d.refreshInterval)&&!f.isDefined(a.refreshInterval)&&(a.refreshInterval=d.refreshInterval),d.popupInfo&&(!a.popupInfo&&!a.disablePopup)&&(a.popupInfo=d.popupInfo),d.renderingRule&&
!a.renderingRule&&(a.renderingRule=d.renderingRule,d.renderingRule.functionName&&(a.renderingRule.rasterFunction=d.renderingRule.functionName)),d.bandIds&&!a.bandIds&&(a.bandIds=d.bandIds),d.mosaicRule&&!a.mosaicRule&&(a.mosaicRule=d.mosaicRule),d.format&&!a.format&&(a.format=d.format),f.isDefined(d.compressionQuality)&&!f.isDefined(a.compressionQuality)&&(a.compressionQuality=d.compressionQuality))}});c.callback(a)}):c.callback(a);return c}function La(a,b){var c=new l,d=a.itemData,e=d.baseMap.baseMapLayers[0];
if("BingMapsAerial"===e.type||"BingMapsRoad"===e.type||"BingMapsHybrid"===e.type)if(e.portalUrl)delete b.bingMapsKey,sa(e.portalUrl).then(function(f){f.bingKey?(b.bingMapsKey=f.bingKey,f=new G({bingMapsKey:b.bingMapsKey,mapStyle:G.MAP_STYLE_AERIAL}),q.connect(f,"onLoad",m.hitch(this,function(){c.callback([a,b])})),q.connect(f,"onError",function(f){delete b.bingMapsKey;a.itemData=W(d);e=a.itemData.baseMap.baseMapLayers[0];e.errors=[];e.errors.push({message:"The owner of the map has not provided a valid Bing Key for the Bing Map it includes. Switching to Esri layers."});
c.callback([a,b])})):(delete b.bingMapsKey,a.itemData=W(d),e=a.itemData.baseMap.baseMapLayers[0],e.errors=[],e.errors.push({message:"The owner of the map has not provided a Bing Key for the Bing Map it includes. Switching to Esri layers."}),c.callback([a,b]))});else if(b.bingMapsKey){var f=new G({bingMapsKey:b.bingMapsKey,mapStyle:G.MAP_STYLE_AERIAL});q.connect(f,"onLoad",m.hitch(this,function(){c.callback([a,b])}));q.connect(f,"onError",function(f){delete b.bingMapsKey;a.itemData=W(d);e=a.itemData.baseMap.baseMapLayers[0];
e.errors=[];e.errors.push({message:"The owner of the application has not provided a valid Bing Key for the Bing Map it includes. Switching to Esri layers."});c.callback([a,b])})}else a.itemData=W(d),e=a.itemData.baseMap.baseMapLayers[0],e.errors=[],e.errors.push({message:"The owner of the application has not provided a Bing Key for the Bing Map it includes. Switching to Esri layers."}),c.callback([a,b]);else c.callback([a,b]);return c}function W(a){a.baseMap="BingMapsAerial"===a.baseMap.baseMapLayers[0].type?
{title:"Imagery",baseMapLayers:[{id:"World_Imagery_2017",visibility:!0,opacity:1,url:"http://services.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer"}]}:"BingMapsRoad"===a.baseMap.baseMapLayers[0].type?{title:"Streets",baseMapLayers:[{id:"World_Street_Map_8421",opacity:1,visibility:!0,url:"http://services.arcgisonline.com/ArcGIS/rest/services/World_Street_Map/MapServer"}]}:{title:"Imagery with Labels",baseMapLayers:[{id:"World_Imagery_6611",opacity:1,visibility:!0,url:"http://services.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer"},
{id:"World_Boundaries_and_Places_1145",isReference:!0,opacity:1,visibility:!0,url:"http://services.arcgisonline.com/ArcGIS/rest/services/Reference/World_Boundaries_and_Places/MapServer"}]};return a}function la(a,b){var c=a.dynamicLayerInfos||a.layerInfos,d=b.layers;if(d&&c){var h=[],g=[],k=[],l=[],m=[],n=[];e.forEach(c,function(b){var c=b.id;if(!b.subLayerIds&&-1!==e.indexOf(a.visibleLayers,c))for(b=0;b<d.length;b++){var p=d[b];if(p.id===c){g.push(c);h.push(p.popupInfo);k.push(p.layerUrl||"");p.layerDefinition&&
p.layerDefinition.definitionExpression?l.push(p.layerDefinition.definitionExpression):l.push("");m.push(f.isDefined(p.minScale)?p.minScale:null);n.push(f.isDefined(p.maxScale)?p.maxScale:null);break}}});h.length&&(a.__popups=h,a.__popupIds=g,a.__popupUrls=k,a.__popupWhereClauses=l,a.__popupMinScales=m,a.__popupMaxScales=n,a.__resourceInfo=b.resourceInfo)}}function ma(a){if(!a)return!1;var b=(new n(A.arcgisUrl)).authority;return-1!==a.indexOf(".arcgis.com/")||-1!==a.indexOf(b)}function ua(a){return!a?
!1:-1!==a.indexOf("/services.arcgisonline.com/")||-1!==a.indexOf("/server.arcgisonline.com/")}function K(a){if("https:"===location.protocol&&(ma(a)||ua(a)))a=a.replace("http:","https:");return a}function na(a){var b=[];a.displayLevels||(b=e.map(a.resourceInfo.tileInfo.lods,function(a){return a.level}));b=new O(K(a.url),{resourceInfo:a.resourceInfo,opacity:a.opacity,visible:a.visibility,displayLevels:a.displayLevels||b,id:a.id,minScale:a.minScale,maxScale:a.maxScale,refreshInterval:a.refreshInterval});
la(b,a);return b}function oa(a,b){if(!a||!b||0===b.length)return[];var c=","+b+",",d=[],e,f=",";for(e=0;e<a.length;e++)if(null!==a[e].subLayerIds){if(-1===c.indexOf(","+a[e].id+",")||-1<f.indexOf(","+a[e].id+","))f+=a[e].subLayerIds.toString()+","}else-1<c.indexOf(","+a[e].id+",")&&-1===f.indexOf(","+a[e].id+",")&&d.push(a[e].id);return d}function va(a){var b=new S;b.format="png24";a.resourceInfo&&(a.resourceInfo.supportedImageFormatTypes&&-1<a.resourceInfo.supportedImageFormatTypes.indexOf("PNG32"))&&
(b.format="png32");var b=new P(K(a.url),{resourceInfo:a.resourceInfo,opacity:a.opacity,visible:a.visibility,id:a.id,imageParameters:b,minScale:a.minScale,maxScale:a.maxScale,refreshInterval:a.refreshInterval}),c=a.visibleLayers;if(!a.visibleLayers){var d="";e.forEach(b.layerInfos,function(a){a.defaultVisibility&&(d+=(0<d.length?",":"")+a.id)});c=d}if(a.layers&&0<a.layers.length){var f=[],h=[],g,k=[],l;e.forEach(a.layers,function(b){b.layerDefinition&&b.layerDefinition.definitionExpression&&(f[b.id]=
b.layerDefinition.definitionExpression);if(b.layerDefinition&&b.layerDefinition.source){g=new M(m.mixin(b,b.layerDefinition));delete g.layerDefinition;g.id=b.id;if(a.visibleLayers){var c="string"==typeof a.visibleLayers?a.visibleLayers.split(","):a.visibleLayers;-1<e.indexOf(c,b.id)?g.defaultVisibility=!0:g.defaultVisibility=!1}h.push(g)}b.layerDefinition&&(b.layerDefinition.source&&b.layerDefinition.drawingInfo)&&(l=new ga(b.layerDefinition.drawingInfo),k[b.id]=l)},this);0<f.length&&b.setLayerDefinitions(f);
0<h.length?(b.setDynamicLayerInfos(h,!0),0<k.length&&b.setLayerDrawingOptions(k,!0)):(c=oa(b.layerInfos,c),b.setVisibleLayers(c))}else c=oa(b.layerInfos,c),b.setVisibleLayers(c);la(b,a);return b}function Ma(a,b){var c=new ha;c.bandIds=a.bandIds;null!=a.format&&(c.format=a.format,null!=a.compressionQuality&&(c.compressionQuality=a.compressionQuality));if(a.renderingRule&&a.renderingRule.rasterFunction){var d=new ia(a.renderingRule);c.renderingRule=d}a.mosaicRule&&(d=new ja(a.mosaicRule),c.mosaicRule=
d);f.isDefined(a.noData)&&(c.noData=a.noData);f.isDefined(a.noDataInterpretation)&&(c.noDataInterpretation=a.noDataInterpretation);f.isDefined(a.interpolation)&&(c.interpolation=a.interpolation);c=new x(K(a.url),{resourceInfo:a.resourceInfo,opacity:a.opacity,visible:a.visibility,id:a.id,imageServiceParameters:c,infoTemplate:a.popupInfo&&new b(a.popupInfo),minScale:a.minScale,maxScale:a.maxScale,refreshInterval:a.refreshInterval});a.layerDefinition&&a.layerDefinition.definitionExpression&&c.setDefinitionExpression(a.layerDefinition.definitionExpression,
!0);return c}function qa(b,c,d){var h=[102113,102100,3857],g=d||new a(c[0].layerObject.fullExtent.spatialReference),k=new a(b.resourceInfo.fullExtent.spatialReference);return g.wkt==k.wkt&&(g.wkid==k.wkid||f.isDefined(g.latestWkid)&&g.latestWkid==k.wkid||f.isDefined(k.latestWkid)&&g.wkid==k.latestWkid||f.isDefined(g.latestWkid)&&g.latestWkid==k.latestWkid)||g.wkid&&k.wkid&&e.some(h,function(a){return a===k.wkid})&&e.some(h,function(a){return a===g.wkid})?!0:!1}function Q(a,b){if(!b[0].layerObject.tileInfo)return!1;
var c=[];e.forEach(b,function(a){a.baseMapLayer&&a.layerObject.tileInfo&&(c=c.concat(e.map(a.layerObject.tileInfo.lods,function(a){return a.scale})))});return e.some(a.resourceInfo.tileInfo.lods,function(a){return e.some(c,function(b){return b===a.scale})})}function N(b,c,d,g,k){var l,n=d._clazz;if("OpenStreetMap"===b.type)l=new R({id:b.id,opacity:b.opacity,visible:null!==b.visibility&&void 0!==b.visibility?b.visibility:!0});else if("WMS"===b.type){var p=[],r=[];e.forEach(b.layers,function(a){r.push(new ka({name:a.name,
title:a.title,legendURL:a.legendURL}));p.push(a.name)},this);b.visibleLayers&&(p=b.visibleLayers);g={extent:new t(b.extent[0][0],b.extent[0][1],b.extent[1][0],b.extent[1][1],new a({wkid:4326})),layerInfos:r,version:b.version,maxWidth:b.maxWidth,maxHeight:b.maxHeight,getMapURL:b.mapUrl,spatialReferences:b.spatialReferences,title:b.title,copyright:b.copyright,minScale:b.minScale||0,maxScale:b.maxScale||0};l=new ca(b.url,{id:b.id,visibleLayers:p,format:"png",transparent:b.baseMapLayer?!1:!0,opacity:b.opacity,
visible:null!==b.visibility?b.visibility:!0,resourceInfo:g,refreshInterval:b.refreshInterval});l.spatialReference.wkid=g.spatialReferences[0]}else if("KML"===b.type){d=b.url;if(h.id&&(n=h.id.findCredential(u.urlToObject(A.arcgisUrl).path))){c=A.arcgisUrl.substring(A.arcgisUrl.indexOf("//")+2,A.arcgisUrl.indexOf("/",A.arcgisUrl.indexOf("//")+3));k=c.split(".");k=k[k.length-2]+"."+k[k.length-1];var Aa=d.indexOf(k);-1<Aa&&(d="https://"+c+d.substring(Aa+k.length));d+="?token\x3d"+n.token}l=new da(d,{id:b.id,
visible:null!==b.visibility?b.visibility:!0,outSR:g,refreshInterval:b.refreshInterval});q.connect(l,"onLoad",function(){(b.opacity||0===b.opacity)&&l.setOpacity(b.opacity);b.visibleFolders&&e.forEach(l.folders,function(a){-1<e.indexOf(b.visibleFolders,a.id)?l.setFolderVisibility(a,!0):l.setFolderVisibility(a,!1)},this)})}else"WebTiledLayer"===b.type?(l=new ba(b.templateUrl,{id:b.id,visible:null!==b.visibility?b.visibility:!0,opacity:b.opacity,copyright:b.copyright,fullExtent:b.fullExtent&&new t(b.fullExtent),
initialExtent:b.fullExtent&&new t(b.fullExtent),subDomains:b.subDomains,tileInfo:b.tileInfo?new fa(b.tileInfo):null,refreshInterval:b.refreshInterval}),q.connect(l,"onLoad",function(){(f.isDefined(b.minScale)||f.isDefined(b.maxScale))&&l.setScaleRange(b.minScale,b.maxScale)})):"GeoRSS"===b.type?(l=new ea(b.url,{id:b.id,opacity:b.opacity,outSpatialReference:g,refreshInterval:b.refreshInterval}),q.connect(l,"onLoad",function(){!1===b.visibility&&l.hide();var a=l.getFeatureLayers();e.forEach(a,function(a){b.pointSymbol&&
"esriGeometryPoint"===a.geometryType?a.renderer.symbol=F.fromJson(b.pointSymbol):b.lineSymbol&&"esriGeometryPolyline"===a.geometryType?a.renderer.symbol=F.fromJson(b.lineSymbol):b.polygonSymbol&&"esriGeometryPolygon"===a.geometryType&&(a.renderer.symbol=F.fromJson(b.polygonSymbol));(f.isDefined(b.minScale)||f.isDefined(b.maxScale))&&a.setScaleRange(b.minScale,b.maxScale)})})):"CSV"==b.type&&b.url?(g={layerDefinition:b.layerDefinition,columnDelimiter:b.columnDelimiter,infoTemplate:new D(b.popupInfo?
b.popupInfo:T.generateDefaultPopupInfo(b)),id:b.id?b.id:null,visible:null!==b.visibility?b.visibility:!0,opacity:b.opacity,refreshInterval:b.refreshInterval},b.locationInfo&&(g.latitudeFieldName=b.locationInfo.latitudeFieldName,g.longitudeFieldName=b.locationInfo.longitudeFieldName),l=new U(b.url,g)):b.layerDefinition&&!b.url?(g=s.fromJson(s.toJson(b)),delete g.id,delete g.opacity,delete g.visibility,l=new E(g,{id:b.id,opacity:b.opacity,visible:b.visibility,outFields:["*"],infoTemplate:g.popupInfo&&
new n(g.popupInfo),autoGeneralize:!0})):"BingMapsAerial"===b.type||"BingMapsRoad"===b.type||"BingMapsHybrid"===b.type?d.bingMapsKey?(g=G.MAP_STYLE_AERIAL_WITH_LABELS,"BingMapsAerial"===b.type?g=G.MAP_STYLE_AERIAL:"BingMapsRoad"===b.type&&(g=G.MAP_STYLE_ROAD),l=new G({bingMapsKey:d.bingMapsKey,mapStyle:g,opacity:b.opacity,id:b.id}),q.connect(l,"onError",m.hitch(this,function(a){a.errors=a.errors||[];a.errors.push({message:"This application does not have a valid Bing Key for the Bing layer that is included in this map. [type:"+
a.type+"]"})},b))):(b.errors=b.errors||[],b.errors.push({message:"This application does not provide a Bing Key for the Bing layer that is included in this map. [type:"+b.type+"]"})):b.resourceInfo&&b.resourceInfo.mapName?l=!0===b.resourceInfo.singleFusedMapCache&&(b.baseMapLayer||qa(b,c,g)&&Q(b,k))?na(b):va(b):b.resourceInfo&&b.resourceInfo.pixelSizeX?l=!0===b.resourceInfo.singleFusedMapCache&&(b.baseMapLayer||qa(b,c,g)&&Q(b,k))?na(b):Ma(b,n):b.resourceInfo&&"Feature Layer"===b.resourceInfo.type&&
(b.capabilities&&(b.resourceInfo.capabilities=b.capabilities),l=new E(K(b.url),{resourceInfo:b.resourceInfo,opacity:b.opacity,visible:b.visibility,id:b.id,mode:ma(b.url)?E.MODE_AUTO:f.isDefined(b.mode)?b.mode:E.MODE_ONDEMAND,outFields:["*"],infoTemplate:b.popupInfo&&new n(b.popupInfo),autoGeneralize:!0,refreshInterval:b.refreshInterval}),b.layerDefinition&&(b.layerDefinition.drawingInfo&&b.layerDefinition.drawingInfo.renderer&&(g=B.fromJson(b.layerDefinition.drawingInfo.renderer),g.isMaxInclusive=
!0,l.setRenderer(g)),b.layerDefinition.definitionExpression&&l.setDefinitionExpression(b.layerDefinition.definitionExpression),f.isDefined(b.layerDefinition.minScale)&&l.setMinScale(b.layerDefinition.minScale),f.isDefined(b.layerDefinition.maxScale)&&l.setMaxScale(b.layerDefinition.maxScale)));l&&(l.arcgisProps={title:b.title},b.baseMapLayer&&(l._basemapGalleryLayerType=b.isReference?"reference":"basemap"));return l}function pa(a,b,c,d){e.forEach(a,function(e,f){if(e.url&&!e.type){if(0===f||a[0].layerObject)e.layerObject=
N(e,a,b,c,d)}else e.layerObject=N(e,a,b,c,d)});var f=e.filter(a,function(a){return!a.isReference}),g=e.filter(a,function(a){return!!a.isReference});return a=f.concat(g)}function ra(b){var c=null;b=b[0];b.url&&!b.type?b.resourceInfo.spatialReference&&(c=new a,b.resourceInfo.spatialReference.wkid&&(c.wkid=b.resourceInfo.spatialReference.wkid),b.resourceInfo.spatialReference.wkt&&(c.wkt=b.resourceInfo.spatialReference.wkt)):-1<b.type.indexOf("BingMaps")||"OpenStreetMap"==b.type?c=new a({wkid:102100}):
"WMS"==b.type&&(c=new a({wkid:b.spatialReferences[0]}));return c}function wa(a,b,c,d,f,g,h){e.forEach(b,function(b,c){b.url&&!b.type&&(b.resourceInfo=a[b.deferredsPos][1],delete b.deferredsPos)});g=g||ra(b);b=pa(b,c,g,h);f.callback(b);return f}function xa(a,c){var e=K(a);return b({url:e,content:{f:"json"},callbackParamName:"callback",error:function(a,b){a.message=a.message?a.message+(" [url:"+e+"]"):"[url:"+e+"]";c.push(a);d.defaults.io.errorHandler(a,b)}})}function ya(a){var c=A.arcgisUrl+"/"+a.itemId+
"/data";return b({url:c,content:{f:"json"},callbackParamName:"callback",error:function(b,e){b.message=b.message?b.message+(" [url:"+c+"]"):"[url:"+c+"]";a.errors=a.errors||[];a.errors.push(b);d.defaults.io.errorHandler(b,e)}})}function za(a,b,c){var d=new l;if((!c.featureCollection||!c.featureCollection.layers)&&!c.layers)return console.log("Invalid Feature Collection item data [item id: "+a.itemId+"]: ",c),a.errors=a.errors||[],a.errors.push({message:"Invalid Feature Collection item data. [item id: "+
a.itemId+"]"}),d.errback(),d;c.layers&&(c.featureCollection={layers:c.layers},delete c.layers,f.isDefined(c.showLegend)&&(c.featureCollection.showLegend=c.showLegend,delete c.showLegend));Ba(a,c.featureCollection,b).then(function(b){c.featureCollection=b;a.featureCollection&&a.featureCollection.layers?e.forEach(c.featureCollection.layers,function(b,c){var d=a.featureCollection.layers[c];if(!d.poupInfo&&!d.layerDefinition)d.popupInfo=b.popupInfo,d.layerDefinition=b.layerDefinition;else if(d.layerDefinition){if(f.isDefined(d.layerDefinition.minScale)&&
f.isDefined(d.layerDefinition.maxScale)&&(d.layerDefinition.minScale!==b.layerDefinition.minScale||d.layerDefinition.maxScale!==b.layerDefinition.maxScale))delete b.layerDefinition.minscale,delete b.layerDefinition.maxScale;d.layerDefinition.drawingInfo&&s.toJson(d.layerDefinition.drawingInfo)!==s.toJson(b.layerDefinition.drawingInfo)&&delete b.layerDefinition.drawingInfo;d.layerDefinition.showLegend!==b.layerDefinition.showLegend&&delete b.layerDefinition.showLegend;d.layerDefinition=m.mixin(d.layerDefinition,
b.layerDefinition)}else d.layerDefinition=b.layerDefinition;d.featureSet=b.featureSet;d.nextObjectId=b.nextObjectId}):(a.featureCollection=a.featureCollection||{},a.featureCollection=m.mixin(a.featureCollection,c.featureCollection));d.callback(a)});return d}function Ba(a,b,c){var d=new l,g=[];e.forEach(b.layers,function(a){a.featureSet&&(a.featureSet.features&&a.featureSet.features.length&&a.featureSet.features[0].geometry&&a.featureSet.features[0].geometry.spatialReference)&&(a.deferredsPos=g.length,
g.push(T.projectFeatureCollection(a,c,a.featureSet.features[0].geometry.spatialReference)))});(new k(g)).addCallback(function(){e.forEach(b.layers,function(b){f.isDefined(b.deferredsPos)&&(g[b.deferredsPos].results&&g[b.deferredsPos].results.length?b=g[b.deferredsPos].results[0]:(console.log("Errors projecting feature collection. ["+a.title+" - "+b.layerDefinition.name+"]"),b.errors=b.errors||[],b.errors.push({message:"Errors projecting feature collection. ["+a.title+" - "+b.layerDefinition.name+
"]"})),delete b.deferredsPos)});d.callback(b)});return d}function X(a,b,c,d){var f=new l,g=new l,h=[],n;e.forEach(a.operationalLayers,function(a,b){a.itemId&&"Feature Collection"==a.type&&h.push(ya(a).then(m.hitch(null,za,a,c)))});0===h.length?Ca(a,b,c,d,g):(n=new k(h),n.addCallback(function(e){Ca(a,b,c,d,g)}));g.then(function(a){h=[];e.forEach(a,function(a){a=a.layerObject;if(a instanceof E&&!a.loaded&&!a.loadError){var b=new l;r.once(a,"load, error",function(){b.callback(a)});h.push(b)}});0===h.length?
f.callback(a):(n=new k(h),n.addCallback(function(){f.callback(a)}))});return f}function Ca(a,b,c,d,f){var g=[],h=[],l=[];e.forEach(a.operationalLayers,function(a,b){a.featureCollection?e.forEach(a.featureCollection.layers,function(c,d){var f=!0;a.visibleLayers&&-1==e.indexOf(a.visibleLayers,d)&&(f=!1);c.visibility=a.visibility&&f;c.opacity=a.opacity;c.id=(a.id||"operational"+b)+"_"+d;l.push(c)},this):l.push(a)});e.forEach(a.baseMap.baseMapLayers,function(a,b){a.baseMapLayer=!0;a.id=a.id||"base"+b;
g.push(a)});e.forEach(l,function(a,b){a.id=a.id||"operational"+b;g.push(a)});e.forEach(g,function(a){a.url&&!a.type&&(a.deferredsPos=h.length,a.errors=a.errors||[],h.push(xa(a.url,a.errors)))});0===h.length?(c=c||ra(g),g=pa(g,b,c,d),f.callback(g)):(new k(h)).addCallback(function(a){wa(a,g,b,h,f,c,d)});return f}function Y(a,b,c,d){var f=a.minScale,g=a.maxScale;if(10.1>=c.version&&b)for(a=b.length-1;0<=a;a--){if(b[a].id==d)if(0==f&&0<b[a].minScale?f=b[a].minScale:0<f&&0==b[a].minScale?f=c.minScale:
0<f&&0<b[a].minScale&&(f=Math.min(f,b[a].minScale)),g=Math.max(c.maxScale||0,b[a].maxScale||0),c.setScaleRange(f,g),-1<b[a].parentLayerId)d=b[a].parentLayerId;else break}else 10.1<c.version&&(e.forEach(a.layerInfos,function(a){a.id==d&&(0==f&&0<a.minScale?f=a.minScale:0<f&&0==a.minScale||0<f&&0<a.minScale&&(f=Math.min(f,a.minScale)),g=Math.max(g||0,a.maxScale||0))}),c.setScaleRange(f,g))}function Z(a,b,c,d){var g=a.url,h=a.__popupIds,k=a.__popupUrls,l=a.__popupWhereClauses,n=a.__popupMinScales,p=
a.__popupMaxScales,s=a.__resourceInfo,r=[];e.forEach(a.__popups,function(d,m){if(d){var C,t=[];e.forEach(d.fieldInfos,function(a){"shape"!==a.fieldName.toLowerCase()&&t.push(a.fieldName)});if(a.dynamicLayerInfos&&0<a.dynamicLayerInfos.length){var u=e.filter(a.dynamicLayerInfos,function(a){return h[m]==a.id})[0].source;C=new E(g+"/dynamicLayer",{id:a.id+"_"+h[m],source:u,outFields:t,mode:E.MODE_SELECTION,infoTemplate:d&&new c(d),drawMode:!1,visible:a.visible,autoGeneralize:!0});var v=function(c,d){0<
l[c].length&&d.setDefinitionExpression(l[c]);if(!f.isDefined(n[c])&&!f.isDefined(p[c]))Y(a,b||s.layers,d,h[c]);else if(f.isDefined(a.minScale)||f.isDefined(a.maxScale)){var e=a.minScale,g=a.maxScale;0==e&&0<n[c]?e=n[c]:0<e&&0==n[c]||0<e&&0<n[c]&&(e=Math.min(e,n[c]));g=Math.max(g||0,p[c]||0);d.setScaleRange(e,g)}else d.setScaleRange(n[c],p[c])};C.loaded?v(m,C):q.connect(C,"onLoad",function(a){v(m,C)})}else{var w=null,x=g+"/"+h[m];if(k[m].length)x=k[m];else if(b)for(u=0;u<b.length;u++)if(b[u].id===
h[m]){w=b[u];break}C=new E(K(x),{id:a.id+"_"+h[m],outFields:t,mode:E.MODE_SELECTION,infoTemplate:d&&new c(d),drawMode:!1,visible:a.visible,resourceInfo:w,autoGeneralize:!0});C.loaded?(0<l[m].length&&C.setDefinitionExpression(l[m]),Y(a,b||s.layers,C,h[m])):q.connect(C,"onLoad",function(c){0<l[m].length&&C.setDefinitionExpression(l[m]);Y(a,b||s.layers,c,h[m])})}r.push(C)}});0<r.length&&(q.connect(a,"onVisibilityChange",m.hitch(this,function(a,b){e.forEach(a,function(a){b?a.show():a.hide()})},r)),q.connect(d,
"onLayerRemove",m.hitch(this,function(a,b,c){a.id===c.id&&e.forEach(b,function(a){d.removeLayer(a)})},a,r)));delete a.__popups;delete a.__popupIds;delete a.__popupUrls;delete a.__popupWhereClauses;delete a.__popupMinScales;delete a.__popupMaxScales;delete a.__resourceInfo;return r}function Da(a){return b({url:K(a.url+"/layers"),content:{f:"json"},callbackParamName:"callback",error:function(){}})}function Ea(a,b,c){var d=[];e.forEach(a,function(a){var b=a.__popups;b&&(1<b.length&&10<=a.version)&&(a.__deferredsPos=
d.length,d.push(Da(a)))});var f=[];0<d.length?(new k(d)).addCallback(function(d){e.forEach(a,function(a){a.__popups&&0<a.__popups.length&&(a.__deferredsPos||0===a.__deferredsPos?(f=f.concat(Z(a,d[a.__deferredsPos][1].layers,c,b)),delete a.__deferredsPos):f=f.concat(Z(a,null,c,b)))});b.addLayers(f)}):(e.forEach(a,function(a){a.__popups&&0<a.__popups.length&&(f=f.concat(Z(a,null,c,b)))}),b.addLayers(f))}function Fa(a){e.forEach(a,function(a){var b=a.layer;b.toJson&&(a=b.toJson(),a.featureSet&&-1<b.name.indexOf("Text")&&
e.forEach(a.featureSet.features,function(a,c){if(a.attributes.TEXT){var d=b.graphics[c];d.symbol.setText(a.attributes.TEXT);a.symbol.horizontalAlignment&&(d.symbol.align=a.symbol.horizontalAlignment);d.setSymbol(d.symbol);d.setAttributes(a.attributes)}},this))})}function Ga(a){var b=6;e.forEach(a,function(a){if(a=a.renderer)"esri.renderer.SimpleRenderer"===a.declaredClass?((a=a.symbol)&&a.xoffset&&(b=Math.max(b,Math.abs(a.xoffset))),a&&a.yoffset&&(b=Math.max(b,Math.abs(a.yoffset)))):("esri.renderer.UniqueValueRenderer"===
a.declaredClass||"esri.renderer.ClassBreaksRenderer"===a.declaredClass)&&e.forEach(a.infos,function(a){(a=a.symbol)&&a.xoffset&&(b=Math.max(b,Math.abs(a.xoffset)));a&&a.yoffset&&(b=Math.max(b,Math.abs(a.yoffset)))})});return b}function $(a){var b=this,c=b.infoWindow,d=a.graphic;if(b.loaded){c.hide();c.clearFeatures();var f=[];e.forEach(b.graphicsLayerIds,function(a){if((a=b.getLayer(a))&&-1!==a.declaredClass.indexOf("FeatureLayer")&&a.loaded&&a.visible)a.clearSelection(),a.infoTemplate&&!a.suspended&&
f.push(a)});e.forEach(b.layerIds,function(a){(a=b.getLayer(a))&&(-1!==a.declaredClass.indexOf("ArcGISImageServiceLayer")&&a.loaded&&a.visible&&a.infoTemplate)&&f.push(a)});d=d&&d.getInfoTemplate()?d:null;if(f.length||d){var g=Ga(f),h=a.screenPoint,k=b.toMap(new v(h.x-g,h.y+g)),g=b.toMap(new v(h.x+g,h.y-g)),k=new t(k.x,k.y,g.x,g.y,b.spatialReference),m=new w;m.geometry=k;m.timeExtent=b.timeExtent;var n=!0,k=e.map(f,function(a){var b;-1!==a.declaredClass.indexOf("ArcGISImageServiceLayer")?(n=!1,b=a.queryVisibleRasters(m,
{rasterAttributeTableFieldPrefix:"Raster.",returnDomainValues:!0}),b.addCallback(function(){return a.getVisibleRasters()})):(b=a.selectFeatures(m),b.addCallback(function(){return a.getSelectedFeatures()}));return b});d&&(g=new l,g.callback([d]),k.splice(0,0,g));if(!e.some(k,function(a){return-1===a.fired})){var p=d?1:0;e.forEach(f,function(a){p=-1!==a.declaredClass.indexOf("ArcGISImageServiceLayer")?p+a.getVisibleRasters().length:p+a.getSelectedFeatures().length});if(!p)return}c.setFeatures(k);c.show(a.mapPoint,
{closestFirst:n})}}}function Na(a,b){var d=b.mapOptions||{},e;d.infoWindow||(e=new I({visibleWhenEmpty:!1},g.create("div")),d.infoWindow=e);f.isDefined(d.showInfoWindowOnClick)||(d.showInfoWindowOnClick=!1);d=new c(a,d);q.connect(d,"onLayersAddResult",Fa);return d}function L(a,b,c,d,f,g){var h,k,l;d.map?(h=d.map,k=d.clickEventHandle,l=d.errors):(h=Na(d,f),!f.ignorePopups&&!f.disableClickBehavior&&(k=q.connect(h,"onClick",$)));f.ignorePopups&&e.forEach(a,function(a){delete a.infoTemplate});h.addLayers(a);
f.ignorePopups||Ea(a,h,f._clazz);var m=l||[];e.forEach(b,function(a){a.errors&&(m=m.concat(a.errors))},this);h.loaded?g.callback({map:h,itemInfo:c,errors:m,clickEventHandle:k,clickEventListener:$}):q.connect(h,"onLoad",function(){g.callback({map:h,itemInfo:c,errors:m,clickEventHandle:k,clickEventListener:$})})}function aa(a,b,c,d,f){var g=[];e.forEach(f,function(a){m.isArray(a.layerObject)?e.forEach(a.layerObject,function(a){g.push(a)}):g.push(a.layerObject)});if("BingMapsAerial"===f[0].type||"BingMapsRoad"===
f[0].type||"BingMapsHybrid"===f[0].type)var h=setInterval(function(){if(f[0].layerObject&&f[0].layerObject.loaded)clearInterval(h),Ha(a,b,c,d,f,g);else if(f[0].errors){clearInterval(h);var e="";f[0].errors&&f[0].errors.length&&(e=" ("+f[0].errors[0].message+")");d.errback(Error(y.arcgis.utils.baseLayerError+e))}},10);else if(!g[0]&&f[0].baseMapLayer){var k="";f[0].errors&&f[0].errors.length&&(k=" ("+f[0].errors[0].message+")");d.errback(Error(y.arcgis.utils.baseLayerError+k))}else Ha(a,b,c,d,f,g)}
function Ha(b,c,g,h,k,l){try{var m=g.mapOptions||{};g.mapOptions=m;var n=b.item;l=e.filter(l,f.isDefined);if(n)if(n.extent&&n.extent.length)if(m.extent)L(l,k,b,c,g,h);else{var p=new t(n.extent[0][0],n.extent[0][1],n.extent[1][0],n.extent[1][1],new a({wkid:4326})),q=l[0].spatialReference;4326===q.wkid?(m.extent=p,L(l,k,b,c,g,h)):102100===q.wkid||102113===q.wkid||3857===q.wkid?(p.xmin=Math.max(p.xmin,-180),p.xmax=Math.min(p.xmax,180),p.ymin=Math.max(p.ymin,-89.99),p.ymax=Math.min(p.ymax,89.99),m.extent=
z.geographicToWebMercator(p),L(l,k,b,c,g,h)):g.geometryServiceURL||d.defaults.geometryService?(g.geometryServiceURL?new J(g.geometryServiceURL):d.defaults.geometryService).project([p],q,function(a){a=a[0];m.extent=m.extent||a;L(l,k,b,c,g,h)},function(){L(l,k,b,c,g,h)}):h.errback(Error(y.arcgis.utils.geometryServiceError))}else L(l,k,b,c,g,h);else L(l,k,b,c,g,h)}catch(r){h.errback(r)}}function Ia(a){var b=[];a=a.baseMap.baseMapLayers.concat(a.operationalLayers);e.forEach(a,function(a,c){var d={};if(a.featureCollection&&
"CSV"!==a.type)!0===a.featureCollection.showLegend&&e.forEach(a.featureCollection.layers,function(c){!1!==c.showLegend&&(d={layer:c.layerObject,title:a.title,defaultSymbol:c.renderer&&c.renderer.defaultSymbol&&c.renderer.defaultLabel?!0:!1},1<a.featureCollection.layers.length&&(d.title+=" - "+c.layerDefinition.name),b.push(d))});else if(a.baseMapLayer&&!0===a.showLegend&&a.layerObject||!a.baseMapLayer&&!1!==a.showLegend&&a.layerObject){var f=a.layerObject.renderer,f=!f||f&&f.defaultSymbol&&f.defaultLabel?
!0:!1;if(10.1>a.layerObject.version&&(a.layerObject instanceof P||a.layerObject instanceof O)||a.layerObject instanceof x)f=!0;d={layer:a.layerObject,title:a.title,defaultSymbol:f};a.layers&&(f=e.map(e.filter(a.layers,function(a){return!1===a.showLegend}),function(a){return a.id}),f.length&&(d.hideLayers=f));b.push(d)}});return b}function Ja(a,b,c,d){La(d,b).then(function(b){var d=b[0],f=b[1];if(!d.itemData.operationalLayers||0===d.itemData.operationalLayers.length)V(d,f).addCallback(function(b){X(b.itemData,
f).addCallback(m.hitch(null,aa,b,a,f,c))});else{var g=new l,h=d.itemData.baseMap.baseMapLayers.slice(0),k=e.filter(d.itemData.baseMap.baseMapLayers,function(a){return!a.isReference});b={item:d.item,itemData:{baseMap:{baseMapLayers:k}}};d.itemData.baseMap.baseMapLayers=e.filter(d.itemData.baseMap.baseMapLayers,function(a){return a.isReference});V(b,f).addCallback(function(b){X(b.itemData,f).addCallback(m.hitch(null,aa,b,a,f,g))});g.then(function(a){V(d,f).addCallback(function(b){X(b.itemData,f,a.map.spatialReference,
k).addCallback(function(d){b.itemData.baseMap.baseMapLayers=h;aa(b,a,f,c,d)})})},m.hitch(c,c.errback))}})}function Ka(a){A._arcgisUrl&&0<A._arcgisUrl.length&&(A.arcgisUrl=A._arcgisUrl);var c=A.arcgisUrl+"/"+a,d={},e=new l;b({url:c,content:{f:"json"},callbackParamName:"callback",load:function(a){d.item=a;b({url:c+"/data",content:{f:"json"},callbackParamName:"callback",load:function(a){d.itemData=a;e.callback(d)},error:function(a){e.errback(a)}})},error:function(a){e.errback(a)}});return e}String.prototype.endsWith=
function(a){return this.match(a+"$")==a};var A;A={arcgisUrl:location.protocol+"//www.arcgis.com/sharing/rest/content/items",getItem:Ka,createMap:function(a,b,c){var d=new l;c=c||{};var e=c.infoTemplateClass;c._clazz=e&&(m.isObject(e)?e:m.getObject(e))||D;m.isString(a)?Ka(a).addCallback(m.hitch(null,Ja,b,c,d)).addErrback(m.hitch(d,d.errback)):Ja(b,c,d,a);return d},getLegendLayers:function(a){return a&&a.itemInfo&&a.itemInfo.itemData?Ia(a.itemInfo.itemData):[]},_arcgisUrl:null,_getItemProps:V,_getItemData:H,
_getBingKey:sa,_processFSItemProperties:ta,_getLayers:X,_preBuildLayerObjects:wa,_buildLayerObjects:pa,_preCreateMap:aa,_getMapSR:ra,_createMap:L,_addSelectionLayers:Ea,_createSelectionFeatureLayers:Z,_getServiceInfo:xa,_getFeatureCollectionItem:ya,_mergeFeatureCollectionItem:za,_projectFeatureCollection:Ba,_getLayersInfo:Da,_initLayer:N,_loadAsCached:na,_loadAsDynamic:va,_processPopups:la,_onLayersAddResult:Fa,_sameSpatialReferenceAsBasemap:qa,_sameTilingSchemeAsBasemap:Q,_showPopup:$,_calculateClickTolerance:Ga,
_getVisibleFeatureLayers:oa,_updateLayerScaleInfo:Y,_checkUrl:K,_isHostedService:ma,_isAgolService:ua,_getLegendLayers:Ia};m.setObject("arcgis.utils",A,h);return A});